{%- comment -%}
汎用インデックスカード（stats.json 構造差異に強い版）
対応:
- Astra4, R-BANK9 は pct_intraday（%）をそのまま採用
- AIN-10, S-COIN+ は delta_level + scale（percent/ratio）に対応
フォールバック:
- pct_intraday が無ければ delta_level を使う
- scale が ratio なら 100倍, percent ならそのまま
表示:
- + / - を付与し、小数2桁
- 画像は最大高さでトリミングせずに収まる
{%- endcomment -%}

{%- assign id = include.id -%}
{%- assign title = include.title -%}
{%- assign badge = include.badge -%}
{%- assign desc = include.description -%}
{%- assign flag = include.flag | default: "" -%}
{%- assign json_path = include.json_path -%}
{%- assign intraday_png = include.intraday_png -%}
{%- assign am_png = include.am_png -%}

<div class="card index-card">
  <div class="card-ttl">
    <div class="card-ttl__left">
      {% if flag != "" %}
        <span class="flag">{{ flag }}</span>
      {% endif %}
      <span class="name">{{ title }}</span>
      {% if badge %}
        <span class="badge">{{ badge }}</span>
      {% endif %}
    </div>

    {%- comment -%} stats.json を読み込み {%- endcomment -%}
    {%- capture _raw -%}{% include_relative ..{{ json_path }} %}{%- endcapture -%}

    {%- assign pct = '' -%}
    {%- assign delta = '' -%}
    {%- assign scale = '' -%}

    {%- if _raw contains '"pct_intraday"' -%}
      {%- assign tmp = _raw | split:'"pct_intraday":' | last -%}
      {%- assign pct = tmp | split:',' | first | strip -%}
    {%- endif -%}

    {%- if _raw contains '"delta_level"' -%}
      {%- assign tmp = _raw | split:'"delta_level":' | last -%}
      {%- assign delta = tmp | split:',' | first | strip -%}
    {%- endif -%}

    {%- if _raw contains '"scale":' -%}
      {%- assign tmp = _raw | split:'"scale":' | last -%}
      {%- assign scale = tmp | split:',' | first | strip | replace:'"','' -%}
    {%- endif -%}

    {%- comment -%} 数値決定ロジック {%- endcomment -%}
    {%- assign pct_num = 0 -%}
    {%- if pct != '' and pct != 'null' -%}
      {%- assign pct_num = pct | plus: 0 -%}
    {%- elsif delta != '' and delta != 'null' -%}
      {%- assign d = delta | plus: 0 -%}
      {%- if scale == 'ratio' -%}
        {%- assign pct_num = d | times: 100 -%}
      {%- else -%}
        {%- comment -%} percent / 未指定 は「%値」が来る前提 {%- endcomment -%}
        {%- assign pct_num = d -%}
      {%- endif -%}
    {%- endif -%}

    {%- assign cls = '' -%}
    {%- if pct_num > 0 -%}
      {%- assign cls = 'up' -%}
    {%- elsif pct_num < 0 -%}
      {%- assign cls = 'down' -%}
    {%- endif -%}
    <div class="right">
      <span class="delta {{ cls }}">
        {%- if pct_num > 0 -%}+{%- endif -%}{{ pct_num | round: 2 }}%
      </span>
    </div>
  </div>

  <div class="desc">{{ desc }}</div>

  <div class="chart">
    <img
      src="{{ intraday_png }}"
      alt="{{ id }} chart"
      loading="lazy"
      width="960" height="260"
    >
  </div>

  <div class="toolbar">
    <button class="btn active">Intraday</button>
    <button class="btn">前場(AM)</button>
    <button class="btn" disabled>7日</button>
    <button class="btn" disabled>1ヶ月</button>
    <button class="btn" disabled>1年</button>
  </div>
</div>

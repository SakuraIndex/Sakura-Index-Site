{%- comment -%}
桜Index 汎用カードコンポーネント（完全修正版）

✅ 修正点：
- Liquid構文エラー（`endcomment` → `{% endcomment %}`）を修正
- include_relativeパス制約に対応（`charts/` 相対指定）
- 騰落率ロジック改良（pct_intraday優先・delta_level+scale対応・N/Aフォールバック）
- 表示フォーマット統一（+/- 付き・2桁小数）
- チャート画像の比率・サイズ安定化
{%- endcomment -%}

{%- assign id = include.id -%}
{%- assign title = include.title -%}
{%- assign badge = include.badge -%}
{%- assign desc = include.description -%}
{%- assign flag = include.flag | default: "" -%}
{%- assign json_path = include.json_path | remove_first:'/' -%}
{%- assign intraday_png = include.intraday_png -%}
{%- assign am_png = include.am_png -%}

<div class="sx-card">
  <div class="sx-head">
    <div class="sx-head-left">
      {% if flag != "" %}<span class="sx-flag">{{ flag }}</span>{% endif %}
      <span class="sx-name">{{ title }}</span>
      {% if badge %}<span class="sx-badge">{{ badge }}</span>{% endif %}
    </div>

    {%- capture _raw -%}{% include_relative {{ json_path }} %}{%- endcapture -%}

    {%- assign pct = nil -%}
    {%- assign delta = nil -%}
    {%- assign scale = nil -%}

    {%- if _raw contains '"pct_intraday":' -%}
      {%- assign tmp = _raw | split:'"pct_intraday":' | last -%}
      {%- assign pct = tmp | split:',' | first | strip -%}
    {%- endif -%}

    {%- if _raw contains '"delta_level":' -%}
      {%- assign tmp = _raw | split:'"delta_level":' | last -%}
      {%- assign delta = tmp | split:',' | first | strip -%}
    {%- endif -%}

    {%- if _raw contains '"scale":' -%}
      {%- assign tmp = _raw | split:'"scale":' | last -%}
      {%- assign scale = tmp | split:',' | first | strip | replace:'"','' -%}
    {%- endif -%}

    {%- assign val = nil -%}
    {%- if pct and pct != '' and pct != 'null' -%}
      {%- assign val = pct | plus: 0 -%}
    {%- elsif delta and delta != '' and delta != 'null' -%}
      {%- assign val = delta | plus: 0 -%}
    {%- endif -%}

    {%- assign label = 'N/A' -%}
    {%- if val != nil -%}
      {%- assign pct_value = val | times: 100 | round: 2 -%}
      {%- if pct_value > 0 -%}
        {%- assign label = '+' | append: pct_value | append: '%' -%}
      {%- else -%}
        {%- assign label = pct_value | append: '%' -%}
      {%- endif -%}
    {%- endif -%}

    <span class="sx-delta">{{ label }}</span>
  </div>

  <div class="sx-desc">{{ desc }}</div>

  <div class="sx-chart">
    <img src="{{ intraday_png }}" alt="{{ id }} chart" loading="lazy">
  </div>

  <div class="sx-tabs">
    <button class="sx-tab is-active">Intraday</button>
    <button class="sx-tab">前場(AM)</button>
    <button class="sx-tab" disabled>7日</button>
    <button class="sx-tab" disabled>1ヶ月</button>
    <button class="sx-tab" disabled>1年</button>
  </div>
</div>

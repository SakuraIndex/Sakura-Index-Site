{%- comment -%}
汎用インデックスカード（stats.json“中身”を stats_json として受け取る版）
- 使い方（index.html 側）:
  {% capture ASTRA_stats %}{% include_relative charts/ASTRA4/stats.json %}{% endcapture %}
  {% include components/index-card.html
      id="ASTRA4"
      title="Astra4"
      badge="宇宙ベンチャー"
      desc="宇宙関連銘柄の等ウェイト指数。日中は%、長期はレベル推移を表示。"
      stats_json=ASTRA_stats
      intraday_png="/charts/ASTRA4/intraday.png"
      am_png="/charts/ASTRA4/intraday_am.png"
  %}
- 重要:
  画像は src="{{ site.baseurl }}{{ include.intraday_png }}" のように baseurl を前置
{%- endcomment -%}

{%- assign _raw = include.stats_json | strip_newlines -%}

{%- comment -%} 安全側：stats_json が空なら N/A {%- endcomment -%}
{%- if _raw == "" or _raw == nil -%}
  {%- assign pct_num = nil -%}
  {%- assign scale = nil -%}
  {%- assign basis = nil -%}
{%- else -%}
  {%- comment -%}
  JSON を Liquid の文字列操作でパース（GitHub Pages の制約でフィルタのみ）
  優先度:
    1) "pct_intraday" があればそれを使う
    2) なければ "delta_level" を使う
  表示は "scale" によって補正:
    - "percent" ならそのまま（例: 1.23 -> +1.23%）
    - "ratio"   なら 100 倍（例: 0.0123 -> +1.23%）
  {%- endcomment -%}

  {%- assign _pct_try = _raw | split: '"pct_intraday":' | last | split: ',' | first | replace:'}','' | strip -%}
  {%- assign _pct_is_num = _pct_try | plus: 0 -%}

  {%- assign _delta_try = _raw | split: '"delta_level":' | last | split: ',' | first | replace:'}','' | strip -%}
  {%- assign _delta_is_num = _delta_try | plus: 0 -%}

  {%- assign scale = _raw | split: '"scale":' | last | split: ',' | first | replace:'"','' | replace:'}','' | strip -%}
  {%- assign basis = _raw | split: '"basis":' | last | split: ',' | first | replace:'"','' | replace:'}','' | strip -%}

  {%- if _pct_try != _raw and _pct_try != "" -%}
    {%- assign raw_value = _pct_is_num -%}
    {%- assign vt = 'pct' -%}
  {%- elsif _delta_try != _raw and _delta_try != "" -%}
    {%- assign raw_value = _delta_is_num -%}
    {%- assign vt = 'delta' -%}
  {%- else -%}
    {%- assign raw_value = nil -%}
    {%- assign vt = nil -%}
  {%- endif -%}

  {%- if raw_value == nil -%}
    {%- assign pct_num = nil -%}
  {%- else -%}
    {%- if scale == 'ratio' -%}
      {%- assign pct_num = raw_value | times: 100 -%}
    {%- else -%}
      {%- assign pct_num = raw_value -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} 見た目定義（前回“良かった方”に合わせて微調整） {%- endcomment -%}
<style>
  .card { background-color: #0b1220; border: 1px solid #1e293b; border-radius: 16px; padding: 16px 16px 12px 16px; box-shadow: 0 0 0 1px rgba(148,163,184,0.04) inset; }
  .card h3 { margin: 0; font-size: 20px; font-weight: 700; color: #e2e8f0; display:flex; align-items:center; gap:10px;}
  .sub { display:inline-block; font-size: 12px; color: #94a3b8; background:#0f172a; border:1px solid #1e293b; padding:3px 8px; border-radius: 999px; }
  .desc { margin: 8px 0 10px 0; color:#94a3b8; font-size: 13px; }
  .delta { margin-left:auto; font-size: 16px; font-weight: 800; }
  .delta.pos { color:#34d399; }  /* + */
  .delta.neg { color:#f87171; }  /* - */
  .chartbox { background:#0a0f1a; border:1px solid #1e293b; border-radius: 10px; height: 260px; display:flex; align-items:center; justify-content:center; overflow:hidden;}
  .chartbox img { width:100%; height:100%; object-fit:contain; }
  .btns { display:flex; gap:8px; margin-top:12px; }
  .btn { color:#cbd5e1; background:#0f172a; border:1px solid #223045; border-radius:999px; padding:6px 10px; font-size:12px; }
  .row { display:flex; align-items:center; gap:10px;}
</style>

<div class="card">
  <div class="row">
    <h3>
      {%- if include.flag -%}<span>{{ include.flag }}</span>{%- endif -%}
      <span>{{ include.title }}</span>
      {%- if include.badge -%}<span class="sub">{{ include.badge }}</span>{%- endif -%}
    </h3>

    {%- if pct_num == nil -%}
      <span class="delta sub">N/A</span>
    {%- else -%}
      {%- assign rounded = pct_num | round: 2 -%}
      {%- if rounded > 0 -%}
        <span class="delta pos">+{{ rounded }}%</span>
      {%- elsif rounded < 0 -%}
        <span class="delta neg">{{ rounded }}%</span>
      {%- else -%}
        <span class="delta sub">0%</span>
      {%- endif -%}
    {%- endif -%}
  </div>

  {%- if include.desc -%}
    <div class="desc">{{ include.desc }}</div>
  {%- endif -%}

  <div class="chartbox">
    <img
      alt="{{ include.id }} chart"
      src="{{ site.baseurl }}{{ include.intraday_png }}"
      onerror="this.style.opacity=0.25; this.alt='chart (no image)';">
  </div>

  <div class="btns">
    <button class="btn" onclick="this.closest('.card').querySelector('img').src='{{ site.baseurl }}{{ include.intraday_png }}'">Intraday</button>
    <button class="btn" onclick="this.closest('.card').querySelector('img').src='{{ site.baseurl }}{{ include.am_png }}'">前場(AM)</button>
    <button class="btn" disabled>7日</button>
    <button class="btn" disabled>1ヶ月</button>
    <button class="btn" disabled>1年</button>
  </div>
</div>

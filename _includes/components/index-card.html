{%- comment -%}
  汎用インデックスカード（完全版）
  - 引数:
    id         : フォルダ名（例 "ASTRA4", "R-BANK9", "AIN-10", "S-COIN+"）
    title      : 表示名
    desc       : 説明文
    flag       : 絵文字国旗
    badge      : 小バッジ
{%- endcomment -%}

{%- assign base = site.baseurl | default: '' -%}
{%- assign folder = include.id | uri_escape -%}

{%- comment -%} charts/*/stats.json を読む {%- endcomment -%}
{%- capture _stats_json -%}
  { "missing": true }
{%- endcapture -%}
{%- capture _path -%}{{ base }}/charts/{{ folder }}/stats.json{%- endcapture -%}
{%- capture stats_raw -%}{% include_relative {{ _path | remove_first: base | remove_first: '/' }} %}{%- endcapture -%}
{%- if stats_raw and stats_raw != '' and stats_raw contains '{' -%}
  {%- assign stats = stats_raw | strip_newlines | replace: ',,', ',' | jsonify | parse_json -%}
{%- else -%}
  {%- assign stats = nil -%}
{%- endif -%}

{%- comment -%} 騰落率ロジック（ASTRA4/R-BANK9/S-COIN+ は pct_intraday、AIN-10 は delta_level×scale） {%- endcomment -%}
{%- assign delta_txt = 'N/A' -%}
{%- assign delta_cls = 'na' -%}
{%- if stats and stats.pct_intraday != nil -%}
  {%- assign v = stats.pct_intraday | times:100.0 -%}
  {%- assign s = v | round: 2 -%}
  {%- if s > 0 -%}{%- assign delta_cls = 'up' -%}{%- elsif s < 0 -%}{%- assign delta_cls = 'down' -%}{%- endif -%}
  {%- assign sign = s > 0 | default: false -%}
  {%- assign delta_txt = s | abs | append:'%' -%}
  {%- if s > 0 -%}{%- assign delta_txt = '+' | append: delta_txt -%}{%- endif -%}
{%- elsif stats and stats.delta_level != nil -%}
  {%- assign s = stats.delta_level -%}
  {%- if stats.scale == 'percent' -%}{%- assign s = s | times: 100.0 -%}{%- endif -%}
  {%- assign s = s | round: 2 -%}
  {%- if s > 0 -%}{%- assign delta_cls = 'up' -%}{%- elsif s < 0 -%}{%- assign delta_cls = 'down' -%}{%- endif -%}
  {%- assign delta_txt = s | abs | append:'%' -%}
  {%- if s > 0 -%}{%- assign delta_txt = '+' | append: delta_txt -%}{%- endif -%}
{%- endif -%}

{%- comment -%} 画像パス（intraday / intraday_am まで。残りは必要あれば追加） {%- endcomment -%}
{%- assign src_intraday   = base | append: '/charts/' | append: folder | append: '/intraday.png' -%}
{%- assign src_am         = base | append: '/charts/' | append: folder | append: '/intraday_am.png' -%}
{%- assign src_7d         = base | append: '/charts/' | append: folder | append: '/7d.png' -%}
{%- assign src_1m         = base | append: '/charts/' | append: folder | append: '/1m.png' -%}
{%- assign src_1y         = base | append: '/charts/' | append: folder | append: '/1y.png' -%}

<div class="card" data-chart>
  <div class="card-head">
    <span class="flag">{{ include.flag }}</span>
    <span class="title">{{ include.title }}</span>
    <span class="badge">{{ include.badge }}</span>
    <span class="desc">{{ include.desc }}</span>
    <span class="delta {{ delta_cls }}">{{ delta_txt }}</span>
  </div>

  <div class="chart-wrap">
    <img
      class="chart"
      alt="{{ include.title }} chart"
      loading="lazy"
      src="{{ src_intraday }}"
      data-fallback="{{ src_am }}"
    />
  </div>

  <div class="card-foot">
    <button class="btn active" data-src="{{ src_intraday }}">Intraday</button>
    <button class="btn" data-src="{{ src_am }}">前場(AM)</button>
    <button class="btn" data-src="{{ src_7d }}">7日</button>
    <button class="btn" data-src="{{ src_1m }}">1ヶ月</button>
    <button class="btn" data-src="{{ src_1y }}">1年</button>
  </div>
</div>

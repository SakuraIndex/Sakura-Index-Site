{%- comment -%}
  汎用インデックスカード（stats.json 対応）
  受け取りパラメータ:
    - id              : 例 "ASTRA4"
    - title           : 表示名
    - badge           : 小バッジ
    - desc            : 説明文
    - stats_json      : capture で取り込んだ stats.json の文字列
    - intraday_png    : /charts/<id>/intraday.png
    - am_png          : /charts/<id>/intraday_am.png
    - d7_png          : 任意（7日チャート）
    - m1_png          : 任意（1ヶ月チャート）
    - y1_png          : 任意（1年チャート）
    - flag            : 例 "🇯🇵"
{%- endcomment -%}

{%- assign _raw = include.stats_json | strip_newlines -%}

{%- comment -%}
  1) 値の抽出
     - pct_intraday が最優先
     - 無ければ delta_level を使用
     - scale が無い/不明な場合に備えて **自動推定** を入れる
{%- endcomment -%}

{%- assign pct_num = nil -%}
{%- assign scale = nil -%}
{%- assign basis = nil -%}

{%- if _raw != "" and _raw != nil -%}
  {%- comment -%} 値候補 {%- endcomment -%}
  {%- assign _pct_try = _raw | split:'"pct_intraday":' | last | split:',' | first | replace:'}','' | strip -%}
  {%- assign _pct_is_num = _pct_try | plus: 0 -%}

  {%- assign _delta_try = _raw | split:'"delta_level":' | last | split:',' | first | replace:'}','' | strip -%}
  {%- assign _delta_is_num = _delta_try | plus: 0 -%}

  {%- comment -%} scale / basis {%- endcomment -%}
  {%- assign _scale_raw = _raw | split:'"scale":' | last | split:',' | first | replace:'"','' | replace:'}','' | strip -%}
  {%- if _scale_raw == _raw or _scale_raw == "" -%}
    {%- assign scale = nil -%}
  {%- else -%}
    {%- assign scale = _scale_raw -%}
  {%- endif -%}

  {%- assign basis = _raw | split:'"basis":' | last | split:',' | first | replace:'"','' | replace:'}','' | strip -%}

  {%- comment -%} どちらの値を使うか {%- endcomment -%}
  {%- if _pct_try != _raw and _pct_try != "" -%}
    {%- assign raw_value = _pct_is_num -%}
  {%- elsif _delta_try != _raw and _delta_try != "" -%}
    {%- assign raw_value = _delta_is_num -%}
  {%- else -%}
    {%- assign raw_value = nil -%}
  {%- endif -%}

  {%- comment -%}
    2) パーセント化
       - scale == "ratio"      → 100 倍
       - scale == "percent"    → そのまま
       - scale が無い/不明     → |値| < 0.5 を ratio とみなし 100 倍、そうでなければ percent
  {%- endcomment -%}
  {%- if raw_value != nil -%}
    {%- assign absval = raw_value | abs -%}
    {%- if scale == 'ratio' or (scale == nil and absval < 0.5) -%}
      {%- assign pct_num = raw_value | times: 100 -%}
    {%- else -%}
      {%- assign pct_num = raw_value -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} 表示用の成形 {%- endcomment -%}
{%- if pct_num == nil -%}
  {%- assign pct_text = 'N/A' -%}
  {%- assign pct_class = 'pct-na' -%}
{%- else -%}
  {%- assign rounded = pct_num | round: 2 -%}
  {%- if rounded > 0 -%}
    {%- assign pct_text = '+' | append: rounded | append: '%' -%}
    {%- assign pct_class = 'pct-up' -%}
  {%- elsif rounded < 0 -%}
    {%- assign pct_text = rounded | append: '%' -%}
    {%- assign pct_class = 'pct-down' -%}
  {%- else -%}
    {%- assign pct_text = '0%' -%}
    {%- assign pct_class = 'pct-zero' -%}
  {%- endif -%}
{%- endif -%}

<div class="card">
  <div class="card-hd">
    <div class="title">
      <span class="flag">{{ include.flag | default: '' }}</span>
      <span class="name">{{ include.title }}</span>
      {% if include.badge %}<span class="badge">{{ include.badge }}</span>{% endif %}
    </div>
    <div class="pct {{ pct_class }}">{{ pct_text }}</div>
  </div>

  {% if include.desc %}
  <p class="desc">{{ include.desc }}</p>
  {% endif %}

  <div class="chart-wrap">
    <img class="chart" src="{{ include.intraday_png }}" alt="{{ include.id }} chart">
  </div>

  <div class="btns">
    <span class="btn btn-active">Intraday</span>
    <span class="btn">前場(AM)</span>
    <span class="btn">7日</span>
    <span class="btn">1ヶ月</span>
    <span class="btn">1年</span>
  </div>
</div>

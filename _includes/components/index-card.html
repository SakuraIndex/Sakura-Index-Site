{%- comment -%}
  共通カード（シンプル＆堅牢抽出）
  受取: id, flag, title, badge, desc, stats_json, intraday_png, am_png
  対応キー（優先順）: pct_intraday, pct_id, pct, delta_intraday, delta_level
{%- endcomment -%}

<style>
  .card{background:#0e1522;border:1px solid #1f2a40;border-radius:18px;padding:14px 16px}
  .card__head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
  .left{display:flex;align-items:center;gap:8px}
  .flag{font-size:16px}
  .title{font-weight:700}
  .chip{font-size:11px;background:#0f1726;border:1px solid #1f2a40;color:#9fb5e4;border-radius:999px;padding:.2rem .5rem}
  .right{font-weight:800}
  .pct{color:#36d399}
  .pct.neg{color:#ff6b6b}
  .desc{color:#93a4c8;font-size:13px;margin-top:2px;margin-bottom:10px}
  .imgwrap{background:#0b1119;border:1px solid #1f2a40;border-radius:12px;padding:8px}
  .imgwrap img{display:block;width:100%;height:auto;border-radius:6px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{font-size:12px;color:#cdddff;background:#0f1726;border:1px solid #1f2a40;padding:.35rem .6rem;border-radius:999px}
  .tab.active{outline:2px solid #233252}
</style>

{%- assign raw = include.stats_json | replace: ' ', '' | replace: '\n', '' -%}

{%- comment -%}
  値をシンプルに抽出:
  1) "key": の直後から取り出し
  2) 区切りは , か } のどちらでもOK
{%- endcomment -%}
{%- assign val = '' -%}
{%- assign keys = 'pct_intraday|pct_id|pct|delta_intraday|delta_level' | split:'|' -%}
{%- for k in keys -%}
  {%- if val == '' -%}
    {%- assign marker = '"' | append:k | append:'":' -%}
    {%- if raw contains marker -%}
      {%- assign tail = raw | split: marker | last -%}
      {%- assign first = tail | split: ',' | first -%}
      {%- assign first = first | split: '}' | first -%}
      {%- assign first = first | replace:'"','' | replace:'%','' | strip -%}
      {%- assign val = first -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} scale を抽出（"percent"ならそのまま扱い、無指定は <1 のときだけ ×100） {%- endcomment -%}
{%- assign scale_val = '' -%}
{%- assign marker_scale = '"scale":' -%}
{%- if raw contains marker_scale -%}
  {%- assign tail_s = raw | split: marker_scale | last -%}
  {%- assign s = tail_s | split: ',' | first | split: '}' | first | replace:'"','' | strip -%}
  {%- assign scale_val = s -%}
{%- endif -%}

{%- assign display = 'N/A' -%}
{%- assign n = 0.0 -%}
{%- if val != '' -%}
  {%- assign n = val | plus: 0 -%}
  {%- if scale_val == 'percent' -%}
    {%- assign n = n -%} {# 既に % 指定 #}
  {%- else -%}
    {%- if n < 1 and n > -1 -%}{%- assign n = n | times: 100 -%}{%- endif -%}
  {%- endif -%}
  {%- if n > -200 and n < 200 -%}
    {%- assign s = n | round: 2 -%}
    {%- if s > 0 -%}{%- assign display = '+' | append: s | append: '%' -%}
    {%- elsif s < 0 -%}{%- assign display = s | append: '%' -%}
    {%- else -%}{%- assign display = '+0.00%' -%}{%- endif -%}
  {%- endif -%}
{%- endif -%}

<div class="card">
  <div class="card__head">
    <div class="left">
      <span class="flag">{{ include.flag }}</span>
      <span class="title">{{ include.title }}</span>
      <span class="chip">{{ include.badge }}</span>
    </div>
    <div class="right">
      <span class="pct{% if display != 'N/A' and n < 0 %} neg{% endif %}">{{ display }}</span>
    </div>
  </div>

  <div class="desc">{{ include.desc }}</div>

  <div class="imgwrap">
    <img
      src="{{ include.intraday_png | relative_url }}"
      alt="{{ include.id }} chart"
      loading="lazy"
      decoding="async"
      onerror="this.onerror=null;this.src='{{ include.am_png | relative_url }}';">
  </div>

  <div class="tabs" aria-hidden="true">
    <span class="tab active">Intraday</span>
    <span class="tab">前場(AM)</span>
    <span class="tab">7日</span>
    <span class="tab">1ヶ月</span>
    <span class="tab">1年</span>
  </div>
</div>

{%- comment -%}
  å…±é€šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰
  å…¥åŠ›: include.indexï¼ˆè¾æ›¸ï¼‰
    - id            ä¾‹: "ASTRA4"
    - title         ä¾‹: "Astra4"
    - badge         ä¾‹: "å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼"
    - desc          ä¾‹: "â€¦â€¦"
    - json_path     ä¾‹: "/charts/ASTRA4/stats.json"
    - intraday_png  ä¾‹: "/charts/ASTRA4/intraday.png"
    - am_png        ä¾‹: "/charts/ASTRA4/intraday_am.png"
{%- endcomment -%}

{%- assign idx = include.index -%}
{%- assign id = idx.id -%}
{%- assign title = idx.title -%}
{%- assign badge = idx.badge -%}
{%- assign desc = idx.desc -%}
{%- assign json_path = idx.json_path -%}
{%- assign intraday_png = idx.intraday_png -%}
{%- assign am_png = idx.am_png -%}

{%- comment -%}
  æ——ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç°¡æ˜“ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
  æ—¥æœ¬: ASTRA4, R-BANK9, S-COIN+
  ç±³å›½: AIN-10
{%- endcomment -%}
{%- assign flag = "ğŸ‡¯ğŸ‡µ" -%}
{%- if id == "AIN-10" -%}
  {%- assign flag = "ğŸ‡ºğŸ‡¸" -%}
{%- endif -%}

<section class="index-card" data-index-id="{{ id | escape }}">
  <div class="card-head">
    <div class="card-title">
      <span class="flag">{{ flag }}</span>
      <strong>{{ title }}</strong>
      <span class="badge">{{ badge }}</span>
    </div>
    <div class="card-delta">
      <span class="delta-value" data-delta="pending">N/A</span>
    </div>
  </div>

  <p class="card-desc">{{ desc }}</p>

  <div class="card-chart">
    <img
      class="chart-img"
      src="{{ intraday_png | escape }}"
      alt="{{ id }} chart"
      loading="lazy"
      onerror="this.onerror=null; this.src='{{ am_png | escape }}';"
    />
  </div>

  <div class="card-actions">
    <button type="button" class="ghost">Intraday</button>
    <button type="button" class="ghost">å‰å ´(AM)</button>
    <button type="button" class="ghost">7æ—¥</button>
    <button type="button" class="ghost">1ãƒ¶æœˆ</button>
    <button type="button" class="ghost">1å¹´</button>
  </div>

  {%- comment -%} ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¿…è¦ãªãƒ‘ã‚¹ã‚’ data å±æ€§ã§åŸ‹ã‚è¾¼ã‚€ {%- endcomment -%}
  <template class="stats-source" data-json="{{ json_path | escape }}"></template>
</section>

{%- comment -%}
  --- æœ€å°JSï¼ˆé‡è¤‡ãƒ­ãƒ¼ãƒ‰é˜²æ­¢ï¼‰ ---
  ãƒ»å„ã‚«ãƒ¼ãƒ‰ã® <template.stats-source> ã‹ã‚‰ JSON ãƒ‘ã‚¹ã‚’å–ã‚Šå‡ºã—ã¦ fetch
  ãƒ»è¡¨ç¤ºå€¤ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯:
      1) JSON ã« value_type ãŒã‚ã‚Œã°ãã‚Œã«å¾“ã†
         - "percent" ãªã‚‰ delta_level ã‚’ãã®ã¾ã¾%è¡¨ç¤º
         - "ratio"    ãªã‚‰ pct_intraday ã‚’ 100å€ã—ã¦%è¡¨ç¤º
      2) ç„¡ã‘ã‚Œã°ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯:
         - scale === "percent" ã‹ã¤ delta_level ãŒæ•°å€¤ -> delta_level ã‚’%è¡¨ç¤º
         - pct_intraday ãŒæ•°å€¤ -> å€¤ãŒ Â±1.5 æœªæº€ãªã‚‰ 100å€ï¼ˆæ¯”ç‡ã¨æ¨å®šï¼‰ã€ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾%ã¨ã¿ãªã™
  ãƒ»æ­£è² ã«å¿œã˜ã¦ class ã‚’ä»˜ä¸ï¼ˆpositive / negative / zeroï¼‰
{%- endcomment -%}
<script>
(function () {
  if (window.__sakuraIndexCardLoaded) return;
  window.__sakuraIndexCardLoaded = true;

  function fmtPct(v) {
    if (!isFinite(v)) return 'N/A';
    const sign = v > 0 ? '+' : (v < 0 ? '' : '');
    // å°æ•°2æ¡å›ºå®š
    return sign + v.toFixed(2) + '%';
  }

  function decideDelta(stats) {
    if (!stats || typeof stats !== 'object') return { text: 'N/A', className: '' };

    // 1) æ˜ç¤ºã® value_type ã‚’å„ªå…ˆ
    if (typeof stats.value_type === 'string') {
      const vt = stats.value_type.toLowerCase();
      if (vt === 'percent' && typeof stats.delta_level === 'number') {
        return decorate(stats.delta_level);
      }
      if (vt === 'ratio' && typeof stats.pct_intraday === 'number') {
        return decorate(stats.pct_intraday * 100);
      }
    }

    // 2) æš«å®šãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
    // AIN-10 ãªã©: scale == "percent" ã‹ã¤ delta_level ãŒãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ â†’ ãã®ã¾ã¾
    if (stats.scale === 'percent' && typeof stats.delta_level === 'number') {
      return decorate(stats.delta_level);
    }

    // å¤šãã®æŒ‡æ•°: pct_intraday ãŒã‚ã‚Œã°ä½¿ã†
    if (typeof stats.pct_intraday === 'number') {
      let v = stats.pct_intraday;
      // å€¤ãŒå°ã•ã„(Â±1.5æœªæº€)â†’æ¯”ç‡ã¨æ¨å®šã—ã¦Ã—100ã€å¤§ãã„â†’æ—¢ã«ï¼…ã¨ã¿ãªã™
      if (Math.abs(v) < 1.5) v = v * 100;
      return decorate(v);
    }

    return { text: 'N/A', className: '' };
  }

  function decorate(valuePct) {
    const text = fmtPct(valuePct);
    const className =
      valuePct > 0 ? 'positive' :
      valuePct < 0 ? 'negative' : 'zero';
    return { text, className };
  }

  async function loadOneCard(card) {
    const tpl = card.querySelector('template.stats-source');
    if (!tpl) return;

    const url = tpl.dataset.json;
    const out = card.querySelector('[data-delta]');
    if (!out) return;

    try {
      const res = await fetch(url, { cache: 'no-cache' });
      if (!res.ok) throw new Error(res.status + ' ' + url);
      const stats = await res.json();

      const picked = decideDelta(stats);
      out.textContent = picked.text;
      out.classList.remove('positive', 'negative', 'zero');
      if (picked.className) out.classList.add(picked.className);
      out.dataset.delta = 'done';
    } catch (e) {
      out.textContent = 'N/A';
      out.dataset.delta = 'error';
      // console.warn('stats load failed:', url, e);
    }
  }

  function boot() {
    document.querySelectorAll('.index-card').forEach(loadOneCard);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot, { once: true });
  } else {
    boot();
  }
})();
</script>

<style>
/* è»½é‡ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ï¼‰ */
.index-card {
  display: grid;
  gap: .6rem;
  padding: 1rem;
  border-radius: .9rem;
  background: rgba(255,255,255,0.03);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
}
.index-card .card-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.index-card .card-title {
  display: flex;
  align-items: center;
  gap: .5rem;
  font-size: 1.05rem;
}
.index-card .flag { font-size: 1.15rem; }
.index-card .badge {
  font-size: .75rem;
  padding: .12rem .5rem;
  border-radius: 999px;
  background: rgba(255,255,255,0.06);
}
.index-card .card-delta .delta-value {
  font-weight: 700;
}
.index-card .card-delta .positive { color: #27d17f; }
.index-card .card-delta .negative { color: #ff6b6b; }
.index-card .card-delta .zero { color: #c7c7c7; }

.index-card .card-desc {
  margin: 0;
  opacity: .85;
  font-size: .92rem;
}

.index-card .card-chart {
  background: rgba(255,255,255,0.02);
  border-radius: .6rem;
  overflow: hidden;
}
.index-card .chart-img {
  display: block;
  width: 100%;
  height: auto;
}

.index-card .card-actions {
  display: flex;
  gap: .5rem;
}
.index-card .card-actions .ghost {
  padding: .35rem .7rem;
  border-radius: 999px;
  background: rgba(255,255,255,0.06);
  border: none;
  color: inherit;
  font: inherit;
  cursor: default;
}
</style>

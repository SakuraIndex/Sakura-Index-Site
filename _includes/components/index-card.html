{%- comment -%}
共通インデックスカード（stats.json対応版）
受け取る引数:
- id, flag, title, badge, desc
- json_path : /charts/.../stats.json
- intraday_png, am_png : 画像パス
{%- endcomment -%}

{%- assign _id = include.id -%}
{%- assign _flag = include.flag | default: "" -%}
{%- assign _title = include.title | default: _id -%}
{%- assign _badge = include.badge | default: "" -%}
{%- assign _desc = include.desc | default: "" -%}

{%- assign _json_rel = include.json_path | relative_url -%}
{%- assign _png_intraday = include.intraday_png  | relative_url -%}
{%- assign _png_am       = include.am_png        | relative_url -%}

{%- capture _raw -%}{% include_relative {{ include.json_path }} %}{%- endcapture -%}
{%- assign _raw = _raw | strip_newlines -%}

{%- assign pct = "" -%}
{%- assign scale = "" -%}
{%- assign delta = "" -%}

{%- comment -%}
1) pct_intraday を抜く
{%- endcomment -%}
{%- if _raw contains '"pct_intraday":' -%}
  {%- assign tmp = _raw | split:'"pct_intraday":' | last -%}
  {%- assign pct = tmp  | split:',' | first | strip -%}
{%- endif -%}

{%- comment -%}
2) scale を抜く
{%- if _raw contains '"scale":' %}{% endcomment -%}
{%- if _raw contains '"scale":' -%}
  {%- assign tmp = _raw | split:'"scale":' | last -%}
  {%- assign scale = tmp | split:',' | first | strip | replace:'"','' -%}
{%- endif -%}

{%- comment -%}
3) delta_level（補助）を抜く
{%- endcomment -%}
{%- if _raw contains '"delta_level":' -%}
  {%- assign tmp = _raw | split:'"delta_level":' | last -%}
  {%- assign delta = tmp | split:',' | first | strip -%}
{%- endif -%}

{%- assign pct_num = pct | plus: 0 -%}
{%- assign delta_num = delta | plus: 0 -%}

{%- comment -%}
4) 表示用%の決定ロジック
- pct_intraday があればそれをベース
- なければ delta_level を代用
- scale=="percent" のときは "そのまま % 表示"
- ratio あるいは scale 不明のときは ×100（0.0〜3.0 などを 0%〜300% に整形）
{%- endcomment -%}

{%- assign use = pct_num -%}
{%- if use == 0 and delta != "" -%}
  {%- assign use = delta_num -%}
{%- endif -%}

{%- assign percent = use -%}
{%- if scale == "percent" -%}
  {%- assign percent = use -%}
{%- else -%}
  {%- assign percent = use | times: 100 -%}
{%- endif -%}

{%- assign sign = "+" -%}
{%- if percent < 0 -%}{%- assign sign = "" -%}{%- endif -%}
{%- assign abs = percent | abs -%}
{%- assign pretty = abs | round: 2 -%}
{%- capture display -%}{{ sign }}{{ pretty }}%{%- endcapture -%}

{%- assign delta_class = "good" -%}
{%- if percent < 0 -%}{%- assign delta_class = "bad" -%}{%- endif -%}

<div class="card" data-card data-srcs='{"intraday":"{{ _png_intraday }}","am":"{{ _png_am }}"}'>
  <div class="card-head">
    <span class="flag">{{ _flag }}</span>
    <span class="title">{{ _title }}</span>
    {% if _badge %}<span class="badge">{{ _badge }}</span>{% endif %}
    <span class="desc">{{ _desc }}</span>
    <span class="delta {{ delta_class }}">{{ display }}</span>
  </div>

  <div class="chart-box">
    <img data-chart loading="lazy" alt="{{ _id }} chart"
         src="{{ _png_intraday }}" />
  </div>

  <div class="tabrow">
    <button type="button" class="chipbtn active" data-tab="intraday">Intraday</button>
    <button type="button" class="chipbtn" data-tab="am">前場(AM)</button>
    <button type="button" class="chipbtn" title="準備中" disabled>7日</button>
    <button type="button" class="chipbtn" title="準備中" disabled>1ヶ月</button>
    <button type="button" class="chipbtn" title="準備中" disabled>1年</button>
  </div>
</div>

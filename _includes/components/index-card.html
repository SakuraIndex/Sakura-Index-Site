{%- comment -%}
  汎用インデックスカード（stats.json の文字列を渡す）
  受け取りパラメータ:
    - id, title, badge, desc, flag
    - stats_json  : capture した charts/<id>/stats.json の文字列
    - intraday_png: /charts/<id>/intraday.png
    - am_png      : /charts/<id>/intraday_am.png
    - d7_png/m1_png/y1_png : 任意
    - scale_hint  : "ratio" | "percent"（任意・強制指定用）
{%- endcomment -%}

{%- assign _raw = include.stats_json | strip_newlines -%}

{%- assign pct_num = nil -%}
{%- assign scale = nil -%}

{%- if _raw and _raw != "" -%}
  {%- comment -%} 値の抽出（pct_intraday → delta_level の順） {%- endcomment -%}
  {%- assign _pct_try = _raw | split:'"pct_intraday":' | last | split:',' | first | replace:'}','' | strip -%}
  {%- assign _pct_num = _pct_try | plus: 0 -%}

  {%- assign _delta_try = _raw | split:'"delta_level":'    | last | split:',' | first | replace:'}','' | strip -%}
  {%- assign _delta_num = _delta_try | plus: 0 -%}

  {%- if _pct_try != _raw and _pct_try != "" -%}
    {%- assign raw_value = _pct_num -%}
  {%- elsif _delta_try != _raw and _delta_try != "" -%}
    {%- assign raw_value = _delta_num -%}
  {%- else -%}
    {%- assign raw_value = nil -%}
  {%- endif -%}

  {%- comment -%} scale の取得 {%- endcomment -%}
  {%- assign _scale_raw = _raw | split:'"scale":' | last | split:',' | first | replace:'"','' | replace:'}','' | strip -%}
  {%- if _scale_raw != _raw and _scale_raw != "" -%}
    {%- assign scale = _scale_raw -%}
  {%- endif -%}

  {%- comment -%}
    スケール確定:
      - include.scale_hint が最優先
      - 次に stats.json の "scale"
      - それでも無い場合は自動推定（|value| < 0.5 → ratio とみなす）
  {%- endcomment -%}
  {%- if raw_value != nil -%}
    {%- assign chosen = include.scale_hint | default: scale -%}
    {%- if chosen == 'ratio' -%}
      {%- assign pct_num = raw_value | times: 100 -%}
    {%- elsif chosen == 'percent' -%}
      {%- assign pct_num = raw_value -%}
    {%- else -%}
      {%- assign absval = raw_value | abs -%}
      {%- if absval < 0.5 -%}
        {%- assign pct_num = raw_value | times: 100 -%}
      {%- else -%}
        {%- assign pct_num = raw_value -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- if pct_num == nil -%}
  {%- assign pct_text = 'N/A' -%}
  {%- assign pct_class = 'pct-na' -%}
{%- else -%}
  {%- assign rounded = pct_num | round: 2 -%}
  {%- if rounded > 0 -%}
    {%- assign pct_text = '+' | append: rounded | append: '%' -%}
    {%- assign pct_class = 'pct-up' -%}
  {%- elsif rounded < 0 -%}
    {%- assign pct_text = rounded | append: '%' -%}
    {%- assign pct_class = 'pct-down' -%}
  {%- else -%}
    {%- assign pct_text = '0%' -%}
    {%- assign pct_class = 'pct-zero' -%}
  {%- endif -%}
{%- endif -%}

<div class="card">
  <div class="card-hd">
    <div class="title">
      <span class="flag">{{ include.flag | default: '' }}</span>
      <span class="name">{{ include.title }}</span>
      {% if include.badge %}<span class="badge">{{ include.badge }}</span>{% endif %}
    </div>
    <div class="pct {{ pct_class }}">{{ pct_text }}</div>
  </div>

  {% if include.desc %}
  <p class="desc">{{ include.desc }}</p>
  {% endif %}

  <div class="chart-wrap">
    <img class="chart" src="{{ site.baseurl }}{{ include.intraday_png }}" alt="{{ include.id }} chart">
  </div>

  <div class="btns">
    <span class="btn btn-active">Intraday</span>
    <span class="btn">前場(AM)</span>
    <span class="btn">7日</span>
    <span class="btn">1ヶ月</span>
    <span class="btn">1年</span>
  </div>
</div>

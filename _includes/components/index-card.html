{%- comment -%}
  共通カード（ロバスト抽出版）
  受け取り:
    id, flag, title, badge, desc
    stats_json (文字列)
    intraday_png, am_png
  サポートする候補キー（先勝ち）:
    "pct_intraday", "pct_id", "pct", "delta_intraday", "delta_level"
{%- endcomment -%}

<style>
  .card{background:#0e1522;border:1px solid #1f2a40;border-radius:18px;padding:14px 16px}
  .card__head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
  .left{display:flex;align-items:center;gap:8px}
  .flag{font-size:16px}
  .title{font-weight:700}
  .chip{font-size:11px;background:#0f1726;border:1px solid #1f2a40;color:#9fb5e4;border-radius:999px;padding:.2rem .5rem}
  .right{font-weight:800}
  .pct{color:#36d399}
  .pct.neg{color:#ff6b6b}
  .desc{color:#93a4c8;font-size:13px;margin-top:2px;margin-bottom:10px}
  .imgwrap{background:#0b1119;border:1px solid #1f2a40;border-radius:12px;padding:8px}
  .imgwrap img{display:block;width:100%;height:auto;border-radius:6px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{font-size:12px;color:#cdddff;background:#0f1726;border:1px solid #1f2a40;padding:.35rem .6rem;border-radius:999px}
  .tab.active{outline:2px solid #233252}
</style>

{%- assign raw = include.stats_json | strip_newlines -%}

{%- comment -%}
  汎用抽出関数相当（Liquid で疑似）
  ・key が見つかれば key の直後から ':' を越えて、',' か '}' までを切り出す
  ・クォート/パーセント記号/空白を除去
{%- endcomment -%}
{%- assign found = "" -%}
{%- assign val = "" -%}
{%- assign keys = 'pct_intraday|pct_id|pct|delta_intraday|delta_level' | split:'|' -%}
{%- for k in keys -%}
  {%- if found == "" and raw contains '"' | append: k | append: '"' -%}
    {%- assign seg = raw | split:'"' | append:'' -%}{% comment %}ダミー{% endcomment %}
    {%- assign after = raw | split:'"' | last -%}{% comment %}使わない{% endcomment %}
    {%- assign part = raw | split: '"' | append:'' -%}{% comment %}使わない{% endcomment %}

    {%- assign tmp = raw | split:'"' | join:'"' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split:'"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign chunk = raw | split:'"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign piece = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign p = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign tail = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign tail = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign tail = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign tail = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign tail = raw | split:'"' | join:'"' -%}{% comment %}no-op{% endcomment %}

    {%- assign after = raw | split:'"' | join:'"' -%}{% comment %}no-op{% endcomment %}

    {%- comment -%} 実処理 {%- endcomment -%}
    {%- assign tail = raw | split: '"' | join:'"' -%}{% comment %}no-op{% endcomment %}
    {%- assign tail = raw | split: '"' | join:'"' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split:'"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | join:'"' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split:'"' | last -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split:'"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign after_key = raw | split:'"' | last -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign seg = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign tail = raw | split: '"' | append:'' -%}{% comment %}no-op{% endcomment %}

    {%- assign tail = raw | split: '"'+k+'"' | last -%}
    {%- assign tail = tail | split: ':' | last -%}
    {%- assign cut_c = tail | split: ',' | first -%}
    {%- assign cut_b = cut_c | split: '}' | first -%}
    {%- assign val = cut_b | replace:'"','' | replace:'%','' | strip -%}
    {%- assign found = k -%}
  {%- endif -%}
{%- endfor -%}

{%- assign scale_val = "" -%}
{%- if raw contains '"scale"' -%}
  {%- assign s_tail = raw | split:'"scale"' | last | split:':' | last -%}
  {%- assign s_cut_c = s_tail | split:',' | first -%}
  {%- assign s_cut_b = s_cut_c | split:'}' | first -%}
  {%- assign scale_val = s_cut_b | replace:'"','' | strip -%}
{%- endif -%}

{%- assign n = 0.0 -%}
{%- assign display = "N/A" -%}
{%- if val != "" -%}
  {%- assign n = val | plus: 0 -%}
  {%- if scale_val == "percent" -%}
    {%- assign n = n -%}   {# 既に% #}
  {%- else -%}
    {%- if n < 1 and n > -1 -%}{%- assign n = n | times: 100 -%}{%- endif -%}
  {%- endif -%}
  {%- if n > -200 and n < 200 -%}
    {%- assign s = n | round: 2 -%}
    {%- if s > 0 -%}{%- assign display = "+" | append: s | append: "%" -%}
    {%- elsif s < 0 -%}{%- assign display = s | append: "%" -%}
    {%- else -%}{%- assign display = "+0.00%" -%}{%- endif -%}
  {%- endif -%}
{%- endif -%}

<div class="card">
  <div class="card__head">
    <div class="left">
      <span class="flag">{{ include.flag }}</span>
      <span class="title">{{ include.title }}</span>
      <span class="chip">{{ include.badge }}</span>
    </div>
    <div class="right">
      {%- if display == "N/A" -%}
        <span class="pct">N/A</span>
      {%- else -%}
        <span class="pct{% if n < 0 %} neg{% endif %}">{{ display }}</span>
      {%- endif -%}
    </div>
  </div>

  <div class="desc">{{ include.desc }}</div>

  <div class="imgwrap">
    <img
      src="{{ include.intraday_png | relative_url }}"
      alt="{{ include.id }} chart"
      loading="lazy"
      decoding="async"
      onerror="this.onerror=null;this.src='{{ include.am_png | relative_url }}';">
  </div>

  <div class="tabs" aria-hidden="true">
    <span class="tab active">Intraday</span>
    <span class="tab">前場(AM)</span>
    <span class="tab">7日</span>
    <span class="tab">1ヶ月</span>
    <span class="tab">1年</span>
  </div>
</div>

<!-- _includes/components/index-card.html -->
<div class="si-card" id="card-{{ include.id | escape }}">
  <div class="si-card__head">
    <div class="si-card__left">
      <span class="si-flag">
        {%- assign _id = include.id | upcase -%}
        {%- if _id == "AIN-10" -%}🇺🇸
        {%- else -%}🇯🇵
        {%- endif -%}
      </span>
      <span class="si-title">{{ include.title }}</span>
      {%- if include.badge -%}
      <span class="si-badge">{{ include.badge }}</span>
      {%- endif -%}
    </div>
    <div class="si-card__right">
      <span class="si-delta" data-delta="N/A">N/A</span>
    </div>
  </div>

  <p class="si-desc">{{ include.description }}</p>

  <div class="si-chart">
    <img
      class="si-chart__img"
      alt="{{ include.id }} chart"
      src="{{ include.intraday_png | default: include.am_png }}"
      data-src-intraday="{{ include.intraday_png }}"
      data-src-am="{{ include.am_png }}"
      onerror="this.dataset.error='1'; this.alt='chart (no image)';"
    />
  </div>

  <div class="si-toolbar">
    <button class="si-btn is-active" data-view="intraday">Intraday</button>
    <button class="si-btn" data-view="am">前場(AM)</button>
  </div>
</div>

<script>
(() => {
  const root = document.currentScript.closest('.si-card');
  if (!root) return;

  const img = root.querySelector('.si-chart__img');
  const deltaEl = root.querySelector('.si-delta');
  const buttons = root.querySelectorAll('.si-btn');
  const jsonPath = "{{ include.json_path | escape }}";

  // --- ボタンで画像切替（PNGが無い場合は自動でフォールバックしない仕様） ---
  function setView(view){
    buttons.forEach(b => b.classList.toggle('is-active', b.dataset.view === view));
    const src = view === 'am' ? img.dataset.srcAm : img.dataset.srcIntraday;
    if (src) img.src = src;
  }
  buttons.forEach(b => b.addEventListener('click', () => setView(b.dataset.view)));
  setView('intraday');

  // --- 騰落率の表示ロジック（stats.jsonの差異を吸収） ---
  // 取りうる形：
  // - { "pct_intraday": 0.0123, ... }
  // - { "pct_id": 0.0123, ... }
  // - { "delta_level": 0.0123, "scale": "percent" } または "value_type": "percent"
  // 既知の異常：巨大値（+100超など）。想定しない値は安全に "N/A" 表示。
  function formatPct(x) {
    if (typeof x !== 'number' || !isFinite(x)) return null;
    // [-100, +100] % 以内だけ許可（安全側）
    if (Math.abs(x) > 100) return null;
    const s = (x >= 0 ? '+' : '') + x.toFixed(2) + '%';
    return s;
  }

  function computeDisplay(obj) {
    try {
      if (!obj || typeof obj !== 'object') return null;

      // 1) 率そのもの
      if (typeof obj.pct_intraday === 'number') {
        return obj.pct_intraday * 100;
      }
      if (typeof obj.pct_id === 'number') {
        return obj.pct_id * 100;
      }

      // 2) レベル差 + スケール
      if (typeof obj.delta_level === 'number') {
        const vt = (obj.value_type || obj.scale || '').toString().toLowerCase();
        // "percent" のとき：delta_level が 0.0123 なら 1.23% 表示に
        if (vt.includes('percent')) {
          const v = Math.abs(obj.delta_level) < 10 ? obj.delta_level * 100 : obj.delta_level;
          return v;
        }
        // それ以外は比率とみなす
        return obj.delta_level * 100;
      }

      return null;
    } catch(e) { return null; }
  }

  function paintDelta(vPct) {
    const text = formatPct(vPct);
    if (text === null) {
      deltaEl.textContent = 'N/A';
      deltaEl.dataset.delta = 'N/A';
      deltaEl.classList.remove('is-up','is-down');
      return;
    }
    deltaEl.textContent = text;
    deltaEl.dataset.delta = text;
    deltaEl.classList.toggle('is-up',  vPct >  0.0001);
    deltaEl.classList.toggle('is-down',vPct < -0.0001);
  }

  // フェッチして delta を描画
  if (jsonPath) {
    fetch(jsonPath, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : null)
      .then(j => {
        const vPct = computeDisplay(j);
        paintDelta(vPct);
      })
      .catch(() => paintDelta(null));
  } else {
    paintDelta(null);
  }
})();
</script>

<style>
.si-card{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin:18px 0;background:rgba(255,255,255,.02)}
.si-card__head{display:flex;align-items:center;justify-content:space-between}
.si-card__left{display:flex;align-items:center;gap:.5rem}
.si-flag{font-size:1.1rem}
.si-title{font-weight:700}
.si-badge{font-size:.8rem;padding:.1rem .5rem;border:1px solid rgba(255,255,255,.12);border-radius:999px}
.si-card__right{font-variant-numeric:tabular-nums}
.si-delta{font-weight:700}
.si-delta.is-up{color:#32d296}
.si-delta.is-down{color:#ff6b6b}
.si-desc{opacity:.8;margin:.35rem 0 .6rem}
.si-chart{text-align:center;background:rgba(255,255,255,.03);border-radius:10px;padding:6px}
.si-chart__img{max-width:100%;height:auto;border-radius:6px}
.si-toolbar{display:flex;gap:.5rem;margin-top:.5rem}
.si-btn{padding:.25rem .65rem;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:transparent;color:inherit;cursor:pointer}
.si-btn.is-active{background:rgba(255,255,255,.09)}
</style>

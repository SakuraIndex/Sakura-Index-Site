{%- comment -%}
  共通カード
  受け取り:
    id, flag, title, badge, desc
    stats_json (文字列)
    intraday_png, am_png (相対パス)
  期待 stats_json のキー（存在すれば使う）:
    - pct_intraday: 比率(=0.0123)または百分率(=1.23 も可)
    - delta_level: 補助 (scale: "percent" の場合あり)
    - scale: "percent" | 省略
  表示ルール:
    1) 基本は pct_intraday を採用
    2) なければ delta_level を採用
    3) 数値が 1 未満 → 百分率化（×100）
       数値が 1 以上 → そのまま（既に % と判断）
    4) 異常な値(絶対値 > 200)は N/A（安全弁）
{%- endcomment -%}

<style>
  .card{background:#0e1522;border:1px solid #1f2a40;border-radius:18px;padding:14px 16px}
  .card + .card{margin-top:0}
  .card__head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
  .left{display:flex;align-items:center;gap:8px}
  .flag{font-size:16px}
  .title{font-weight:700}
  .chip{font-size:11px;background:#0f1726;border:1px solid #1f2a40;color:#9fb5e4;border-radius:999px;padding:.2rem .5rem}
  .right{font-weight:800}
  .pct{color:#36d399}
  .pct.neg{color:#ff6b6b}
  .desc{color:#93a4c8;font-size:13px;margin-top:2px;margin-bottom:10px}
  .imgwrap{background:#0b1119;border:1px solid #1f2a40;border-radius:12px;padding:8px}
  .imgwrap img{display:block;width:100%;height:auto;border-radius:6px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{font-size:12px;color:#cdddff;background:#0f1726;border:1px solid #1f2a40;padding:.35rem .6rem;border-radius:999px}
  .tab.active{outline:2px solid #233252}
</style>

{%- assign raw = include.stats_json | strip_newlines -%}

{%- comment -%} JSON 文字列から値を緩やかに抽出 {%- endcomment -%}
{%- assign pct_val = "" -%}
{%- assign delta_val = "" -%}
{%- assign scale_val = "" -%}

{%- if raw contains '"pct_intraday"' -%}
  {%- assign tmp = raw | split:'"pct_intraday"' | last -%}
  {%- assign tmp = tmp | split:':' | last | split:',' | first -%}
  {%- assign pct_val = tmp | replace:'"','' | replace:'%','' | strip -%}
{%- endif -%}

{%- if raw contains '"delta_level"' -%}
  {%- assign tmp = raw | split:'"delta_level"' | last -%}
  {%- assign tmp = tmp | split:':' | last | split:',' | first -%}
  {%- assign delta_val = tmp | replace:'"','' | replace:'%','' | strip -%}
{%- endif -%}

{%- if raw contains '"scale"' -%}
  {%- assign tmp = raw | split:'"scale"' | last -%}
  {%- assign tmp = tmp | split:':' | last | split:',' | first -%}
  {%- assign scale_val = tmp | replace:'"','' | strip -%}
{%- endif -%}

{%- comment -%} 数値化 + 百分率/比率の自動判定 {%- endcomment -%}
{%- assign show_val = pct_val -%}
{%- if show_val == "" -%}{%- assign show_val = delta_val -%}{%- endif -%}

{%- assign n = 0.0 -%}
{%- if show_val != "" -%}
  {%- assign n = show_val | plus: 0 -%}
  {%- if scale_val == "percent" -%}
    {%- assign n = n -%} {# すでに%想定 #}
  {%- else -%}
    {%- if n < 1 and n > -1 -%}{%- assign n = n | times: 100 -%}{%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- assign display = "N/A" -%}
{%- if show_val != "" and n < 200 and n > -200 -%}
  {%- assign s = n | round: 2 -%}
  {%- if s > 0 -%}{%- assign display = "+" | append: s | append: "%" -%}
  {%- elsif s < 0 -%}{%- assign display = s | append: "%" -%}
  {%- else -%}{%- assign display = "+0.00%" -%}{%- endif -%}
{%- endif -%}

<div class="card">
  <div class="card__head">
    <div class="left">
      <span class="flag">{{ include.flag }}</span>
      <span class="title">{{ include.title }}</span>
      <span class="chip">{{ include.badge }}</span>
    </div>
    <div class="right">
      {%- if display == "N/A" -%}
        <span class="pct">N/A</span>
      {%- else -%}
        {%- assign sign = n | plus: 0 -%}
        <span class="pct{% if sign < 0 %} neg{% endif %}">{{ display }}</span>
      {%- endif -%}
    </div>
  </div>

  <div class="desc">{{ include.desc }}</div>

  <div class="imgwrap">
    <img
      src="{{ include.intraday_png | relative_url }}"
      alt="{{ include.id }} chart"
      loading="lazy"
      decoding="async"
      onerror="this.onerror=null;this.src='{{ include.am_png | relative_url }}';">
  </div>

  <div class="tabs" aria-hidden="true">
    <span class="tab active">Intraday</span>
    <span class="tab">前場(AM)</span>
    <span class="tab">7日</span>
    <span class="tab">1ヶ月</span>
    <span class="tab">1年</span>
  </div>
</div>

{%- comment -%}
  æ±ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ï¼ˆstats.json å¯¾å¿œï¼‰
  å—ã‘å–ã‚Šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
    - id              : ä¾‹ "ASTRA4"
    - title           : è¡¨ç¤ºå
    - badge           : å°ãƒãƒƒã‚¸
    - desc            : èª¬æ˜æ–‡
    - stats_json      : capture ã§å–ã‚Šè¾¼ã‚“ã  stats.json ã®æ–‡å­—åˆ—
    - intraday_png    : /charts/<id>/intraday.png
    - am_png          : /charts/<id>/intraday_am.png
    - d7_png          : ä»»æ„ï¼ˆ7æ—¥ãƒãƒ£ãƒ¼ãƒˆï¼‰
    - m1_png          : ä»»æ„ï¼ˆ1ãƒ¶æœˆãƒãƒ£ãƒ¼ãƒˆï¼‰
    - y1_png          : ä»»æ„ï¼ˆ1å¹´ãƒãƒ£ãƒ¼ãƒˆï¼‰
    - flag            : ä¾‹ "ğŸ‡¯ğŸ‡µ"
{%- endcomment -%}

{%- assign _raw = include.stats_json | strip_newlines -%}

{%- comment -%}
  1) å€¤ã®æŠ½å‡º
     - pct_intraday ãŒæœ€å„ªå…ˆ
     - ç„¡ã‘ã‚Œã° delta_level ã‚’ä½¿ç”¨
     - scale ãŒç„¡ã„/ä¸æ˜ãªå ´åˆã«å‚™ãˆã¦ **è‡ªå‹•æ¨å®š** ã‚’å…¥ã‚Œã‚‹
{%- endcomment -%}

{%- assign pct_num = nil -%}
{%- assign scale = nil -%}
{%- assign basis = nil -%}

{%- if _raw != "" and _raw != nil -%}
  {%- comment -%} å€¤å€™è£œ {%- endcomment -%}
  {%- assign _pct_try = _raw | split:'"pct_intraday":' | last | split:',' | first | replace:'}','' | strip -%}
  {%- assign _pct_is_num = _pct_try | plus: 0 -%}

  {%- assign _delta_try = _raw | split:'"delta_level":' | last | split:',' | first | replace:'}','' | strip -%}
  {%- assign _delta_is_num = _delta_try | plus: 0 -%}

  {%- comment -%} scale / basis {%- endcomment -%}
  {%- assign _scale_raw = _raw | split:'"scale":' | last | split:',' | first | replace:'"','' | replace:'}','' | strip -%}
  {%- if _scale_raw == _raw or _scale_raw == "" -%}
    {%- assign scale = nil -%}
  {%- else -%}
    {%- assign scale = _scale_raw -%}
  {%- endif -%}

  {%- assign basis = _raw | split:'"basis":' | last | split:',' | first | replace:'"','' | replace:'}','' | strip -%}

  {%- comment -%} ã©ã¡ã‚‰ã®å€¤ã‚’ä½¿ã†ã‹ {%- endcomment -%}
  {%- if _pct_try != _raw and _pct_try != "" -%}
    {%- assign raw_value = _pct_is_num -%}
  {%- elsif _delta_try != _raw and _delta_try != "" -%}
    {%- assign raw_value = _delta_is_num -%}
  {%- else -%}
    {%- assign raw_value = nil -%}
  {%- endif -%}

  {%- comment -%}
    2) ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆåŒ–
       - scale == "ratio"      â†’ 100 å€
       - scale == "percent"    â†’ ãã®ã¾ã¾
       - scale ãŒç„¡ã„/ä¸æ˜     â†’ |å€¤| < 0.5 ã‚’ ratio ã¨ã¿ãªã— 100 å€ã€ãã†ã§ãªã‘ã‚Œã° percent
  {%- endcomment -%}
  {%- if raw_value != nil -%}
    {%- assign absval = raw_value | abs -%}
    {%- if scale == 'ratio' or (scale == nil and absval < 0.5) -%}
      {%- assign pct_num = raw_value | times: 100 -%}
    {%- else -%}
      {%- assign pct_num = raw_value -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} è¡¨ç¤ºç”¨ã®æˆå½¢ {%- endcomment -%}
{%- if pct_num == nil -%}
  {%- assign pct_text = 'N/A' -%}
  {%- assign pct_class = 'pct-na' -%}
{%- else -%}
  {%- assign rounded = pct_num | round: 2 -%}
  {%- if rounded > 0 -%}
    {%- assign pct_text = '+' | append: rounded | append: '%' -%}
    {%- assign pct_class = 'pct-up' -%}
  {%- elsif rounded < 0 -%}
    {%- assign pct_text = rounded | append: '%' -%}
    {%- assign pct_class = 'pct-down' -%}
  {%- else -%}
    {%- assign pct_text = '0%' -%}
    {%- assign pct_class = 'pct-zero' -%}
  {%- endif -%}
{%- endif -%}

<div class="card">
  <div class="card-hd">
    <div class="title">
      <span class="flag">{{ include.flag | default: '' }}</span>
      <span class="name">{{ include.title }}</span>
      {% if include.badge %}<span class="badge">{{ include.badge }}</span>{% endif %}
    </div>
    <div class="pct {{ pct_class }}">{{ pct_text }}</div>
  </div>

  {% if include.desc %}
  <p class="desc">{{ include.desc }}</p>
  {% endif %}

  <div class="chart-wrap">
    <img class="chart" src="{{ include.intraday_png }}" alt="{{ include.id }} chart">
  </div>

  <div class="btns">
    <span class="btn btn-active">Intraday</span>
    <span class="btn">å‰å ´(AM)</span>
    <span class="btn">7æ—¥</span>
    <span class="btn">1ãƒ¶æœˆ</span>
    <span class="btn">1å¹´</span>
  </div>
</div>

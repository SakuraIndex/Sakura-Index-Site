{%- comment -%}
共通インデックスカード（stats.json に対応）
引数:
  id, title, flag, badge, desc,
  stats_json, intraday_png, am_png (省略可)
{%- endcomment -%}

{%- assign _stats_raw = '' -%}
{%- capture _stats_raw -%}{% include_relative {{ include.stats_json }} %}{%- endcapture -%}

{%- assign stats = nil -%}
{%- if _stats_raw and _stats_raw != '' and _stats_raw != '---' -%}
  {%- assign stats = _stats_raw | strip_newlines | replace: ' ', '' | jsonify | parse_json -%}
{%- endif -%}

{%- comment -%} 騰落率の抽出ロジック {%- endcomment -%}
{%- assign pct_source = 0 -%}
{%- assign scale = 'percent' -%}
{%- if stats -%}
  {%- if stats.pct_intraday != nil -%}
    {%- assign pct_source = stats.pct_intraday -%}
  {%- elsif stats.delta_level != nil -%}
    {%- assign pct_source = stats.delta_level -%}
  {%- endif -%}
  {%- if stats.scale != nil and stats.scale != '' -%}
    {%- assign scale = stats.scale | downcase -%}
  {%- endif -%}
{%- endif -%}

{%- assign pct_num = pct_source | plus: 0 -%}
{%- if scale == 'ratio' or scale == 'fraction' -%}
  {%- assign pct_num = pct_num | times: 100 -%}
{%- endif -%}

{%- assign pct_text = 'N/A' -%}
{%- if pct_source != nil -%}
  {%- assign sgn = '' -%}
  {%- if pct_num > 0 -%}{%- assign sgn = '+' -%}{%- endif -%}
  {%- assign pct_text = sgn | append: (pct_num | round: 2) | append: '%' -%}
{%- endif -%}

{%- comment -%} ステータス色 {%- endcomment -%}
{%- assign pill_cls = 'text-slate-300' -%}
{%- if pct_source != nil -%}
  {%- if pct_num > 0 -%}{%- assign pill_cls = 'text-emerald-400' -%}
  {%- elsif pct_num < 0 -%}{%- assign pill_cls = 'text-rose-400' -%}{%- endif -%}
{%- endif -%}

<div class="card">
  <div class="card__head">
    <div class="card__title">
      <span class="mr-2">{{ include.flag }}</span>
      <span class="font-semibold">{{ include.title }}</span>
      {%- if include.badge and include.badge != '' -%}
        <span class="badge">{{ include.badge }}</span>
      {%- endif -%}
    </div>
    <div class="card__pct {{ pill_cls }}">{{ pct_text }}</div>
  </div>

  <p class="card__desc">{{ include.desc }}</p>

  <div class="chartbox">
    {%- if include.intraday_png and include.intraday_png != '' -%}
      <img loading="lazy" src="{{ include.intraday_png }}" alt="{{ include.id }} chart">
    {%- else -%}
      <div class="chartbox__empty">chart (no image)</div>
    {%- endif -%}
  </div>

  <div class="card__btns">
    <button class="btn btn--on">Intraday</button>
    {%- if include.am_png and include.am_png != '' -%}
      <a class="btn" href="{{ include.am_png }}">前場(AM)</a>
    {%- else -%}
      <span class="btn btn--ghost">前場(AM)</span>
    {%- endif -%}
    <span class="btn">7日</span><span class="btn">1ヶ月</span><span class="btn">1年</span>
  </div>
</div>

<style>
/* ---- Card layout (同ファイル内で完結) ---- */
.card{display:flex;flex-direction:column;gap:.6rem;border:1px solid rgba(148,163,184,.15);background:rgba(2,6,23,.6);border-radius:14px;padding:14px}
.card__head{display:flex;justify-content:space-between;align-items:center}
.card__title{display:flex;align-items:center;gap:.5rem}
.badge{font-size:.72rem;padding:.12rem .5rem;border-radius:9999px;background:rgba(148,163,184,.15);color:#cbd5e1}
.card__pct{font-weight:700}
.card__desc{font-size:.86rem;color:#cbd5e1;line-height:1.4;margin:.1rem 0 .3rem}
.chartbox{position:relative; width:100%; aspect-ratio:16/9; border-radius:10px; overflow:hidden; background:rgba(148,163,184,.08)}
.chartbox > img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
.chartbox__empty{display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:#94a3b8;font-size:.9rem}
.card__btns{display:flex;gap:.5rem;margin-top:.2rem}
.btn{font-size:.78rem;padding:.25rem .7rem;border:1px solid rgba(148,163,184,.25);border-radius:9999px;color:#cbd5e1}
.btn--on{border-color:rgba(148,163,184,.5);background:rgba(148,163,184,.12)}
.btn--ghost{opacity:.45;border-style:dashed}
.text-emerald-400{color:#34d399}
.text-rose-400{color:#fb7185}
.text-slate-300{color:#cbd5e1}
</style>

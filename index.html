<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</title>
  <meta name="description" content="Astra4ãƒ»S-COIN+ãƒ»R-BANK9ãƒ»AIN-10 ã®4æŒ‡æ•°ã‚’1ç”»é¢ã§åŒæ™‚è¡¨ç¤ºã€‚æ™‚é–“è»¸ã‚’ä¸€æ‹¬åˆ‡æ›¿ã€‚">
  <style>
    :root{
      --bg:#0e1014; --panel:#171a22; --text:#e9ecf1; --muted:#a7afc0;
      --chip:#232838; --chip-active:#33405c; --ring:#384055; --accent:#79e3d6;
      --pink:#ff86b5; --up:#32e0cf; --down:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.6 ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic","Meiryo",sans-serif}
    header{padding:28px 20px 12px;text-align:center}
    h1{margin:0 0 8px;font-size:28px;font-weight:800;color:var(--pink)}
    .sub{color:var(--muted);font-size:14px}
    .headLinks{display:flex;gap:8px;justify-content:center;margin-top:10px}
    .headLinks a{padding:8px 12px;border-radius:10px;background:var(--chip);color:#fff;text-decoration:none;box-shadow:inset 0 0 0 1px var(--ring)}
    .toolbar{margin:18px auto 10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .chip{padding:8px 14px;border:none;border-radius:999px;background:var(--chip);color:var(--text);
      font-weight:600;box-shadow:inset 0 0 0 1px var(--ring);cursor:pointer;transition:.15s}
    .chip:hover{transform:translateY(-1px)}
    .chip.is-active{background:var(--chip-active);box-shadow:0 0 0 2px var(--accent) inset;color:#fff}
    .grid{width:min(1280px,92vw);margin:0 auto 28px;display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border-radius:16px;box-shadow:0 0 0 1px var(--ring);overflow:hidden;transition:box-shadow .2s}
    .card.up{box-shadow:0 0 0 2px var(--up)}
    .card.down{box-shadow:0 0 0 2px var(--down)}
    .card__head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--ring)}
    .title{display:flex;align-items:center;gap:10px;font-weight:800}
    .flag{font-size:18px}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#2a3044;color:#cdd7ff}
    .pngnote{color:var(--muted);font-size:12px}
    .delta{font-weight:700;margin-left:6px;font-variant-numeric:tabular-nums}
    .delta.up{color:var(--up)} .delta.down{color:var(--down)} .delta.flat{color:#9aa0a6}
    .imgWrap{position:relative;background:#0b0d12}
    .chart{display:block;width:100%;aspect-ratio:16/9;object-fit:contain}
    .nodata{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#91a0c4;font-weight:700;opacity:0}
    .imgWrap.is-error .nodata{opacity:1}
    .timestamp{text-align:right;font-size:12px;color:var(--muted);padding:6px 10px 10px;border-top:1px solid var(--ring)}
    footer{padding:20px 12px 28px;text-align:center;color:var(--muted);font-size:13px}
    .disclaimer{margin-top:10px;font-size:13px;color:#ffb2b2}
    a{color:#a7dfff}
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</h1>
    <div class="sub">Astra4ãƒ»S-COIN+ãƒ»R-BANK9ãƒ»AIN-10 ã‚’åŒæ™‚è¡¨ç¤ºã€‚æ™‚é–“è»¸ã‚’ä¸€æ‹¬ã§åˆ‡æ›¿ã§ãã¾ã™ã€‚</div>
    <div class="headLinks">
      <a href="https://twitter.com/SakuraIndex" target="_blank" rel="noreferrer noopener">å…¬å¼Xï¼ˆTwitterï¼‰</a>
      <a href="https://note.com/sakuraindex" target="_blank" rel="noreferrer noopener">å…¬å¼note</a>
    </div>
    <div class="toolbar" id="tfToolbar">
      <button class="chip is-active" data-tf="1d">1æ—¥</button>
      <button class="chip" data-tf="7d">1é€±é–“</button>
      <button class="chip" data-tf="1m">1ãƒ¶æœˆ</button>
      <button class="chip" data-tf="1y">1å¹´</button>
    </div>
  </header>

  <main class="grid">
    <section class="card" data-prefix="astra4">
      <div class="card__head">
        <div class="title"><span class="flag">ğŸ‡¯ğŸ‡µ</span>Astra4<span class="badge">å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼</span><span id="delta-astra4" class="delta flat">â€”</span></div>
        <div class="pngnote">PNGã‚’é™çš„è¡¨ç¤º</div>
      </div>
      <div class="imgWrap"><img class="chart" alt="Astra4 chart"><div class="nodata">No data</div></div>
      <div class="timestamp">æœ€çµ‚æ›´æ–°ï¼šèª­è¾¼ä¸­...</div>
    </section>

    <section class="card" data-prefix="scoin_plus">
      <div class="card__head">
        <div class="title"><span class="flag">ğŸ‡¯ğŸ‡µ</span>S-COIN+<span class="badge">ä»®æƒ³é€šè²¨</span><span id="delta-scoin" class="delta flat">â€”</span></div>
        <div class="pngnote">PNGã‚’é™çš„è¡¨ç¤º</div>
      </div>
      <div class="imgWrap"><img class="chart" alt="S-COIN+ chart"><div class="nodata">No data</div></div>
      <div class="timestamp">æœ€çµ‚æ›´æ–°ï¼šèª­è¾¼ä¸­...</div>
    </section>

    <section class="card" data-prefix="rbank9">
      <div class="card__head">
        <div class="title"><span class="flag">ğŸ‡¯ğŸ‡µ</span>R-BANK9<span class="badge">åœ°æ–¹éŠ€è¡Œ</span><span id="delta-rbank9" class="delta flat">â€”</span></div>
        <div class="pngnote">PNGã‚’é™çš„è¡¨ç¤º</div>
      </div>
      <div class="imgWrap"><img class="chart" alt="R-BANK9 chart"><div class="nodata">No data</div></div>
      <div class="timestamp">æœ€çµ‚æ›´æ–°ï¼šèª­è¾¼ä¸­...</div>
    </section>

    <section class="card" data-prefix="ain10">
      <div class="card__head">
        <div class="title"><span class="flag">ğŸ‡ºğŸ‡¸</span>AIN-10<span class="badge">AIé–¢é€£10</span><span id="delta-ain10" class="delta flat">â€”</span></div>
        <div class="pngnote">PNGã‚’é™çš„è¡¨ç¤º</div>
      </div>
      <div class="imgWrap"><img class="chart" alt="AIN-10 chart"><div class="nodata">No data</div></div>
      <div class="timestamp">æœ€çµ‚æ›´æ–°ï¼šèª­è¾¼ä¸­...</div>
    </section>
  </main>

  <footer>
    ãƒ‡ãƒ¼ã‚¿ï¼šç­‰åŠ é‡æŒ‡æ•°ï¼ˆè©³ç´°ã¯å„ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰<br>Â© 2025 æ¡œIndex
    <div class="disclaimer">â€» æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ï¼ˆè‡ªå·±è²¬ä»»ï¼‰ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</div>
  </footer>

  <script>
    // ===== åŸºæœ¬è¨­å®š =====
    const ASSET_BASE = "docs/charts";
    const DEFAULT_TF = "1d";
    const cacheBust = () => new Date().toISOString().replace(/\D/g,"").slice(0,14);
    const png = (p,tf)=>`${ASSET_BASE}/${p}_${tf}.png?v=${cacheBust()}`;

    function updateImages(tf){
      document.querySelectorAll(".card").forEach(card=>{
        const p = card.dataset.prefix;
        const img = card.querySelector("img.chart");
        const wrap = card.querySelector(".imgWrap");
        const ts = card.querySelector(".timestamp");
        wrap.classList.remove("is-error");
        img.onerror = ()=>{ wrap.classList.add("is-error"); ts.textContent="æœ€çµ‚æ›´æ–°ï¼šãƒ‡ãƒ¼ã‚¿ãªã—"; };
        img.onload  = ()=>{ const j = new Date(Date.now()+9*3600e3);
          ts.textContent=`æœ€çµ‚æ›´æ–°ï¼š${j.toISOString().slice(0,16).replace("T"," ")}`; };
        img.src = png(p, tf);
      });
    }

    let currentTf = DEFAULT_TF;
    updateImages(currentTf);
    document.getElementById("tfToolbar").addEventListener("click",(e)=>{
      const b = e.target.closest("button[data-tf]");
      if(!b) return;
      document.querySelectorAll(".chip").forEach(x=>x.classList.toggle("is-active", x===b));
      currentTf = b.dataset.tf;
      updateImages(currentTf);
    });

    // ========= %ç®—å‡ºï¼ˆTXT -> intraday.csvå†è¨ˆç®—ï¼‰ =========
    (async function computeDeltas(){
      const series = [
        {key:"astra4",     txt:["astra4_post_intraday.txt","astra4_latest.txt","astra4_post.txt"], history:"astra4_history.csv",   slot:"delta-astra4", tz:"Asia/Tokyo",  type:"session"},
        {key:"scoin_plus", txt:["scoin_plus_post_intraday.txt","scoin_plus_post.txt","scoin_plus_latest.txt"], history:"scoin_plus_history.csv", slot:"delta-scoin",  tz:"UTC",         type:"rolling24"},
        {key:"rbank9",     txt:["rbank9_post_intraday.txt","rbank9_latest.txt","rbank9_post.txt"], history:"rbank9_history.csv",   slot:"delta-rbank9", tz:"Asia/Tokyo",  type:"session"},
        {key:"ain10",      txt:["ain10_post_intraday.txt","ain10_latest.txt","ain10_post.txt"],    history:"ain10_history.csv",    slot:"delta-ain10", tz:"America/New_York", type:"sessionUS"},
      ];
      const CAP = 120;     // 120%ã‚’è¶…ãˆã‚‹ã®ã¯ç•°å¸¸æ‰±ã„
      const MIN_DEN = 1e-9;

      async function fetchText(path){
        const url = `${ASSET_BASE}/${path}?v=${cacheBust()}`;
        const r = await fetch(url, {cache:"no-store"}); if(!r.ok) throw 0; return await r.text();
      }
      function pickPctFromText(txt){
        const m = txt.match(/[+\-]?\d+(?:\.\d+)?\s*%/); if(!m) return null;
        const v = parseFloat(m[0].replace("%","")); return Number.isFinite(v)?v:null;
      }
      function fmtDelta(p){ const s = (p>=0?"+":"") + p.toFixed(2) + "%"; return s; }

      // --- intraday.csv ã‹ã‚‰å …ç‰¢ã«å†è¨ˆç®— ---
      function parseCsv(text){
        const lines = text.trim().split(/\r?\n/); if(lines.length<=1) return [];
        const hdr = lines[0].split(",").map(s=>s.trim().toLowerCase());
        const ti = hdr.findIndex(h=>/time|date|datetime|æ—¥æ™‚/.test(h));
        let vi = -1;
        for(let i=0;i<hdr.length;i++){
          if(i===ti) continue;
          const h = hdr[i];
          if(/mean|value|index|score/i.test(h)){ vi=i; break; }
        }
        if(vi<0){ vi = hdr.length-1; if(vi===ti && hdr.length>=2) vi=1; }
        const rows = [];
        for(let i=1;i<lines.length;i++){
          const c = lines[i].split(","); if(c.length<=Math.max(ti,vi)) continue;
          const t = new Date(c[ti]); const v = parseFloat(c[vi]);
          if(!Number.isFinite(v) || isNaN(t.getTime())) continue;
          rows.push({t,v});
        }
        rows.sort((a,b)=>a.t-b.t);
        return rows;
      }
      function windowFilter(rows, kind){
        const now = new Date();
        const jst = new Date(now.getTime()+9*3600e3);
        if(kind==="rolling24"){
          const from = new Date(now.getTime()-24*3600e3);
          return rows.filter(r=>r.t>=from && r.t<=now);
        }
        // æ±äº¬ã‚»ãƒƒã‚·ãƒ§ãƒ³ 09:00â€“15:30
        if(kind==="session"||kind==="sessionUS"){
          // JSTã‹USã§ã‚‚ã€CSVã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯ISOãªã‚‰UTCæ‰±ã„ã§OKã€‚æ™‚é–“å¸¯å¢ƒç•Œã¯ JST/NY ã®æ™‚åˆ»ã§æ¯”è¼ƒã—ãŸã„ãŒã€
          // ã‚µã‚¤ãƒˆå´ã§ã¯è¿‘ä¼¼ã¨ã—ã¦ JST ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼ˆAIN-10ã¯historyä»£æ›¿ã«è½ã¡ã‚‹ã“ã¨ãŒå¤šã„ï¼‰ã€‚
          const base = jst; // è¿‘ä¼¼
          const day = new Date(base.getFullYear(), base.getMonth(), base.getDate());
          const start = new Date(day.getTime() + 9*3600e3);               // 09:00 JST
          const end   = new Date(day.getTime() + 15*3600e3 + 30*60e3);    // 15:30 JST
          let win = rows.filter(r=>r.t>=start && r.t<=end);
          if(win.length===0){
            // å‰æ—¥
            const y = new Date(day.getTime()-24*3600e3);
            const s2 = new Date(y.getTime() + 9*3600e3);
            const e2 = new Date(y.getTime() + 15*3600e3 + 30*60e3);
            win = rows.filter(r=>r.t>=s2 && r.t<=e2);
          }
          return win;
        }
        return rows;
      }
      function toFrac(x){
        // è¿”ã‚Šå€¤ï¼šå°æ•°ã®å¤‰åŒ–ç‡ r ï¼ˆä¾‹: 1% -> 0.01ï¼‰
        if(!Number.isFinite(x)) return 0;
        const ax = Math.abs(x);
        // ãƒãƒ¼å€¤ãŒ % ãƒã‚¤ãƒ³ãƒˆï¼ˆÂ±1.2 ãªã©ï¼‰ã£ã½ã„ â†’ 100 ã§å‰²ã‚‹
        if(ax > 0.5) return x/100;
        return x; // ã™ã§ã«å°æ•°ï¼ˆ0.002 ãªã©ï¼‰
      }
      function pctFromIntraday(rows){
        if(rows.length<2) return null;
        // 1) ç©ä¸Šã’ï¼ˆå¤‰åŒ–ç‡ç³»åˆ—ã¨ä»®å®šï¼‰
        let prod = 1;
        for(const r of rows){ prod *= (1 + toFrac(r.v)); if(!Number.isFinite(prod)) return null; }
        const pMul = (prod - 1) * 100;

        // 2) ãƒ¬ãƒ™ãƒ«å€¤ã¨ä»®å®š
        const first = rows[0].v, last = rows[rows.length-1].v;
        const pLvl = (Math.abs(first) < MIN_DEN) ? null : ((last/first - 1) * 100);

        // ã©ã¡ã‚‰ã‚’æ¡ç”¨ï¼Ÿï¼ˆã‚ˆã‚Šå¸¸è­˜çš„ãªæ–¹ï¼‰
        const okMul = Number.isFinite(pMul) && Math.abs(pMul) <= CAP;
        const okLvl = Number.isFinite(pLvl) && Math.abs(pLvl) <= CAP;
        if(okMul && !okLvl) return pMul;
        if(okLvl && !okMul) return pLvl;
        if(okMul && okLvl) return Math.abs(pMul) <= Math.abs(pLvl) ? pMul : pLvl;
        return null;
      }

      for(const s of series){
        const el = document.getElementById(s.slot);
        const card = document.querySelector(`.card[data-prefix="${s.key}"]`);
        el.className = "delta"; // reset
        card.classList.remove("up","down");

        let delta = null;

        // 1) TXTï¼ˆç¢ºå®šå€¤ï¼‰å„ªå…ˆ
        for(const f of s.txt){ try{
          const t = await fetchText(f);
          const p = pickPctFromText(t);
          if(p!==null && Math.abs(p) <= CAP){ delta = p; break; }
        }catch(_){/* next */} }

        // 2) intraday.csv ã‹ã‚‰å†è¨ˆç®—ï¼ˆTXTãŒç„¡ã„/ç•°å¸¸ã®ã¨ãï¼‰
        if(delta === null){
          try{
            const csv = await fetchText(`${s.key}_intraday.csv`);
            const rows = parseCsv(csv);
            const win = windowFilter(rows, s.type);
            const p = pctFromIntraday(win);
            if(p!==null) delta = p;
          }catch(_){}
        }

        // 3) history.csv ç›´è¿‘2æ—¥ï¼ˆæœ€å¾Œã®ç ¦ï¼‰
        if(delta === null){
          try{
            const h = await fetchText(s.history);
            const lines = h.trim().split(/\r?\n/); if(lines.length>=3){
              const a = parseFloat(lines[lines.length-1].split(",")[1]);
              const b = parseFloat(lines[lines.length-2].split(",")[1]);
              if(Number.isFinite(a) && Number.isFinite(b) && Math.abs(b)>MIN_DEN){
                const p = ((a-b)/Math.abs(b))*100; if(Math.abs(p)<=CAP) delta = p;
              }
            }
          }catch(_){}
        }

        if(delta === null){
          el.textContent = "â€”";
          el.classList.add("flat");
        }else{
          el.textContent = fmtDelta(delta);
          if(delta > 0){ el.classList.add("up"); card.classList.add("up"); }
          else if(delta < 0){ el.classList.add("down"); card.classList.add("down"); }
          else { el.classList.add("flat"); }
        }
      }
    })();
  </script>
</body>
</html>

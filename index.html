<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🌸 桜Index - 公式サイト</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/cherry-blossom.svg" />
  <style>
    :root {
      --bg: #0d0d0f;
      --card: #1a1a1f;
      --axis: #0b0c10;
      --text: #ddd;
      --muted: #aaa;
      --pos: #28e07c;
      --neg: #ff4d4d;
      --chip: #333;
      --tab: #26262c;
      --tab-active: #3a3a44;
    }
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter','Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif;
      margin: 0;
    }
    header { text-align: center; padding: 20px 0; }
    h1 { font-size: 1.8rem; margin: 0 0 8px; }
    .info { font-size: 0.9rem; color: var(--muted); margin-bottom: 12px; }
    .links { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; }
    .links a {
      background: var(--chip); color: #fff; text-decoration: none;
      padding: 8px 14px; border-radius: 8px; font-size: 0.9rem;
      transition: background 0.2s;
    }
    .links a:hover { background: #444; }

    .container { max-width: 1280px; margin: 0 auto; padding: 0 28px 28px; }

    .section-title { font-size: 1.2rem; font-weight: 700; margin: 24px 0 12px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(420px, 1fr));
      gap: 24px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 0 12px rgba(255,255,255,0.05);
      display: flex; flex-direction: column; gap: 12px;
    }
    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .title { display: flex; align-items: center; gap: 8px; font-weight: 700; }
    .category {
      font-size: 0.8rem; background: var(--chip); color: #ccc;
      padding: 2px 6px; border-radius: 6px;
    }
    .desc { font-size: 0.9rem; color: var(--muted); line-height: 1.6; }
    .percent { font-weight: 700; white-space: nowrap; }
    .percent.positive { color: var(--pos); }
    .percent.negative { color: var(--neg); }

    .chart {
      width: 100%;
      border-radius: 12px;
      background: var(--axis);
      overflow: hidden;
      display: flex; justify-content: center;
    }
    .chart img {
      width: 100%;
      display: block;
      background: var(--axis);
    }

    .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .tab {
      border: none; cursor: pointer; color: #ddd;
      background: var(--tab); padding: 6px 10px; border-radius: 10px;
      font-size: 0.85rem;
    }
    .tab.active { background: var(--tab-active); }

    .empty { color: var(--muted); font-size: 0.9rem; }

    footer {
      text-align: center; font-size: 0.8rem; color: #888;
      margin-top: 8px; padding-bottom: 20px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>🌸 桜Index - 公式サイト</h1>
    <div class="info" id="sync-info">同期完了: ロード中...</div>
    <div class="links">
      <a href="https://x.com/Sakura_Index" target="_blank" rel="noopener noreferrer">公式X（Twitter）</a>
      <a href="https://note.com/sakura_index" target="_blank" rel="noopener noreferrer">公式note</a>
    </div>
  </header>

  <div class="container">
    <!-- 1) 日本株 前場スナップ -->
    <div class="section-title">前場スナップ（日本株）</div>
    <div class="grid" id="am-grid"></div>
    <div id="am-empty" class="empty" style="display:none;">現在、前場スナップ（intraday_am.png）がありません。</div>

    <!-- 2) 全指数（説明 + タブで長期切替） -->
    <div class="section-title">全指数</div>
    <main class="grid" id="cards-grid"></main>
  </div>

  <footer>
    データ：等加重指数（仕様は各リポジトリ参照） / 画像は各指数リポの自動生成スナップショットを同期しています。<br/>
    ※本サイトは投資助言ではありません。投資判断はご自身の責任（自己責任）でお願いします。<br/>
    © 2025 桜Index
  </footer>

  <script>
    // メタ定義の場所
    const INDEX_JSON = 'data/indexes.json';

    // 画像の存在確認（HEAD）
    async function imgExists(url) {
      try {
        const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
        return res.ok;
      } catch { return false; }
    }

    // 任意: charts/<key>/stats.json があれば%を表示（無ければN/A）
    async function fetchPct(key) {
      const url = `charts/${encodeURIComponent(key)}/stats.json`;
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (res.ok) {
          const js = await res.json();
          const p = js.pct_intraday ?? js.pct_1d ?? null;
          return (typeof p === 'number') ? p : null;
        }
      } catch {}
      return null;
    }
    function fmtPct(v){
      if (v === null || isNaN(v)) return 'N/A';
      const s = (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
      return s;
    }

    // カード生成
    function makeCard(meta) {
      const key = meta.key;
      const base = `charts/${encodeURIComponent(key)}`;
      const tabs = [
        { id:'intraday', label:'Intraday', file:'intraday.png' },
        { id:'am',       label:'前場(AM)', file:'intraday_am.png' },
        { id:'7d',       label:'7日',      file:'7d.png' },
        { id:'1m',       label:'1ヶ月',    file:'1m.png' },
        { id:'1y',       label:'1年',      file:'1y.png' },
      ];

      const root = document.createElement('div');
      root.className = 'card';

      const header = document.createElement('div');
      header.className = 'card-header';
      header.innerHTML =
        `<div class="title">${meta.flag || ''} ${meta.label} <span class="category">${meta.category || ''}</span></div>
         <div class="percent" id="pct-${key}">N/A</div>`;
      root.appendChild(header);

      if (meta.description) {
        const desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = meta.description;
        root.appendChild(desc);
      }

      const imgWrap = document.createElement('div');
      imgWrap.className = 'chart';
      const img = document.createElement('img');
      img.alt = `${meta.label} chart`;
      imgWrap.appendChild(img);
      root.appendChild(imgWrap);

      const tabsWrap = document.createElement('div');
      tabsWrap.className = 'tabs';
      root.appendChild(tabsWrap);

      const state = { active: 'intraday' };

      const setActive = async (id) => {
        state.active = id;
        [...tabsWrap.children].forEach(b => b.classList.toggle('active', b.dataset.id === id));
        const t = tabs.find(x => x.id === id);
        const url = `${base}/${t.file}`;
        if (await imgExists(url)) {
          img.src = `${url}?t=${Date.now()}`;
          img.style.display = 'block';
        } else {
          img.style.display = 'none';
        }
      };

      (async () => {
        // タブ描画
        for (const t of tabs) {
          const b = document.createElement('button');
          b.className = 'tab';
          b.textContent = t.label;
          b.dataset.id = t.id;
          b.onclick = () => setActive(t.id);
          tabsWrap.appendChild(b);
        }
        // 初期表示: Intraday→7d→1m→1y→AM の順に存在チェック
        const order = ['intraday','7d','1m','1y','am'];
        for (const id of order) {
          const tf = tabs.find(x => x.id === id);
          if (tf && await imgExists(`${base}/${tf.file}`)) { await setActive(id); break; }
        }
        // % 表示（任意）
        const pct = await fetchPct(key);
        const el = document.getElementById(`pct-${key}`);
        if (el) {
          el.textContent = fmtPct(pct);
          if (pct !== null) el.classList.add(pct >= 0 ? 'positive' : 'negative');
        }
      })();

      return root;
    }

    (async () => {
      // 同期時刻
      const syncInfo  = document.getElementById('sync-info');
      syncInfo.textContent =
        `同期完了: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo', hour12:false })} / データ: charts/*`;

      // メタ読み込み
      const res = await fetch(INDEX_JSON, { cache:'no-store' });
      const list = await res.json();

      // 1) 日本株 前場スナップ
      const amWrap = document.getElementById('am-grid');
      let amCount = 0;
      for (const m of list.filter(x => x.market === 'JP')) {
        const amUrl = `charts/${encodeURIComponent(m.key)}/intraday_am.png`;
        if (await imgExists(amUrl)) {
          const box = document.createElement('div');
          box.className = 'card';
          box.innerHTML = `
            <div class="title" style="margin-bottom:8px;">${m.flag || ''} ${m.label}
              <span class="category">${m.category || ''}</span>
            </div>
            <div class="chart"><img src="${amUrl}?t=${Date.now()}" alt="${m.label} AM snapshot"/></div>
            <div class="desc" style="font-size:.8rem;">前場スナップ（11:35 JST）</div>
          `;
          amWrap.appendChild(box);
          amCount++;
        }
      }
      if (amCount === 0) document.getElementById('am-empty').style.display = 'block';

      // 2) 全指数カード
      const grid = document.getElementById('cards-grid');
      for (const m of list) grid.appendChild(makeCard(m));
    })();
  </script>
</body>
</html>

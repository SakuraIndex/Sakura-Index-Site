<!-- ① カードの HTML（既存のカードをこれに置き換え or data-key だけ追記） -->
<section class="sx-grid">
  <!-- Astra4 -->
  <article class="sx-card" data-key="astra4" data-title="Astra4" data-badge="宇宙ベンチャー"
           data-desc="宇宙関連銘柄の等ウェイト指数。可視化はボラティリティに配慮。">
    <header class="sx-hd">
      <div class="sx-title">
        <span class="sx-flag">🇯🇵</span><h3>Astra4</h3>
        <span class="sx-badge">宇宙ベンチャー</span>
      </div>
      <div class="sx-delta" data-delta> N/A </div>
    </header>
    <p class="sx-desc">宇宙関連銘柄の等ウェイト指数。可視化はボラティリティに配慮。</p>
    <div class="sx-chart">
      <img data-img alt="Astra4 chart" />
      <div class="sx-noimg" data-noimg hidden>画像が見つかりません</div>
    </div>
    <nav class="sx-tabs" role="tablist">
      <button class="active" data-variant="intraday">Intraday</button>
      <button data-variant="am">前場(AM)</button>
      <button data-variant="7d">7日</button>
      <button data-variant="1m">1ヶ月</button>
      <button data-variant="1y">1年</button>
    </nav>
  </article>

  <!-- R-BANK9 -->
  <article class="sx-card" data-key="rbank9" data-title="R-BANK9" data-badge="地方銀行"
           data-desc="地方銀行9銘柄の等ウェイト指数。日中は％、長期はレベル推移を表示。">
    <header class="sx-hd">
      <div class="sx-title">
        <span class="sx-flag">🇯🇵</span><h3>R-BANK9</h3>
        <span class="sx-badge">地方銀行</span>
      </div>
      <div class="sx-delta" data-delta> N/A </div>
    </header>
    <p class="sx-desc">地方銀行9銘柄の等ウェイト指数。日中は％、長期はレベル推移を表示。</p>
    <div class="sx-chart">
      <img data-img alt="R-BANK9 chart" />
      <div class="sx-noimg" data-noimg hidden>画像が見つかりません</div>
    </div>
    <nav class="sx-tabs" role="tablist">
      <button class="active" data-variant="intraday">Intraday</button>
      <button data-variant="am">前場(AM)</button>
      <button data-variant="7d">7日</button>
      <button data-variant="1m">1ヶ月</button>
      <button data-variant="1y">1年</button>
    </nav>
  </article>

  <!-- AIN-10 -->
  <article class="sx-card" data-key="ain10" data-title="AIN-10" data-badge="AI関連10"
           data-desc="米AI関連10銘柄の等ウェイト指数。短期モメンタム観測に便利。">
    <header class="sx-hd">
      <div class="sx-title">
        <span class="sx-flag">🇺🇸</span><h3>AIN-10</h3>
        <span class="sx-badge">AI関連10</span>
      </div>
      <div class="sx-delta" data-delta> N/A </div>
    </header>
    <p class="sx-desc">米AI関連10銘柄の等ウェイト指数。短期モメンタム観測に便利。</p>
    <div class="sx-chart">
      <img data-img alt="AIN-10 chart" />
      <div class="sx-noimg" data-noimg hidden>画像が見つかりません</div>
    </div>
    <nav class="sx-tabs" role="tablist">
      <button class="active" data-variant="intraday">Intraday</button>
      <button data-variant="am">前場(AM)</button>
      <button data-variant="7d">7日</button>
      <button data-variant="1m">1ヶ月</button>
      <button data-variant="1y">1年</button>
    </nav>
  </article>

  <!-- S-COIN+ -->
  <article class="sx-card" data-key="scoin_plus" data-title="S-COIN+" data-badge="仮想資産関連"
           data-desc="暗号資産関連の等ウェイト指数。日中は騰落率、長期はレベル推移を表示。">
    <header class="sx-hd">
      <div class="sx-title">
        <span class="sx-flag">🇯🇵</span><h3>S-COIN+</h3>
        <span class="sx-badge">仮想資産関連</span>
      </div>
      <div class="sx-delta" data-delta> N/A </div>
    </header>
    <p class="sx-desc">暗号資産関連の等ウェイト指数。日中は騰落率、長期はレベル推移を表示。</p>
    <div class="sx-chart">
      <img data-img alt="S-COIN+ chart" />
      <div class="sx-noimg" data-noimg hidden>画像が見つかりません</div>
    </div>
    <nav class="sx-tabs" role="tablist">
      <button class="active" data-variant="intraday">Intraday</button>
      <button data-variant="am">前場(AM)</button>
      <button data-variant="7d">7日</button>
      <button data-variant="1m">1ヶ月</button>
      <button data-variant="1y">1年</button>
    </nav>
  </article>
</section>

<!-- ② スタイル（衝突回避のため最小限） -->
<style>
  .sx-grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(460px,1fr))}
  .sx-card{background:#11151a;border:1px solid #202831;border-radius:16px;padding:16px}
  .sx-hd{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .sx-title{display:flex;align-items:center;gap:10px}
  .sx-flag{font-size:20px}
  .sx-badge{background:#1c2633;border:1px solid #2c3848;border-radius:999px;padding:2px 10px;font-size:12px}
  .sx-delta{min-width:88px;text-align:right;font-weight:700}
  .sx-delta.--up{color:#21d07a}.sx-delta.--down{color:#ff6b6b}.sx-delta.--na{color:#9aa4af}
  .sx-desc{opacity:.9;margin:.25rem 0 .75rem}
  .sx-chart{position:relative;border-radius:12px;background:#0c1116;border:1px solid #1c2430;min-height:280px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .sx-chart img{width:100%;height:auto;display:block;object-fit:contain}
  .sx-noimg{opacity:.75}
  .sx-tabs{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .sx-tabs button{background:#141b22;border:1px solid #243041;padding:8px 14px;border-radius:999px;cursor:pointer}
  .sx-tabs button.active{background:#1f2a38;border-color:#3a4a60}
  @media (max-width:540px){.sx-grid{grid-template-columns:1fr}}
</style>

<!-- ③ ロジック（全カード共通。CSV を読んで騰落率を正しく算出 & 画像/タブの自動切替） -->
<script>
(() => {
  /** ▼ リポ構成に依存しない「ゆるい」パスマップ
   *   それぞれ複数候補から存在するものを自動採用します
   *   画像: PNG / CSV: データ
   */
  const MAP = {
    astra4: {
      png: {
        intraday: ['docs/charts/astra4_intraday.png','charts/astra4_intraday.png','docs/outputs/astra4_intraday.png'],
        am:       ['docs/charts/astra4_am.png','charts/astra4_am.png','docs/outputs/astra4_am.png'],
        '7d':     ['docs/charts/astra4_7d.png','charts/astra4_7d.png'],
        '1m':     ['docs/charts/astra4_1m.png','charts/astra4_1m.png'],
        '1y':     ['docs/charts/astra4_1y.png','charts/astra4_1y.png'],
      },
      csv: {
        // intraday は「騰落率（％）」列がある CSV を優先、それが無ければ Close/PrevClose から算出
        intraday: ['docs/outputs/astra4_intraday.csv','docs/charts/astra4_intraday.csv','charts/astra4_intraday.csv'],
        am:       ['docs/outputs/astra4_am.csv','docs/charts/astra4_am.csv','charts/astra4_am.csv'],
        // 長期はレベル系列（index / level）から前日終値比を算出
        '7d':     ['docs/outputs/astra4_7d.csv','docs/charts/astra4_7d.csv','charts/astra4_7d.csv'],
        '1m':     ['docs/outputs/astra4_1m.csv','docs/charts/astra4_1m.csv','charts/astra4_1m.csv'],
        '1y':     ['docs/outputs/astra4_1y.csv','docs/charts/astra4_1y.csv','charts/astra4_1y.csv'],
      }
    },
    rbank9: {
      png: {
        intraday: ['docs/charts/rbank9_intraday.png','charts/rbank9_intraday.png','docs/outputs/rbank9_intraday.png'],
        am:       ['docs/charts/rbank9_am.png','charts/rbank9_am.png','docs/outputs/rbank9_am.png'],
        '7d':     ['docs/charts/rbank9_7d.png','charts/rbank9_7d.png'],
        '1m':     ['docs/charts/rbank9_1m.png','charts/rbank9_1m.png'],
        '1y':     ['docs/charts/rbank9_1y.png','charts/rbank9_1y.png'],
      },
      csv: {
        intraday: ['docs/outputs/rbank9_intraday.csv','docs/charts/rbank9_intraday.csv','charts/rbank9_intraday.csv'],
        am:       ['docs/outputs/rbank9_am.csv','docs/charts/rbank9_am.csv','charts/rbank9_am.csv'],
        '7d':     ['docs/outputs/rbank9_7d.csv','docs/charts/rbank9_7d.csv','charts/rbank9_7d.csv'],
        '1m':     ['docs/outputs/rbank9_1m.csv','docs/charts/rbank9_1m.csv','charts/rbank9_1m.csv'],
        '1y':     ['docs/outputs/rbank9_1y.csv','docs/charts/rbank9_1y.csv','charts/rbank9_1y.csv'],
      }
    },
    ain10: {
      png: {
        intraday: ['docs/charts/ain10_intraday.png','charts/ain10_intraday.png','docs/outputs/ain10_intraday.png'],
        am:       ['docs/charts/ain10_am.png','charts/ain10_am.png','docs/outputs/ain10_am.png'],
        '7d':     ['docs/charts/ain10_7d.png','charts/ain10_7d.png'],
        '1m':     ['docs/charts/ain10_1m.png','charts/ain10_1m.png'],
        '1y':     ['docs/charts/ain10_1y.png','charts/ain10_1y.png'],
      },
      csv: {
        intraday: ['docs/outputs/ain10_intraday.csv','docs/charts/ain10_intraday.csv','charts/ain10_intraday.csv'],
        am:       ['docs/outputs/ain10_am.csv','docs/charts/ain10_am.csv','charts/ain10_am.csv'],
        '7d':     ['docs/outputs/ain10_7d.csv','docs/charts/ain10_7d.csv','charts/ain10_7d.csv'],
        '1m':     ['docs/outputs/ain10_1m.csv','docs/charts/ain10_1m.csv','charts/ain10_1m.csv'],
        '1y':     ['docs/outputs/ain10_1y.csv','docs/charts/ain10_1y.csv','charts/ain10_1y.csv'],
      }
    },
    scoin_plus: {
      png: {
        intraday: ['docs/charts/scoin_plus_intraday.png','charts/scoin_plus_intraday.png','docs/outputs/s_coin_plus_intraday.png','docs/outputs/scoin_plus_intraday.png'],
        am:       ['docs/charts/scoin_plus_am.png','charts/scoin_plus_am.png'],
        '7d':     ['docs/charts/scoin_plus_7d.png','charts/scoin_plus_7d.png'],
        '1m':     ['docs/charts/scoin_plus_1m.png','charts/scoin_plus_1m.png'],
        '1y':     ['docs/charts/scoin_plus_1y.png','charts/scoin_plus_1y.png'],
      },
      csv: {
        intraday: ['docs/outputs/scoin_plus_intraday.csv','docs/charts/scoin_plus_intraday.csv','charts/scoin_plus_intraday.csv','docs/outputs/s_coin_plus_intraday.csv'],
        am:       ['docs/outputs/scoin_plus_am.csv','docs/charts/scoin_plus_am.csv','charts/scoin_plus_am.csv'],
        '7d':     ['docs/outputs/scoin_plus_7d.csv','docs/charts/scoin_plus_7d.csv','charts/scoin_plus_7d.csv'],
        '1m':     ['docs/outputs/scoin_plus_1m.csv','docs/charts/scoin_plus_1m.csv','charts/scoin_plus_1m.csv'],
        '1y':     ['docs/outputs/scoin_plus_1y.csv','docs/charts/scoin_plus_1y.csv','charts/scoin_plus_1y.csv'],
      }
    },
  };

  /** fetch できる最初のパスを返す */
  async function resolveFirstExists(paths){
    for(const p of paths){
      try { const r = await fetch(p, {method:'HEAD', cache:'no-store'}); if(r.ok) return p; } catch {}
    }
    return null;
  }

  /** CSV を読み、最終の騰落率（％）を返す。列名のゆらぎに強い */
  async function computeDeltaPercent(csvPath){
    if(!csvPath) return null;
    try{
      const text = await fetch(csvPath, {cache:'no-store'}).then(r=>r.ok?r.text():null);
      if(!text) return null;
      const rows = text.trim().split(/\r?\n/).map(l=>l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
      const headers = rows[0].map(h=>h.replace(/^"|"$/g,'').trim().toLowerCase());
      const data = rows.slice(1).map(r => Object.fromEntries(r.map((v,i)=>[headers[i], parseFloat(String(v).replace(/"/g,''))])));
      if(!data.length) return null;
      const last = data.at(-1);

      // 優先1: すでに % がある列
      const pctKeys = ['change_pct','change%','change','pct','value_type_in','value_type','chg_pct'];
      for(const k of pctKeys){ if(Number.isFinite(last[k])) return last[k]; }

      // 優先2: Close と PrevClose
      const closeKeys = ['close','last','price','index','level'];
      const prevKeys  = ['prev_close','previous_close','ref','base','anchor','day_anchor','y_close','pclose'];
      let close = null, prev = null;
      for(const k of closeKeys){ if(Number.isFinite(last[k])) { close = last[k]; break; } }
      // 前日値は「全行の直近にある非NaN」を探す（行内に無ければ上の行に遡る）
      for(let i=data.length-1; i>=0 && prev===null; i--){
        const row = data[i];
        for(const k of prevKeys){ if(Number.isFinite(row[k])) { prev = row[k]; break; } }
      }
      if(Number.isFinite(close) && Number.isFinite(prev) && prev!==0){
        return (close/prev - 1) * 100;
      }

      // 優先3: 直近2点から近似（最終点と直前点）  ※最終手段
      const last2 = data.at(-2);
      if(last2){
        const a = Object.values(last).find(Number.isFinite);
        const b = Object.values(last2).find(Number.isFinite);
        if(Number.isFinite(a) && Number.isFinite(b) && b!==0){
          return (a/b - 1)*100;
        }
      }
      return null;
    }catch{ return null; }
  }

  /** 騰落率の描画 */
  function paintDelta(el, v){
    const t = el;
    t.classList.remove('--up','--down','--na');
    if(v==null || !Number.isFinite(v)){
      t.textContent = 'N/A';
      t.classList.add('--na');
      return;
    }
    const s = (v>=0?'+':'') + v.toFixed(2) + '%';
    t.textContent = s;
    t.classList.add(v>=0?'--up':'--down');
  }

  /** バリアント切替のレンダラ */
  async function render(card, variant){
    const key = card.dataset.key;
    const img = card.querySelector('[data-img]');
    const miss= card.querySelector('[data-noimg]');
    const deltaEl = card.querySelector('[data-delta]');

    // 画像解決
    const pngPath = await resolveFirstExists((MAP[key]?.png?.[variant])||[]);
    if(pngPath){
      img.src = pngPath + '?v=' + Date.now();
      img.hidden = false;  miss.hidden = true;
    }else{
      img.hidden = true;   miss.hidden = false;
    }

    // 騰落率解決（Intraday/AM は % 系 CSV を優先、長期はレベル→前日比）
    const csvPath = await resolveFirstExists((MAP[key]?.csv?.[variant])||[]);
    const pct = await computeDeltaPercent(csvPath);
    paintDelta(deltaEl, pct);
  }

  /** すべてのカードにイベントを付与 */
  document.querySelectorAll('.sx-card').forEach(card=>{
    const buttons = card.querySelectorAll('.sx-tabs button');
    buttons.forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        buttons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        await render(card, btn.dataset.variant);
      });
    });
    // 初期表示
    render(card, card.querySelector('.sx-tabs button.active').dataset.variant);
  });
})();
</script>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/cherry-blossom.svg" />
  <style>
    :root{
      --bg:#0d0d0f;--card:#1a1a1f;--axis:#0b0c10;--text:#ddd;--muted:#aaa;
      --pos:#28e07c;--neg:#ff4d4d;--chip:#333;--ring:#2c2f36;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);
      font-family:'Inter','Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,sans-serif;margin:0}
    header{text-align:center;padding:20px 12px}
    h1{font-size:clamp(1.4rem,2.2vw,2.2rem);margin:0 0 8px}
    .info{font-size:.9rem;color:var(--muted);margin-bottom:12px}
    .links{display:flex;justify-content:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .links a{background:var(--chip);color:#fff;text-decoration:none;padding:8px 14px;border-radius:10px;font-size:.9rem}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(420px,1fr));gap:24px;padding:0 28px 28px;max-width:1280px;margin:0 auto 28px}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 0 12px rgba(255,255,255,.05);display:flex;flex-direction:column;gap:12px}
    .card-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{display:flex;align-items:center;gap:8px;font-weight:700}
    .category{font-size:.8rem;background:var(--chip);color:#ccc;padding:2px 6px;border-radius:6px}
    .percent{font-weight:700}
    .percent.positive{color:var(--pos)} .percent.negative{color:var(--neg)}
    /* çµ±ä¸€ã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆé ˜åŸŸï¼ˆ16:9ï¼‰ */
    .chart{width:100%;background:var(--axis);border-radius:12px;overflow:hidden;position:relative}
    .chart::after{content:"";display:block;padding-top:56.25%} /* 16:9 æ¯”ç‡ */
    .chart>img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;image-rendering:auto;background:var(--axis)}
    .modes{display:flex;gap:10px;flex-wrap:wrap}
    .mode{border:none;background:var(--chip);color:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
    .mode.active{outline:2px solid var(--ring);background:#40424a}
    footer{text-align:center;font-size:.8rem;color:#888;margin-top:8px;padding-bottom:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</h1>
    <div class="info" id="sync-info">åŒæœŸå®Œäº†: ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
    <div class="links">
      <a href="https://x.com/Sakura_Index" target="_blank" rel="noopener noreferrer">å…¬å¼Xï¼ˆTwitterï¼‰</a>
      <a href="https://note.com/sakura_index" target="_blank" rel="noopener noreferrer">å…¬å¼note</a>
    </div>
  </header>

  <main class="grid" id="grid"></main>

  <footer>
    ãƒ‡ãƒ¼ã‚¿ï¼šç­‰åŠ é‡æŒ‡æ•°ï¼ˆä»•æ§˜ã¯å„ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰ / ç”»åƒã¯å„æŒ‡æ•°ãƒªãƒã®è‡ªå‹•ç”Ÿæˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’åŒæœŸã—ã¦ã„ã¾ã™ã€‚<br/>
    â€»æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ï¼ˆè‡ªå·±è²¬ä»»ï¼‰ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚<br/>
    Â© 2025 æ¡œIndex
  </footer>

  <script>
  // ====== è¨­å®š ======
  const INDEXES = [
    { id:'astra4',     name:'Astra4',  flag:'ğŸ‡¯ğŸ‡µ', category:'å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼' },
    { id:'rbank9',     name:'R-BANK9', flag:'ğŸ‡¯ğŸ‡µ', category:'åœ°æ–¹éŠ€è¡Œ' },
    { id:'ain10',      name:'AIN-10',  flag:'ğŸ‡ºğŸ‡¸', category:'AIé–¢é€£10' },
    { id:'scoin_plus', name:'S-COIN+', flag:'ğŸ‡¯ğŸ‡µ', category:'ä»®æƒ³é€šè²¨é–¢é€£' },
  ];

  // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã®è¦ç´„
  const MODE_SUFFIX = {
    intraday:     '_intraday.png',
    am:           '_intraday_am.png',
    '7d':         '_7d.png',
    '1m':         '_1m.png',
    '1y':         '_1y.png'
  };
  // æ—§æ¥ã®é•·æœŸç”»åƒï¼ˆç„¡ã„å ´åˆãŒã‚ã‚‹ã®ã§æœ€å¾Œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ä½¿ã†ï¼‰
  const FALLBACK_LONG = '_1d.png';

  // stats.json ã®ã‚­ãƒ¼å€™è£œï¼ˆé †ã«å„ªå…ˆï¼‰
  const PCT_KEYS_BY_MODE = {
    intraday: ['pct_intraday','pct_1d','pct','pct_today'],
    am:       ['pct_am','pct_intraday','pct_1d','pct'],
    '7d':     ['pct_7d','pct_week'],
    '1m':     ['pct_1m','pct_month'],
    '1y':     ['pct_1y','pct_year']
  };

  const gridEl = document.getElementById('grid');
  const syncInfo = document.getElementById('sync-info');

  function fmtPctAuto(v){
    if (v==null || isNaN(v)) return 'N/A';
    // v ãŒ -1ã€œ1 ã®ã¨ãã¯æ¯”ç‡ â‡’ ï¼… ã«å¤‰æ›ï¼ˆ0.3 â†’ 30%ï¼‰
    const asNumber = Number(v);
    const pct = (Math.abs(asNumber) <= 1 ? asNumber*100 : asNumber);
    const s = (pct>=0?'+':'') + pct.toFixed(2) + '%';
    return s;
  }
  function pctClass(v){
    const n = Number(v);
    if (isNaN(n)) return '';
    return n>=0 ? 'positive' : 'negative';
  }

  function nowJST(){
    return new Date().toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'});
  }

  // å„ã‚«ãƒ¼ãƒ‰ã‚’æç”»
  INDEXES.forEach(ix => {
    const card = document.createElement('section');
    card.className = 'card';
    card.dataset.id = ix.id;

    card.innerHTML = `
      <div class="card-header">
        <div class="title">${ix.flag} ${ix.name} <span class="category">${ix.category}</span></div>
        <div class="percent" data-pct>â€”</div>
      </div>
      <div class="chart"><img data-img alt="${ix.name} chart" loading="eager" /></div>
      <div class="modes" role="tablist" aria-label="${ix.name} chart modes">
        <button class="mode active" data-mode="intraday">Intraday</button>
        <button class="mode" data-mode="am">å‰å ´(AM)</button>
        <button class="mode" data-mode="7d">7æ—¥</button>
        <button class="mode" data-mode="1m">1ãƒ¶æœˆ</button>
        <button class="mode" data-mode="1y">1å¹´</button>
      </div>
    `;
    gridEl.appendChild(card);
  });

  syncInfo.textContent = `åŒæœŸå®Œäº†: ${nowJST()} / ãƒ‡ãƒ¼ã‚¿: charts/*`;

  // åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨ã¦ intraday ã§é–‹å§‹ï¼‰
  document.querySelectorAll('.card').forEach(card=>{
    const id = card.dataset.id;
    setMode(card,id,'intraday'); // ã“ã“ã§ â€œNo dataâ€ åŒ–ã‚’é˜²ãï¼ˆå¸¸ã« intraday ã‹ã‚‰ï¼‰
  });

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
  gridEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('.mode');
    if(!btn) return;
    const card = btn.closest('.card');
    const id = card.dataset.id;
    card.querySelectorAll('.mode').forEach(b=>b.classList.toggle('active', b===btn));
    setMode(card,id, btn.dataset.mode);
  });

  async function setMode(card,id,mode){
    const imgEl = card.querySelector('[data-img]');
    const pctEl = card.querySelector('[data-pct]');

    // ç”»åƒãƒ‘ã‚¹ã‚’æ±ºå®šï¼ˆAM ã¯ç„¡ã‘ã‚Œã° intraday ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ / é•·æœŸã¯1dã‚’æœ€å¾Œã®ç ¦ã«ï¼‰
    let suffix = MODE_SUFFIX[mode] ?? MODE_SUFFIX.intraday;
    let srcPrimary = `docs/charts/${id}${suffix}`;
    let srcFallback = null;

    if (mode==='am'){
      srcFallback = `docs/charts/${id}${MODE_SUFFIX.intraday}`;
    }else if (mode==='7d' || mode==='1m' || mode==='1y'){
      srcFallback = `docs/charts/${id}${FALLBACK_LONG}`;
    }

    // stats èª­ã¿è¾¼ã¿
    const statsUrl = `docs/charts/${id}_stats.json`;
    let stats = {};
    try{
      const res = await fetch(statsUrl,{cache:'no-store'});
      if(res.ok) stats = await res.json();
    }catch(_){/* noop */}

    // æ›´æ–°æ™‚åˆ»ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ï¼‰
    const ver = encodeURIComponent(stats.updated_at || Date.now());

    // ç”»åƒã‚½ãƒ¼ã‚¹ã‚’æ±ºå®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚ä»˜ä¸ï¼‰
    let imgSrc = `${srcPrimary}?v=${ver}`;
    // ã€Œä¸€åº¦ 404 ã‚’è¸ã‚€ â†’ ç½®ãæ›ãˆã€ã«ã™ã‚‹ã¨ãƒãƒ©ã¤ãã®ã§ã€äº‹å‰ã«åœ¨ã‚‹ã‹ã©ã†ã‹ HEAD ã§è»½ãç¢ºèª
    const ok = await quickExists(imgSrc);
    if(!ok && srcFallback){
      imgSrc = `${srcFallback}?v=${ver}`;
    }
    imgEl.src = imgSrc;

    // é¨°è½ç‡ã®ã‚­ãƒ¼å€™è£œã‚’é †ã«æ¢ç´¢
    const keys = PCT_KEYS_BY_MODE[mode] || PCT_KEYS_BY_MODE.intraday;
    let val = null;
    for(const k of keys){
      if (k in stats){ val = stats[k]; break; }
    }
    // æœ€å¾Œã®ä¿é™ºï¼šintradayç”¨ã‚­ãƒ¼ã‚’ç·å½“ãŸã‚Š
    if(val==null){
      for(const k of PCT_KEYS_BY_MODE.intraday){
        if (k in stats){ val = stats[k]; break; }
      }
    }
    pctEl.textContent = fmtPctAuto(val);
    pctEl.className = `percent ${pctClass(val)}`;
  }

  // è»½é‡å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆCORS/HEAD è¨±å®¹å‰æã€‚å¤±æ•—ã¯ false æ‰±ã„ï¼‰
  async function quickExists(url){
    try{
      const r = await fetch(url,{method:'HEAD',cache:'no-store'});
      return r.ok;
    }catch(_){ return false; }
  }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🌸 桜Index - 公式サイト</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/cherry-blossom.svg" />
  <style>
    :root {
      --bg: #0d0d0f;
      --card: #1a1a1f;
      --axis: #0b0c10;
      --text: #ddd;
      --muted: #aaa;
      --pos: #28e07c;
      --neg: #ff4d4d;
      --chip: #333;
      --chip-disabled: #2a2a2d;
      --chip-active: #444;
      --shadow: 0 0 12px rgba(255,255,255,0.05);
    }
    * { box-sizing: border-box; }
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
      margin: 0;
    }
    header { text-align: center; padding: 20px 0 8px; }
    h1 { font-size: 1.8rem; margin: 0 0 8px; }
    .info { font-size: 0.9rem; color: var(--muted); margin-bottom: 12px; }
    .links { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; }
    .links a {
      background: var(--chip); color: #fff; text-decoration: none;
      padding: 8px 14px; border-radius: 8px; font-size: 0.9rem;
      transition: background 0.15s ease;
    }
    .links a:hover { background: var(--chip-active); }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(420px, 1fr));
      gap: 24px;
      padding: 0 28px 28px;
      max-width: 1280px;
      margin: 0 auto 28px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex; flex-direction: column; gap: 12px;
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
    }
    .title { display: flex; align-items: center; gap: 8px; font-weight: 700; }
    .category {
      font-size: 0.8rem; background: var(--chip); color: #ccc;
      padding: 2px 6px; border-radius: 6px;
    }
    .percent { font-weight: 700; }
    .percent.positive { color: var(--pos); }
    .percent.negative { color: var(--neg); }
    .chart {
      width: 100%;
      border-radius: 12px;
      background: var(--axis);
      overflow: hidden;
      display: flex; justify-content: center;
      min-height: 260px;
    }
    .chart img {
      width: 100%;
      display: block;
      background: var(--axis);
    }

    .toolbar {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .chip {
      background: var(--chip); color: #fff;
      border: none; border-radius: 8px;
      padding: 6px 10px; font-size: 0.85rem; cursor: pointer;
      transition: background 0.15s ease, opacity 0.15s ease;
    }
    .chip[disabled] {
      background: var(--chip-disabled);
      color: var(--muted);
      cursor: not-allowed;
      opacity: 0.6;
    }
    .chip.active { background: var(--chip-active); }

    .desc { color: var(--muted); font-size: 0.9rem; }
    footer {
      text-align: center; font-size: 0.8rem; color: #888;
      margin-top: 8px; padding-bottom: 20px;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>🌸 桜Index - 公式サイト</h1>
    <div class="info" id="sync-info">同期完了: ロード中...</div>
    <div class="links">
      <a href="https://x.com/Sakura_Index" target="_blank" rel="noopener noreferrer">公式X（Twitter）</a>
      <a href="https://note.com/sakura_index" target="_blank" rel="noopener noreferrer">公式note</a>
    </div>
  </header>

  <main class="grid" id="charts"></main>

  <footer>
    データ：等加重指数（仕様は各リポジトリ参照） / 画像は各指数リポの自動生成スナップショットを同期しています。<br/>
    ※本サイトは投資助言ではありません。投資判断はご自身の責任（自己責任）でお願いします。<br/>
    © 2025 桜Index
  </footer>

  <script>
    // ===== 設定 =====
    // サイトに表示する指数の定義
    const indices = [
      { id: 'astra4',     name: 'ASTRA4',   category: '宇宙ベンチャー',  flag: '🇯🇵',
        // 任意: 説明文（なくてもOK）
        desc: '宇宙関連銘柄の等ウェイト指数。可視化はボラティリティに配慮。'
      },
      { id: 'rbank9',     name: 'R-BANK9',  category: '地方銀行',        flag: '🇯🇵',
        desc: '地方銀行9銘柄の等ウェイト指数。'
      },
      { id: 'ain10',      name: 'AIN-10',   category: 'AI関連10',        flag: '🇺🇸',
        desc: '米AI関連10銘柄の等ウェイト指数。短期モメンタム観測に便利。'
      },
      { id: 'scoin_plus', name: 'S-COIN+',  category: '仮想通貨関連',     flag: '🇯🇵',
        desc: '暗号資産関連の等ウェイト指数。日中は騰落率、長期はレベル推移を表示。'
      },
    ];

    // チャートファイルの命名規則を統一的に扱うためのマップ
    // キー: UI ボタン名、val: 実ファイルのサフィックス
    const PERIODS = [
      { key: 'intraday',   label: 'Intraday',   file: 'intraday'   },
      { key: 'am',         label: '前場(AM)',   file: 'intraday_am'},
      { key: '7d',         label: '7日',         file: '7d'         },
      { key: '1m',         label: '1ヶ月',       file: '1m'         },
      { key: '1y',         label: '1年',         file: '1y'         },
    ];

    // ===== ユーティリティ =====
    const ts = () => Date.now();

    async function fetchMaybe(url) {
      try {
        const res = await fetch(url + `?v=${ts()}`, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.text();
      } catch { return null; }
    }

    async function fetchJsonMaybe(url) {
      try {
        const res = await fetch(url + `?v=${ts()}`, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch { return null; }
    }

    function parseCSVLastPercent(csvText) {
      // 非常に寛容な CSV パーサ（最後の行のパーセンテージっぽい列を探す）
      try {
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) return null;
        const header = lines[0].split(',');
        const last = lines[lines.length - 1].split(',');

        // 候補列名（小文字で突き合わせ）
        const candidates = ['percent','pct','change','ratio'];
        let idx = -1;
        for (let i = 0; i < header.length; i++) {
          const h = header[i].toLowerCase();
          if (candidates.some(c => h.includes(c))) { idx = i; break; }
        }
        if (idx === -1) return null;
        const v = parseFloat(last[idx]);
        if (Number.isFinite(v)) return v;
        return null;
      } catch { return null; }
    }

    function setPct(el, v) {
      if (v === null || v === undefined || Number.isNaN(v)) {
        el.textContent = 'N/A';
        el.classList.remove('positive','negative');
        return;
      }
      const cls = v >= 0 ? 'positive' : 'negative';
      el.textContent = (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
      el.classList.remove('positive','negative');
      el.classList.add(cls);
    }

    async function imageExists(url) {
      try {
        const res = await fetch(url + `?v=${ts()}`, { method: 'HEAD', cache: 'no-store' });
        return res.ok;
      } catch { return false; }
    }

    function swapImage(imgEl, url, fallbackUrls = []) {
      // 新しい Image でプリロードしてから置き換え。失敗時はフォールバックを順に試す。
      return new Promise(resolve => {
        const candidate = [url, ...fallbackUrls];
        const tryNext = (i) => {
          if (i >= candidate.length) {
            resolve(false);
            return;
          }
          const test = new Image();
          test.onload = () => { imgEl.src = candidate[i] + `?v=${ts()}`; resolve(true); };
          test.onerror = () => tryNext(i + 1);
          test.decoding = 'async';
          test.src = candidate[i] + `?v=${ts()}`;
        };
        tryNext(0);
      });
    }

    // ===== 1カード組み立て =====
    function makeCardDOM(meta) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-header">
          <div class="title">${meta.flag} ${meta.name} <span class="category">${meta.category}</span></div>
          <div class="percent" id="${meta.id}-pct">N/A</div>
        </div>
        ${meta.desc ? `<div class="desc">${meta.desc}</div>` : ''}
        <div class="chart"><img id="${meta.id}-img" alt="${meta.name} chart" /></div>
        <div class="toolbar" id="${meta.id}-toolbar"></div>
      `;
      return card;
    }

    function periodButtons(meta) {
      const toolbar = document.getElementById(`${meta.id}-toolbar`);
      PERIODS.forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.dataset.period = p.key;
        btn.textContent = p.label;
        toolbar.appendChild(btn);
      });
      return toolbar.querySelectorAll('button.chip');
    }

    function setActive(btns, key) {
      btns.forEach(b => b.classList.toggle('active', b.dataset.period === key));
    }

    // 与えた id について、存在するチャートを確認してボタンの無効化/有効化を決める
    async function setupAvailability(meta, btns) {
      const exists = {};
      await Promise.all(PERIODS.map(async p => {
        const path = `docs/charts/${meta.id}_${p.file}.png`;
        exists[p.key] = await imageExists(path);
      }));
      // AM が無い等、存在しない期間は disable
      btns.forEach(b => {
        if (!exists[b.dataset.period]) {
          b.setAttribute('disabled','');
        } else {
          b.removeAttribute('disabled');
        }
      });
      return exists;
    }

    // 最初に使う期間（優先順位: intraday → 7d → 1m → 1y → am）
    function pickFirstAvailable(exists) {
      const order = ['intraday','7d','1m','1y','am'];
      for (const k of order) if (exists[k]) return k;
      return null;
    }

    // ===== メイン描画 =====
    async function render() {
      const container = document.getElementById('charts');
      const syncInfo  = document.getElementById('sync-info');
      syncInfo.textContent = `同期完了: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })} / データ: charts/*`;

      for (const meta of indices) {
        const card = makeCardDOM(meta);
        container.appendChild(card);

        const imgEl = document.getElementById(`${meta.id}-img`);
        const pctEl = document.getElementById(`${meta.id}-pct`);
        const btns = periodButtons(meta);

        // 1) 騰落率の取得（stats.json → 無ければ CSV 推定）
        (async () => {
          const statsPath = `docs/charts/${meta.id}_stats.json`;            // 新方式（推奨）
          const legacyStatsPath = `docs/charts/${meta.id}-stats.json`;      // 旧方式（互換）
          let pct = null;

          let stats = await fetchJsonMaybe(statsPath);
          if (!stats) stats = await fetchJsonMaybe(legacyStatsPath);

          // 既知キーを順に探す（柔軟な互換）
          if (stats) {
            const keys = ['pct_intraday','pct_1d','pct','percent','change'];
            for (const k of keys) {
              if (typeof stats[k] === 'number') { pct = stats[k]; break; }
            }
          }
          // CSV から推定（最終行の percent/ratio/pct/change のどれか）
          if (pct === null) {
            const csv = await fetchMaybe(`docs/outputs/${meta.id}_intraday.csv`);
            if (csv) pct = parseCSVLastPercent(csv);
          }
          setPct(pctEl, pct);
        })();

        // 2) ボタンの有無をファイル実在で決める → 初期表示も決める
        const exists = await setupAvailability(meta, btns);
        const first = pickFirstAvailable(exists);
        if (first) {
          const mainUrl = `docs/charts/${meta.id}_${PERIODS.find(p => p.key===first).file}.png`;
          const fallbacks = PERIODS.filter(p => p.key!==first && exists[p.key])
                                   .map(p => `docs/charts/${meta.id}_${p.file}.png`);
          await swapImage(imgEl, mainUrl, fallbacks);
          setActive(btns, first);
        } else {
          // 1枚も無いときはダミー文言だけ
          imgEl.alt = `${meta.name} chart (画像がありません)`;
        }

        // 3) 期間切替（プリロード→差替え／失敗時フォールバック）
        btns.forEach(btn => {
          btn.addEventListener('click', async () => {
            if (btn.hasAttribute('disabled')) return;
            const periodKey = btn.dataset.period;
            const picked = PERIODS.find(p => p.key === periodKey);
            const url = `docs/charts/${meta.id}_${picked.file}.png`;

            // 失敗時フォールバック順（現在押したボタン以外で存在するもの）
            const fallback = PERIODS
              .filter(p => p.key !== periodKey && exists[p.key])
              .map(p => `docs/charts/${meta.id}_${p.file}.png`);

            const ok = await swapImage(imgEl, url, fallback);
            if (ok) setActive(btns, periodKey);
          });
        });
      }
    }

    render();
  </script>
</body>
</html>

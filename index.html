<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/cherry-blossom.svg" />
  <style>
    :root {
      --bg: #0d0d0f;
      --card: #1a1a1f;
      --axis: #0b0c10;
      --text: #ddd;
      --muted: #aaa;
      --pos: #28e07c;
      --neg: #ff4d4d;
      --chip: #333;
      --chip-disabled: #2a2a2d;
      --chip-active: #444;
      --shadow: 0 0 12px rgba(255,255,255,0.05);
    }
    * { box-sizing: border-box; }
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
      margin: 0;
    }
    header { text-align: center; padding: 20px 0 8px; }
    h1 { font-size: 1.8rem; margin: 0 0 8px; }
    .info { font-size: 0.9rem; color: var(--muted); margin-bottom: 12px; }
    .links { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; }
    .links a {
      background: var(--chip); color: #fff; text-decoration: none;
      padding: 8px 14px; border-radius: 8px; font-size: 0.9rem;
      transition: background 0.15s ease;
    }
    .links a:hover { background: var(--chip-active); }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(420px, 1fr));
      gap: 24px;
      padding: 0 28px 28px;
      max-width: 1280px;
      margin: 0 auto 28px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex; flex-direction: column; gap: 12px;
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
    }
    .title { display: flex; align-items: center; gap: 8px; font-weight: 700; }
    .category {
      font-size: 0.8rem; background: var(--chip); color: #ccc;
      padding: 2px 6px; border-radius: 6px;
    }
    .percent { font-weight: 700; }
    .percent.positive { color: var(--pos); }
    .percent.negative { color: var(--neg); }
    .chart {
      width: 100%;
      border-radius: 12px;
      background: var(--axis);
      overflow: hidden;
      display: flex; justify-content: center;
      min-height: 260px;
    }
    .chart img {
      width: 100%;
      display: block;
      background: var(--axis);
    }

    .toolbar {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .chip {
      background: var(--chip); color: #fff;
      border: none; border-radius: 8px;
      padding: 6px 10px; font-size: 0.85rem; cursor: pointer;
      transition: background 0.15s ease, opacity 0.15s ease;
    }
    .chip[disabled] {
      background: var(--chip-disabled);
      color: var(--muted);
      cursor: not-allowed;
      opacity: 0.6;
    }
    .chip.active { background: var(--chip-active); }

    .desc { color: var(--muted); font-size: 0.9rem; }
    footer {
      text-align: center; font-size: 0.8rem; color: #888;
      margin-top: 8px; padding-bottom: 20px;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</h1>
    <div class="info" id="sync-info">åŒæœŸå®Œäº†: ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
    <div class="links">
      <a href="https://x.com/Sakura_Index" target="_blank" rel="noopener noreferrer">å…¬å¼Xï¼ˆTwitterï¼‰</a>
      <a href="https://note.com/sakura_index" target="_blank" rel="noopener noreferrer">å…¬å¼note</a>
    </div>
  </header>

  <main class="grid" id="charts"></main>

  <footer>
    ãƒ‡ãƒ¼ã‚¿ï¼šç­‰åŠ é‡æŒ‡æ•°ï¼ˆä»•æ§˜ã¯å„ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰ / ç”»åƒã¯å„æŒ‡æ•°ãƒªãƒã®è‡ªå‹•ç”Ÿæˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’åŒæœŸã—ã¦ã„ã¾ã™ã€‚<br/>
    â€»æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ï¼ˆè‡ªå·±è²¬ä»»ï¼‰ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚<br/>
    Â© 2025 æ¡œIndex
  </footer>

  <script>
    // ===== è¨­å®š =====
    // ã‚µã‚¤ãƒˆã«è¡¨ç¤ºã™ã‚‹æŒ‡æ•°ã®å®šç¾©
    const indices = [
      { id: 'astra4',     name: 'ASTRA4',   category: 'å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼',  flag: 'ğŸ‡¯ğŸ‡µ',
        // ä»»æ„: èª¬æ˜æ–‡ï¼ˆãªãã¦ã‚‚OKï¼‰
        desc: 'å®‡å®™é–¢é€£éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚å¯è¦–åŒ–ã¯ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã«é…æ…®ã€‚'
      },
      { id: 'rbank9',     name: 'R-BANK9',  category: 'åœ°æ–¹éŠ€è¡Œ',        flag: 'ğŸ‡¯ğŸ‡µ',
        desc: 'åœ°æ–¹éŠ€è¡Œ9éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚'
      },
      { id: 'ain10',      name: 'AIN-10',   category: 'AIé–¢é€£10',        flag: 'ğŸ‡ºğŸ‡¸',
        desc: 'ç±³AIé–¢é€£10éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚çŸ­æœŸãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ è¦³æ¸¬ã«ä¾¿åˆ©ã€‚'
      },
      { id: 'scoin_plus', name: 'S-COIN+',  category: 'ä»®æƒ³é€šè²¨é–¢é€£',     flag: 'ğŸ‡¯ğŸ‡µ',
        desc: 'æš—å·è³‡ç”£é–¢é€£ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚æ—¥ä¸­ã¯é¨°è½ç‡ã€é•·æœŸã¯ãƒ¬ãƒ™ãƒ«æ¨ç§»ã‚’è¡¨ç¤ºã€‚'
      },
    ];

    // ãƒãƒ£ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‘½åè¦å‰‡ã‚’çµ±ä¸€çš„ã«æ‰±ã†ãŸã‚ã®ãƒãƒƒãƒ—
    // ã‚­ãƒ¼: UI ãƒœã‚¿ãƒ³åã€val: å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹
    const PERIODS = [
      { key: 'intraday',   label: 'Intraday',   file: 'intraday'   },
      { key: 'am',         label: 'å‰å ´(AM)',   file: 'intraday_am'},
      { key: '7d',         label: '7æ—¥',         file: '7d'         },
      { key: '1m',         label: '1ãƒ¶æœˆ',       file: '1m'         },
      { key: '1y',         label: '1å¹´',         file: '1y'         },
    ];

    // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    const ts = () => Date.now();

    async function fetchMaybe(url) {
      try {
        const res = await fetch(url + `?v=${ts()}`, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.text();
      } catch { return null; }
    }

    async function fetchJsonMaybe(url) {
      try {
        const res = await fetch(url + `?v=${ts()}`, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch { return null; }
    }

    function parseCSVLastPercent(csvText) {
      // éå¸¸ã«å¯›å®¹ãª CSV ãƒ‘ãƒ¼ã‚µï¼ˆæœ€å¾Œã®è¡Œã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã£ã½ã„åˆ—ã‚’æ¢ã™ï¼‰
      try {
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) return null;
        const header = lines[0].split(',');
        const last = lines[lines.length - 1].split(',');

        // å€™è£œåˆ—åï¼ˆå°æ–‡å­—ã§çªãåˆã‚ã›ï¼‰
        const candidates = ['percent','pct','change','ratio'];
        let idx = -1;
        for (let i = 0; i < header.length; i++) {
          const h = header[i].toLowerCase();
          if (candidates.some(c => h.includes(c))) { idx = i; break; }
        }
        if (idx === -1) return null;
        const v = parseFloat(last[idx]);
        if (Number.isFinite(v)) return v;
        return null;
      } catch { return null; }
    }

    function setPct(el, v) {
      if (v === null || v === undefined || Number.isNaN(v)) {
        el.textContent = 'N/A';
        el.classList.remove('positive','negative');
        return;
      }
      const cls = v >= 0 ? 'positive' : 'negative';
      el.textContent = (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
      el.classList.remove('positive','negative');
      el.classList.add(cls);
    }

    async function imageExists(url) {
      try {
        const res = await fetch(url + `?v=${ts()}`, { method: 'HEAD', cache: 'no-store' });
        return res.ok;
      } catch { return false; }
    }

    function swapImage(imgEl, url, fallbackUrls = []) {
      // æ–°ã—ã„ Image ã§ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰ç½®ãæ›ãˆã€‚å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é †ã«è©¦ã™ã€‚
      return new Promise(resolve => {
        const candidate = [url, ...fallbackUrls];
        const tryNext = (i) => {
          if (i >= candidate.length) {
            resolve(false);
            return;
          }
          const test = new Image();
          test.onload = () => { imgEl.src = candidate[i] + `?v=${ts()}`; resolve(true); };
          test.onerror = () => tryNext(i + 1);
          test.decoding = 'async';
          test.src = candidate[i] + `?v=${ts()}`;
        };
        tryNext(0);
      });
    }

    // ===== 1ã‚«ãƒ¼ãƒ‰çµ„ã¿ç«‹ã¦ =====
    function makeCardDOM(meta) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-header">
          <div class="title">${meta.flag} ${meta.name} <span class="category">${meta.category}</span></div>
          <div class="percent" id="${meta.id}-pct">N/A</div>
        </div>
        ${meta.desc ? `<div class="desc">${meta.desc}</div>` : ''}
        <div class="chart"><img id="${meta.id}-img" alt="${meta.name} chart" /></div>
        <div class="toolbar" id="${meta.id}-toolbar"></div>
      `;
      return card;
    }

    function periodButtons(meta) {
      const toolbar = document.getElementById(`${meta.id}-toolbar`);
      PERIODS.forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.dataset.period = p.key;
        btn.textContent = p.label;
        toolbar.appendChild(btn);
      });
      return toolbar.querySelectorAll('button.chip');
    }

    function setActive(btns, key) {
      btns.forEach(b => b.classList.toggle('active', b.dataset.period === key));
    }

    // ä¸ãˆãŸ id ã«ã¤ã„ã¦ã€å­˜åœ¨ã™ã‚‹ãƒãƒ£ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–/æœ‰åŠ¹åŒ–ã‚’æ±ºã‚ã‚‹
    async function setupAvailability(meta, btns) {
      const exists = {};
      await Promise.all(PERIODS.map(async p => {
        const path = `docs/charts/${meta.id}_${p.file}.png`;
        exists[p.key] = await imageExists(path);
      }));
      // AM ãŒç„¡ã„ç­‰ã€å­˜åœ¨ã—ãªã„æœŸé–“ã¯ disable
      btns.forEach(b => {
        if (!exists[b.dataset.period]) {
          b.setAttribute('disabled','');
        } else {
          b.removeAttribute('disabled');
        }
      });
      return exists;
    }

    // æœ€åˆã«ä½¿ã†æœŸé–“ï¼ˆå„ªå…ˆé †ä½: intraday â†’ 7d â†’ 1m â†’ 1y â†’ amï¼‰
    function pickFirstAvailable(exists) {
      const order = ['intraday','7d','1m','1y','am'];
      for (const k of order) if (exists[k]) return k;
      return null;
    }

    // ===== ãƒ¡ã‚¤ãƒ³æç”» =====
    async function render() {
      const container = document.getElementById('charts');
      const syncInfo  = document.getElementById('sync-info');
      syncInfo.textContent = `åŒæœŸå®Œäº†: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })} / ãƒ‡ãƒ¼ã‚¿: charts/*`;

      for (const meta of indices) {
        const card = makeCardDOM(meta);
        container.appendChild(card);

        const imgEl = document.getElementById(`${meta.id}-img`);
        const pctEl = document.getElementById(`${meta.id}-pct`);
        const btns = periodButtons(meta);

        // 1) é¨°è½ç‡ã®å–å¾—ï¼ˆstats.json â†’ ç„¡ã‘ã‚Œã° CSV æ¨å®šï¼‰
        (async () => {
          const statsPath = `docs/charts/${meta.id}_stats.json`;            // æ–°æ–¹å¼ï¼ˆæ¨å¥¨ï¼‰
          const legacyStatsPath = `docs/charts/${meta.id}-stats.json`;      // æ—§æ–¹å¼ï¼ˆäº’æ›ï¼‰
          let pct = null;

          let stats = await fetchJsonMaybe(statsPath);
          if (!stats) stats = await fetchJsonMaybe(legacyStatsPath);

          // æ—¢çŸ¥ã‚­ãƒ¼ã‚’é †ã«æ¢ã™ï¼ˆæŸ”è»Ÿãªäº’æ›ï¼‰
          if (stats) {
            const keys = ['pct_intraday','pct_1d','pct','percent','change'];
            for (const k of keys) {
              if (typeof stats[k] === 'number') { pct = stats[k]; break; }
            }
          }
          // CSV ã‹ã‚‰æ¨å®šï¼ˆæœ€çµ‚è¡Œã® percent/ratio/pct/change ã®ã©ã‚Œã‹ï¼‰
          if (pct === null) {
            const csv = await fetchMaybe(`docs/outputs/${meta.id}_intraday.csv`);
            if (csv) pct = parseCSVLastPercent(csv);
          }
          setPct(pctEl, pct);
        })();

        // 2) ãƒœã‚¿ãƒ³ã®æœ‰ç„¡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿåœ¨ã§æ±ºã‚ã‚‹ â†’ åˆæœŸè¡¨ç¤ºã‚‚æ±ºã‚ã‚‹
        const exists = await setupAvailability(meta, btns);
        const first = pickFirstAvailable(exists);
        if (first) {
          const mainUrl = `docs/charts/${meta.id}_${PERIODS.find(p => p.key===first).file}.png`;
          const fallbacks = PERIODS.filter(p => p.key!==first && exists[p.key])
                                   .map(p => `docs/charts/${meta.id}_${p.file}.png`);
          await swapImage(imgEl, mainUrl, fallbacks);
          setActive(btns, first);
        } else {
          // 1æšã‚‚ç„¡ã„ã¨ãã¯ãƒ€ãƒŸãƒ¼æ–‡è¨€ã ã‘
          imgEl.alt = `${meta.name} chart (ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“)`;
        }

        // 3) æœŸé–“åˆ‡æ›¿ï¼ˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰â†’å·®æ›¿ãˆï¼å¤±æ•—æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        btns.forEach(btn => {
          btn.addEventListener('click', async () => {
            if (btn.hasAttribute('disabled')) return;
            const periodKey = btn.dataset.period;
            const picked = PERIODS.find(p => p.key === periodKey);
            const url = `docs/charts/${meta.id}_${picked.file}.png`;

            // å¤±æ•—æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é †ï¼ˆç¾åœ¨æŠ¼ã—ãŸãƒœã‚¿ãƒ³ä»¥å¤–ã§å­˜åœ¨ã™ã‚‹ã‚‚ã®ï¼‰
            const fallback = PERIODS
              .filter(p => p.key !== periodKey && exists[p.key])
              .map(p => `docs/charts/${meta.id}_${p.file}.png`);

            const ok = await swapImage(imgEl, url, fallback);
            if (ok) setActive(btns, periodKey);
          });
        });
      }
    }

    render();
  </script>
</body>
</html>

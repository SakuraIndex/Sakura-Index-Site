<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸŒ¸æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</title>
  <meta name="description" content="å„ç¨®ç­‰åŠ é‡æŒ‡æ•°ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" />
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#38bdf8;
      --chip:#1f2937;--pos:#10b981;--neg:#ef4444;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:20px;display:flex;gap:8px;align-items:center}
    h1 .dot{font-size:20px}
    .meta{font-size:12px;color:var(--muted)}
    .social{display:flex;gap:8px}
    .btn{border:1px solid #334155;background:#0b1220;color:var(--text);padding:6px 10px;border-radius:10px;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .head{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .flag{font-size:16px;line-height:1}
    .title{font-weight:700}
    .badge{background:#1f2937;border:1px solid #334155;color:#cbd5e1;padding:2px 8px;border-radius:999px;font-size:11px}
    .delta{margin-left:auto;font-weight:700}
    .delta.pos{color:var(--pos)}
    .delta.neg{color:var(--neg)}
    .delta.na{color:var(--muted)}
    .desc{font-size:12px;color:var(--muted);margin:6px 0 10px}
    .media{background:#0b1220;border:1px solid #1f2937;border-radius:10px;height:300px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:contain;background:#0b1220}
    .tabs{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #334155;color:#cbd5e1;border-radius:999px;padding:4px 10px;font-size:12px}
    footer{margin:28px 0 8px;font-size:12px;color:var(--muted);text-align:center;line-height:1.7}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1><span class="dot">ğŸŒ¸</span>æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</h1>
        <div class="meta" id="synced-at">åŒæœŸå®Œäº†ï¼šâ€” ï¼ ãƒ‡ãƒ¼ã‚¿: charts/*</div>
      </div>
      <div class="social">
        <a class="btn" href="https://x.com" target="_blank" rel="noreferrer">å…¬å¼Xï¼ˆTwitterï¼‰</a>
        <a class="btn" href="https://note.com" target="_blank" rel="noreferrer">å…¬å¼note</a>
      </div>
    </header>

    <main class="grid" id="cards"></main>

    <footer>
      ãƒ‡ãƒ¼ã‚¿ï¼šå„æŒ‡æ•°ã¯ç­‰åŠ é‡æŒ‡æ•°ï¼ˆä»•æ§˜ã¯å„ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰ï¼ ç”»åƒã¯å„æŒ‡æ¨™ãƒªãƒã®è‡ªå‹•ç”Ÿæˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨åŒæœŸã—ã¦ã„ã¾ã™ã€‚<br>
      â€»æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ï¼ˆè‡ªå·±è²¬ä»»ï¼‰ã§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚<br>
      Â© <span id="y"></span> æ¡œIndex
    </footer>
  </div>

  <script>
    // ====== å„æŒ‡æ•°ã®å®šç¾© ======
    const INDEXES = [
      { id: 'ASTRA4', title: 'Astra4', flag: 'ğŸ‡¯ğŸ‡µ', badge: 'å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼', desc: 'å®‡å®™é–¢é€£éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚æ—¥ä¸­ã¯%ã€é•·æœŸã¯ãƒ¬ãƒ™ãƒ«æ¨ç§»ã‚’è¡¨ç¤ºã€‚' },
      { id: 'R-BANK9', title: 'R-BANK9', flag: 'ğŸ‡¯ğŸ‡µ', badge: 'åœ°æ–¹éŠ€è¡Œ', desc: 'åœ°æ–¹éŠ€è¡Œ9éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚æ—¥ä¸­ã¯%ã€é•·æœŸã¯ãƒ¬ãƒ™ãƒ«æ¨ç§»ã‚’è¡¨ç¤ºã€‚' },
      { id: 'AIN-10', title: 'AIN-10', flag: 'ğŸ‡ºğŸ‡¸', badge: 'AIé–¢é€£10', desc: 'ç±³AIé–¢é€£10éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚çŸ­æœŸãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ è¦³æ¸¬ã«ä¾¿åˆ©ã€‚' },
      { id: 'S-COIN+', title: 'S-COIN+', flag: 'ğŸŒ', badge: 'ä»®æƒ³è³‡ç”£é–¢é€£', desc: 'æš—å·è³‡ç”£é–¢é€£ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚æ—¥ä¸­ã¯é¨°è½ç‡ã€é•·æœŸã¯ãƒ¬ãƒ™ãƒ«æ¨ç§»ã‚’è¡¨ç¤ºã€‚' },
    ];

    // ====== ãƒ«ãƒ¼ãƒˆæ¤œå‡º ======
    const baseDir = window.location.pathname.replace(/\/[^/]*$/, '');
    let CHARTS_ROOT = null;

    async function pathExists(url) {
      try { const r = await fetch(url, { method: 'HEAD', cache: 'no-store' }); return r.ok; }
      catch { return false; }
    }

    async function decideChartsRoot() {
      const cand1 = `${baseDir}/charts/${INDEXES[0].id}/stats.json`;
      if (await pathExists(cand1)) { CHARTS_ROOT = `${baseDir}/charts`; return; }
      const cand2 = `${baseDir}/docs/charts/${INDEXES[0].id}/stats.json`;
      if (await pathExists(cand2)) { CHARTS_ROOT = `${baseDir}/docs/charts`; return; }
      CHARTS_ROOT = `${baseDir}/charts`;
    }

    const jsonPath      = (id) => `${CHARTS_ROOT}/${encodeURIComponent(id)}/stats.json`;
    const intradayPath  = (id) => `${CHARTS_ROOT}/${encodeURIComponent(id)}/intraday.png`;
    const intradayAmPath= (id) => `${CHARTS_ROOT}/${encodeURIComponent(id)}/intraday_am.png`;

    // ====== é¨°è½ç‡æŠ½å‡º ======
    function pickDeltaPct(stats) {
      if (!stats) return null;

      // å€¤ãŒã™ã§ã« percent è¡¨ç¤ºã®å ´åˆï¼ˆä¾‹: 1.23 = 1.23%ï¼‰
      if (stats.scale === 'percent' || stats.value_type === 'percent') {
        if (typeof stats.delta_level === 'number') return stats.delta_level;
        if (typeof stats.pct_intraday === 'number') return stats.pct_intraday;
      }

      // å€¤ãŒ ratioï¼ˆä¾‹: 0.0123 = 1.23%ï¼‰ã®å ´åˆ
      if (typeof stats.delta_level === 'number') return stats.delta_level * 100;
      if (typeof stats.pct_intraday === 'number') return stats.pct_intraday * 100;
      if (typeof stats.pct_id === 'number') {
        const v = stats.pct_id * 100;
        if (Math.abs(v) <= 30) return v;
      }
      return null;
    }
    const fmt = (v) => `${v >= 0 ? '+' : ''}${v.toFixed(2)}%`;

    // ====== ç”»åƒè§£æ±º ======
    async function resolveImage(id) {
      const a = intradayPath(id);
      if (await pathExists(a)) return a;
      const b = intradayAmPath(id);
      if (await pathExists(b)) return b;
      return null;
    }

    // ====== ã‚«ãƒ¼ãƒ‰æç”» ======
    function renderCard({ id, title, flag, badge, desc }) {
      const el = document.createElement('section');
      el.className = 'card';
      el.innerHTML = `
        <div class="head">
          <span class="flag">${flag}</span>
          <div class="title">${title}</div>
          <span class="badge">${badge}</span>
          <div class="delta na" id="delta-${id}">N/A</div>
        </div>
        <div class="desc">${desc}</div>
        <div class="media"><img id="img-${id}" alt="${title} chart" loading="lazy"></div>
        <div class="tabs">
          <span class="chip">Intraday</span>
          <span class="chip">å‰å ´(AM)</span>
          <span class="chip">7æ—¥</span>
          <span class="chip">1ãƒ¶æœˆ</span>
          <span class="chip">1å¹´</span>
        </div>
      `;
      return el;
    }

    async function boot() {
      document.getElementById('y').textContent = new Date().getFullYear();
      await decideChartsRoot();

      const n = new Date();
      const pad = (x)=>String(x).padStart(2,'0');
      const stamp = `${n.getFullYear()}/${pad(n.getMonth()+1)}/${pad(n.getDate())} ${pad(n.getHours())}:${pad(n.getMinutes())}:${pad(n.getSeconds())}`;
      const pathLabel = CHARTS_ROOT.includes('/docs/') ? 'docs/charts/*' : 'charts/*';
      document.getElementById('synced-at').textContent = `åŒæœŸå®Œäº†ï¼š${stamp} ï¼ ãƒ‡ãƒ¼ã‚¿: ${pathLabel}`;

      const grid = document.getElementById('cards');
      INDEXES.forEach(cfg => grid.appendChild(renderCard(cfg)));

      for (const idx of INDEXES) {
        const $img   = document.getElementById(`img-${idx.id}`);
        const $delta = document.getElementById(`delta-${idx.id}`);

        resolveImage(idx.id).then(src => { if (src) $img.src = src; else $img.style.display='none'; });

        try {
          const res = await fetch(jsonPath(idx.id), { cache: 'no-store' });
          if (!res.ok) throw new Error('json not found');
          const stats = await res.json();
          const v = pickDeltaPct(stats);
          if (v === null || Number.isNaN(v)) {
            $delta.textContent = 'N/A'; $delta.className='delta na';
          } else {
            $delta.textContent = fmt(v);
            $delta.className = 'delta ' + (v>0?'pos':(v<0?'neg':'na'));
          }
        } catch {
          $delta.textContent = 'N/A'; $delta.className='delta na';
        }
      }
    }
    boot();
  </script>
</body>
</html>

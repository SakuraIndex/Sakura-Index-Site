<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/cherry-blossom.svg" />
  <style>
    :root {
      --bg: #0d0d0f;
      --card: #1a1a1f;
      --axis: #0f1014;
      --text: #e6e6e6;
      --muted: #aab;
      --pos: #28e07c;
      --neg: #ff5e5e;
      --chip: #2a2b31;
      --chip-active: #3b3d46;
      --ring: #2f3340;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 80% -10%, #14151b 0%, #0d0d0f 40%) fixed,
                  radial-gradient(1000px 800px at 10% -20%, #14151b 0%, #0d0d0f 50%) fixed,
                  var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
    }
    header { text-align: center; padding: 24px 12px 4px; }
    h1 { font-size: 2rem; margin: 0 0 6px; }
    .info { font-size: 0.9rem; color: var(--muted); margin-bottom: 12px; }
    .links { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; }
    .links a {
      background: var(--chip); color: #fff; text-decoration: none;
      padding: 8px 14px; border-radius: 10px; font-size: 0.92rem; border: 1px solid #2a2c32;
    }
    .links a:hover { background: var(--chip-active); }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(360px, 1fr));
      gap: 28px;
      padding: 0 28px 34px;
      max-width: 1380px;
      margin: 0 auto;
    }
    .card {
      background: linear-gradient(0deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.02) 100%), var(--card);
      border: 1px solid var(--ring);
      border-radius: 18px;
      padding: 16px 16px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      display: flex; flex-direction: column; gap: 12px;
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 10px; flex-wrap: wrap;
    }
    .title { display: flex; align-items: center; gap: 8px; font-weight: 800; letter-spacing: .2px;}
    .category {
      font-size: 0.8rem; background: var(--chip); color: #c9ccdf;
      padding: 2px 6px; border-radius: 6px; border: 1px solid #2d313b;
    }
    .percent { font-weight: 800; min-width: 72px; text-align: right; }
    .percent.positive { color: var(--pos); }
    .percent.negative { color: var(--neg); }

    /* çµ±ä¸€ãƒãƒ£ãƒ¼ãƒˆæ ï¼š16:9 / ä½™ç™½ã‚‚å«ã‚ãã‚Œã„ã«åã¾ã‚‹ */
    .chart {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 12px;
      background: var(--axis);
      overflow: hidden;
      border: 1px solid #22252d;
    }
    .chart img {
      width: 100%; height: 100%;
      object-fit: contain; display: block; background: var(--axis);
    }

    /* ãƒ¬ãƒ³ã‚¸åˆ‡ã‚Šæ›¿ãˆ */
    .range-row {
      display: flex; gap: 10px; margin-top: 4px; flex-wrap: wrap;
    }
    .range-btn {
      appearance: none; border: 1px solid #2c2f38; color: #dde;
      background: var(--chip); border-radius: 999px; padding: 8px 14px; font-weight: 600;
      cursor: pointer; user-select: none; position: relative; z-index: 1;
    }
    .range-btn:hover { background: var(--chip-active); }
    .range-btn.active {
      background: #2f3440; border-color: #3b4050;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    footer {
      text-align: center; font-size: 0.86rem; color: #98a1b3;
      margin-top: 6px; padding: 24px 12px 28px;
    }

    @media (max-width: 1080px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</h1>
    <div class="info" id="sync-info">åŒæœŸå®Œäº†: ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
    <div class="links">
      <a href="https://x.com/Sakura_Index" target="_blank" rel="noopener noreferrer">å…¬å¼Xï¼ˆTwitterï¼‰</a>
      <a href="https://note.com/sakura_index" target="_blank" rel="noopener noreferrer">å…¬å¼note</a>
    </div>
  </header>

  <main class="grid" id="cards"></main>

  <footer>
    ãƒ‡ãƒ¼ã‚¿ï¼šç­‰åŠ é‡æŒ‡æ•°ï¼ˆä»•æ§˜ã¯å„ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰ / ç”»åƒã¯å„æŒ‡æ•°ãƒªãƒã®è‡ªå‹•ç”Ÿæˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’åŒæœŸã—ã¦ã„ã¾ã™ã€‚<br/>
    â€»æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ï¼ˆè‡ªå·±è²¬ä»»ï¼‰ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚<br/>
    Â© 2025 æ¡œIndex
  </footer>

  <script>
    // === è¡¨ç¤ºã™ã‚‹æŒ‡æ•°ã¨IDï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®æ¥é ­è¾ï¼‰ ===
    const INDICES = [
      { id: 'astra4',   name: 'ASTRA4',  category: 'å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼', flag: 'ğŸ‡¯ğŸ‡µ' },
      { id: 'rbank9',   name: 'R-BANK9', category: 'åœ°æ–¹éŠ€è¡Œ',       flag: 'ğŸ‡¯ğŸ‡µ' },
      { id: 'ain10',    name: 'AIN-10',  category: 'AIé–¢é€£10',       flag: 'ğŸ‡ºğŸ‡¸' },
      { id: 'scoin_plus', name: 'S-COIN+', category: 'ä»®æƒ³é€šè²¨é–¢é€£', flag: 'ğŸ‡¯ğŸ‡µ' },
    ];

    // ãƒ¬ãƒ³ã‚¸â†’ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã®å¯¾å¿œ
    const RANGE_TO_FILE = {
      intraday: (id) => `docs/charts/${id}_intraday.png`,
      am      : (id) => `docs/charts/${id}_am.png`,
      '7d'    : (id) => `docs/charts/${id}_7d.png`,
      '1m'    : (id) => `docs/charts/${id}_1m.png`,
      '1y'    : (id) => `docs/charts/${id}_1y.png`,
    };

    // ãƒ¬ãƒ³ã‚¸â†’ï¼…ã‚’é€†ç®—ã™ã‚‹ã¨ãã®åŸºæº–ã‚­ãƒ¼å€™è£œ
    const RANGE_TO_ANCHOR_KEYS = {
      intraday: ['prev_close', 'yesterday_close', 'anchor_1d'],
      am      : ['am_prev_close', 'prev_close'], // ç„¡ã‘ã‚Œã°é€šå¸¸å‰æ—¥çµ‚å€¤
      '7d'    : ['anchor_7d', 'week_anchor'],
      '1m'    : ['anchor_1m', 'month_anchor'],
      '1y'    : ['anchor_1y', 'year_anchor'],
    };

    // ãƒ¬ãƒ³ã‚¸â†’statsã®ç”Ÿï¼…å€™è£œã‚­ãƒ¼
    const RANGE_TO_PCT_KEYS = {
      intraday: ['pct_intraday', 'pct_1d', 'pct'], // ã‚ˆãã‚ã‚‹åå‰ã‚’é †ã«
      am      : ['pct_am', 'am_pct'],
      '7d'    : ['pct_7d'],
      '1m'    : ['pct_1m'],
      '1y'    : ['pct_1y'],
    };

    // ä¾¿åˆ©é–¢æ•°ï¼šé…åˆ—ã®ã‚­ãƒ¼ã‚’é †ã«è¦‹ã¦æœ€åˆã®æ•°å€¤ã‚’è¿”ã™
    function firstNumber(obj, keys) {
      if (!obj) return null;
      for (const k of keys) {
        const v = obj[k];
        if (typeof v === 'number' && Number.isFinite(v)) return v;
      }
      return null;
    }

    // ä¾¿åˆ©é–¢æ•°ï¼šãƒ¬ãƒ³ã‚¸æ¯ã®ï¼…ã‚’ stats ã‹ã‚‰å–å¾—ï¼ˆç„¡ã‘ã‚Œã° last/anchor ã§é€†ç®—ï¼‰
    function getPercentForRange(stats, range) {
      if (!stats || typeof stats !== 'object') return null;

      // 1) ç”Ÿã®ï¼…ãŒå…¥ã£ã¦ã„ã‚Œã°ãã‚Œã‚’æ¡ç”¨
      const direct = firstNumber(stats, RANGE_TO_PCT_KEYS[range] || []);
      if (direct !== null) return direct;

      // 2) last ã¨ anchor ã‹ã‚‰é€†ç®—
      const last = firstNumber(stats, ['last', 'last_value', 'close']);
      if (last === null) return null;

      const anchor = firstNumber(stats, RANGE_TO_ANCHOR_KEYS[range] || []);
      if (anchor === null || anchor === 0) return null;

      const pct = ((last / anchor) - 1) * 100;
      // ç•°å¸¸å€¤ã‚¬ãƒ¼ãƒ‰ï¼ˆÂ±100%è¶…éã¯æ¬ ææ‰±ã„ï¼‰
      if (!Number.isFinite(pct) || Math.abs(pct) > 100) return null;
      return pct;
    }

    function fmtPct(v) {
      if (v === null || v === undefined || isNaN(v)) return 'N/A';
      const s = (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
      return s;
    }

    function nowJST() {
      return new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
    }

    // 1ã‚«ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
    function createCard(idx) {
      const card = document.createElement('div');
      card.className = 'card';
      card.id = `card-${idx.id}`;

      card.innerHTML = `
        <div class="card-header">
          <div class="title">${idx.flag} ${idx.name} <span class="category">${idx.category}</span></div>
          <div class="percent" id="${idx.id}-percent">N/A</div>
        </div>
        <div class="chart">
          <img id="${idx.id}-img" alt="${idx.name} chart" loading="eager" />
        </div>
        <div class="range-row" role="tablist" aria-label="${idx.name} ranges">
          <button class="range-btn active" data-range="intraday" id="${idx.id}-btn-intraday">Intraday</button>
          <button class="range-btn" data-range="am"       id="${idx.id}-btn-am">å‰å ´(AM)</button>
          <button class="range-btn" data-range="7d"       id="${idx.id}-btn-7d">7æ—¥</button>
          <button class="range-btn" data-range="1m"       id="${idx.id}-btn-1m">1ãƒ¶æœˆ</button>
          <button class="range-btn" data-range="1y"       id="${idx.id}-btn-1y">1å¹´</button>
        </div>
      `;
      return card;
    }

    // ãƒ¬ãƒ³ã‚¸åˆ‡æ›¿å‡¦ç†ï¼ˆç”»åƒã¨ï¼…ã®æ›´æ–°ï¼‰
    function applyRange(id, range, stats) {
      const img = document.getElementById(`${id}-img`);
      const pctEl = document.getElementById(`${id}-percent`);
      if (!img || !pctEl) return;

      const ver = (stats && (stats.updated_at || stats.version)) ? encodeURIComponent(stats.updated_at || stats.version) : Date.now();
      img.src = `${RANGE_TO_FILE[range](id)}?v=${ver}`;

      const pct = getPercentForRange(stats, range);
      pctEl.textContent = fmtPct(pct);
      pctEl.classList.toggle('positive', pct !== null && pct >= 0);
      pctEl.classList.toggle('negative', pct !== null && pct < 0);

      // ãƒœã‚¿ãƒ³ã® active åˆ‡æ›¿
      const card = document.getElementById(`card-${id}`);
      const btns = card.querySelectorAll('.range-btn');
      btns.forEach(b => b.classList.toggle('active', b.dataset.range === range));
    }

    async function loadAll() {
      const container = document.getElementById('cards');
      const syncInfo  = document.getElementById('sync-info');
      syncInfo.textContent = `åŒæœŸå®Œäº†: ${nowJST()} / ãƒ‡ãƒ¼ã‚¿: charts/*`;

      for (const idx of INDICES) {
        const card = createCard(idx);
        container.appendChild(card);

        // ã¾ãšã¯ stats ã‚’å–å¾—
        const statsPath = `docs/charts/${idx.id}_stats.json`;
        let stats = null;
        try {
          const res = await fetch(statsPath, { cache: 'no-store' });
          if (res.ok) { stats = await res.json(); }
        } catch (e) { /* noop */ }

        // æ—¢å®šã¯ intradayï¼ˆRBANK9 ã® â€œno data 1dâ€ ã‚’é¿ã‘ã‚‹ï¼‰
        applyRange(idx.id, 'intraday', stats);

        // ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡æ›¿
        const cardEl = document.getElementById(`card-${idx.id}`);
        cardEl.querySelectorAll('.range-btn').forEach(btn => {
          btn.addEventListener('click', (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            const range = btn.dataset.range;
            applyRange(idx.id, range, stats);
          }, { passive: true });
          // ãƒ¬ã‚¤ãƒ¤ãŒé‡ãªã£ã¦ã‚¯ãƒªãƒƒã‚¯ä¸èƒ½ã«ãªã‚‹ã®ã‚’é˜²æ­¢
          btn.style.pointerEvents = 'auto';
          btn.style.zIndex = '2';
        });
      }
    }

    loadAll();
  </script>
</body>
</html>

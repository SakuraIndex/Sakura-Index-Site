<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸŒ¸æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</title>
<style>
  :root{
    --bg:#0d1016;--panel:#141924;--text:#e8eef9;--muted:#8ea0bf;
    --ring:#1e2a3d;--chip:#1b2333;--accent:#6ad3ff;--up:#54f7a3;--down:#ff6f6f;
  }
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  a{text-decoration:none;color:inherit}
  header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;margin-bottom:24px}
  .wrap{max-width:1200px;margin:auto;padding:24px}
  .title{font-size:26px;font-weight:700;display:flex;align-items:center;gap:8px}
  .meta{font-size:12px;color:var(--muted)}
  .btns{display:flex;gap:8px}
  .btn{background:var(--chip);border:1px solid var(--ring);border-radius:10px;padding:6px 12px;font-size:13px}
  .grid{display:grid;gap:18px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;overflow:hidden}
  .card-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
  .id-left{display:flex;align-items:center;gap:10px}
  .flag{font-size:16px}
  .badge{font-size:12px;background:var(--chip);padding:3px 8px;border-radius:999px;border:1px solid var(--ring);color:var(--muted)}
  .pct{font-weight:700}
  .pct.up{color:var(--up)}.pct.down{color:var(--down)}.pct.na{color:var(--muted)}
  .desc{color:var(--muted);padding:0 16px 8px;font-size:13px}
  .chart{background:#0e131b;border-radius:12px;border:1px solid var(--ring);margin:0 12px 8px;padding:10px;display:flex;align-items:center;justify-content:center;min-height:240px}
  .chart img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;padding:8px 12px 16px}
  .tabs button{background:var(--chip);border:1px solid var(--ring);padding:6px 12px;border-radius:999px;color:var(--muted);cursor:pointer}
  .tabs button.active{color:var(--text);box-shadow:0 0 0 2px var(--accent) inset}
  footer{margin-top:40px;text-align:center;font-size:12px;color:var(--muted);line-height:1.8}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</div>
      <div class="meta">åŒæœŸå®Œäº†: <span id="syncAt">--</span> / ãƒ‡ãƒ¼ã‚¿: docs/charts/*</div>
    </div>
    <div class="btns">
      <a href="https://x.com" target="_blank" class="btn">å…¬å¼Xï¼ˆTwitterï¼‰</a>
      <a href="https://note.com" target="_blank" class="btn">å…¬å¼note</a>
    </div>
  </header>

  <section id="grid" class="grid"></section>

  <footer>
    ãƒ‡ãƒ¼ã‚¿: å„æŒ‡æ•°ã¯ç­‰åŠ é‡æŒ‡æ•°ï¼ˆä»•æ§˜ã¯å„ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰<br>
    ç”»åƒã¯å„æŒ‡æ•°ãƒªãƒã‚¸ãƒˆãƒªã®è‡ªå‹•ç”Ÿæˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’åŒæœŸã—ã¦ã„ã¾ã™ã€‚<br>
    â€»æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ï¼ˆè‡ªå·±è²¬ä»»ï¼‰ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚<br>
    Â© 2025 æ¡œIndex
  </footer>
</div>

<script>
/* =====================
   è¨­å®š
===================== */
const INDEXES = [
  { key:"astra4",      flag:"ğŸ‡¯ğŸ‡µ", name:"Astra4",   tag:"å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼", desc:"å®‡å®™é–¢é€£éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚å¯è¦–åŒ–ã¯ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã«é…æ…®ã€‚"},
  { key:"rbank9",      flag:"ğŸ‡¯ğŸ‡µ", name:"R-BANK9",  tag:"åœ°æ–¹éŠ€è¡Œ",     desc:"åœ°æ–¹éŠ€è¡Œ9éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚æ—¥ä¸­ã¯%ã€é•·æœŸã¯ãƒ¬ãƒ™ãƒ«æ¨ç§»ã‚’è¡¨ç¤ºã€‚"},
  { key:"ain10",       flag:"ğŸ‡ºğŸ‡¸", name:"AIN-10",   tag:"AIé–¢é€£10",     desc:"ç±³AIé–¢é€£10éŠ˜æŸ„ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚çŸ­æœŸãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ è¦³æ¸¬ã«ä¾¿åˆ©ã€‚"},
  { key:"scoin_plus",  flag:"ğŸ‡¯ğŸ‡µ", name:"S-COIN+",  tag:"ä»®æƒ³è³‡ç”£é–¢é€£", desc:"æš—å·è³‡ç”£é–¢é€£ã®ç­‰ã‚¦ã‚§ã‚¤ãƒˆæŒ‡æ•°ã€‚æ—¥ä¸­ã¯é¨°è½ç‡ã€é•·æœŸã¯ãƒ¬ãƒ™ãƒ«æ¨ç§»ã‚’è¡¨ç¤ºã€‚"},
];
const VARS = ["intraday","am","7d","1m","1y"];
const BASE = "docs/charts";                 // ç”»åƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
const META_DIR = `${BASE}/meta`;            // ãƒ¡ã‚¿JSONï¼ˆç„¡ãã¦ã‚‚OKï¼‰
const POST_SUFFIX = "_post_intraday.txt";   // é¨°è½ç‡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å€™è£œ

document.getElementById("syncAt").textContent =
  new Date().toLocaleString("ja-JP",{hour12:false});

/* =====================
   UI æ§‹ç¯‰
===================== */
const grid = document.getElementById("grid");
for (const idx of INDEXES) {
  const el = document.createElement("article");
  el.className = "card";
  el.innerHTML = `
    <div class="card-hd">
      <div class="id-left">
        <span class="flag">${idx.flag}</span>
        <b>${idx.name}</b>
        <span class="badge">${idx.tag}</span>
      </div>
      <div class="pct na" id="${idx.key}-pct">N/A</div>
    </div>
    <p class="desc">${idx.desc}</p>
    <div class="chart"><img id="${idx.key}-img" alt="${idx.name} chart"></div>
    <div class="tabs">
      ${VARS.map(v => `<button data-v="${v}" class="${v==="intraday"?"active":""}">${tabName(v)}</button>`).join("")}
    </div>`;
  grid.appendChild(el);
}

/* =====================
   ãƒ‡ãƒ¼ã‚¿èª­è¾¼ & è¡¨ç¤º
===================== */
(async () => {
  for (const idx of INDEXES) {
    const meta = await fetchJSON(`${META_DIR}/${idx.key}.json`);  // ãªãã¦ã‚‚OK
    await updateCard(idx, meta, "intraday");

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const card = document.getElementById(`${idx.key}-img`).closest(".card");
    card.querySelectorAll(".tabs button").forEach(btn => {
      btn.onclick = async () => {
        card.querySelectorAll(".tabs button").forEach(x => x.classList.remove("active"));
        btn.classList.add("active");
        const v = btn.dataset.v;
        await updateCard(idx, meta, v);
      };
    });
  }
})();

/* =====================
   é–¢æ•°ç¾¤
===================== */
function tabName(v){
  return v==="intraday"?"Intraday":v==="am"?"å‰å ´(AM)":v==="7d"?"7æ—¥":v==="1m"?"1ãƒ¶æœˆ":"1å¹´";
}

async function fetchJSON(url){
  try{
    const r = await fetch(url,{cache:"no-store"});
    if (!r.ok) throw 0;
    return await r.json();
  }catch{ return null; }
}

// ç”»åƒã®å¤šæ®µãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è§£æ±º
async function resolveSnapshotPath(key, variant, meta){
  // 1) meta.snapshots ãŒã‚ã‚Œã°æœ€å„ªå…ˆ
  const m = meta?.snapshots?.[variant];
  if (m) {
    const url = `${BASE}/${m}`;
    if (await exists(url)) return url;
  }

  // 2) ã‚ˆãã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã®ç·å½“ãŸã‚Šï¼ˆå¤§æ–‡å­—å°æ–‡å­—ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼/ãƒã‚¤ãƒ•ãƒ³ï¼‰
  const candidates = [];
  const bases = [
    `${key}_${variant}`, `${key}-${variant}`,
    `${key.toUpperCase()}_${variant.toUpperCase()}`, `${key.toUpperCase()}-${variant.toUpperCase()}`
  ];
  for (const b of bases) {
    candidates.push(`${BASE}/${b}.png`, `${BASE}/${b}.PNG`, `${BASE}/${b}.svg`);
  }

  // 3) æ—§æ¥ã®1æ—¥ãƒ¬ãƒ™ãƒ«è¡¨è¨˜ãªã©ï¼ˆä¾‹: 1d / levelï¼‰
  if (variant==="1y"||variant==="1m"||variant==="7d") {
    candidates.push(`${BASE}/${key}_${variant}_level.png`);
  }
  if (variant==="am") {
    candidates.push(`${BASE}/${key}_intraday_am.png`, `${BASE}/${key}_am.png`);
  }

  for (const c of candidates) {
    if (await exists(c)) return c;
  }
  return null;
}

// é¨°è½ç‡ã®å–å¾—ï¼ˆmeta â†’ ãƒ†ã‚­ã‚¹ãƒˆã®é †ï¼‰
async function resolvePercent(key, meta){
  // 1) meta å„ªå…ˆ
  if (meta?.percent?.intraday != null) return Number(meta.percent.intraday);

  // 2) æ—¢çŸ¥ã® stats.json å½¢å¼ï¼ˆã‚ã‚Œã°ï¼‰
  if (meta?.headlinePercent != null) return Number(meta.headlinePercent);

  // 3) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: *_post_intraday.txt ã‹ã‚‰ "+1.23%" æŠœç²‹
  const txtUrl = `${BASE}/${key}${POST_SUFFIX}`;
  try{
    const r = await fetch(txtUrl, {cache:"no-store"});
    if (r.ok) {
      const t = await r.text();
      const m = t.match(/([+\-]?\d+(?:\.\d+)?)%/);
      if (m) return Number(m[1]);
    }
  }catch{}

  return null; // å–ã‚Œãªã„å ´åˆ
}

// 1px ãƒ€ãƒŸãƒ¼
const BLANK = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
async function exists(url){
  try{ const r=await fetch(url,{method:"HEAD",cache:"no-store"}); return r.ok; }
  catch{ return false; }
}

async function updateCard(idx, meta, variant){
  const pctEl = document.getElementById(`${idx.key}-pct`);
  const imgEl = document.getElementById(`${idx.key}-img`);

  // ç”»åƒ
  const path = await resolveSnapshotPath(idx.key, variant, meta);
  imgEl.src = path ? `${path}?v=${Date.now()}` : BLANK;

  // é¨°è½ç‡ï¼ˆintradayã ã‘ç®—å‡ºï¼ä»–ã‚¿ãƒ–ã§ã‚‚ intraday ã®å€¤ã‚’ãƒ˜ãƒƒãƒ€ã«ç¶­æŒï¼‰
  const p = await resolvePercent(idx.key, meta);
  if (p == null){
    pctEl.textContent = "N/A";
    pctEl.className = "pct na";
  } else if (p > 0){
    pctEl.textContent = `+${p.toFixed(2)}%`;
    pctEl.className = "pct up";
  } else if (p < 0){
    pctEl.textContent = `${p.toFixed(2)}%`;
    pctEl.className = "pct down";
  } else {
    pctEl.textContent = "0.00%";
    pctEl.className = "pct";
  }
}
</script>
</body>
</html>

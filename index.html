<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🌸 桜Index - 公式サイト</title>
  <meta name="description" content="Astra4・S-COIN+・R-BANK9・AIN-10 の4指数を1画面で同時表示。時間軸を一括切替。">
  <style>
    :root{
      --bg:#0e1014; --panel:#171a22; --text:#e9ecf1; --muted:#a7afc0;
      --chip:#232838; --chip-active:#33405c; --ring:#384055; --accent:#79e3d6;
      --pink:#ff86b5;
      --up:#32e0cf; --down:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic","Meiryo",sans-serif;}
    header{padding:28px 20px 12px;text-align:center}
    h1{margin:0 0 8px;font-size:28px;font-weight:800;color:var(--pink)}
    .sub{color:var(--muted);font-size:14px}
    .headLinks{display:flex;gap:8px;justify-content:center;margin-top:10px}
    .headLinks a{padding:8px 12px;border-radius:10px;background:var(--chip);color:#fff;text-decoration:none;box-shadow:inset 0 0 0 1px var(--ring)}
    .toolbar{margin:18px auto 10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .chip{padding:8px 14px;border:none;border-radius:999px;background:var(--chip);color:var(--text);font-weight:600;box-shadow:inset 0 0 0 1px var(--ring);cursor:pointer;transition:.15s}
    .chip:hover{transform:translateY(-1px)}
    .chip.is-active{background:var(--chip-active);box-shadow:0 0 0 2px var(--accent) inset;color:#fff}
    .grid{width:min(1280px,92vw);margin:0 auto 28px;display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border-radius:16px;box-shadow:0 0 0 1px var(--ring);overflow:hidden;transition:box-shadow .3s ease}
    .card.up{box-shadow:0 0 0 2px var(--up)}
    .card.down{box-shadow:0 0 0 2px var(--down)}
    .card__head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--ring)}
    .title{display:flex;align-items:center;gap:10px;font-weight:800}
    .flag{font-size:18px}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#2a3044;color:#cdd7ff}
    .pngnote{color:var(--muted);font-size:12px}
    .delta{font-weight:700;margin-left:6px;font-variant-numeric:tabular-nums}
    .delta.up{color:var(--up)}.delta.down{color:var(--down)}.delta.flat{color:#9aa0a6}
    .imgWrap{position:relative;background:#0b0d12}
    .chart{display:block;width:100%;aspect-ratio:16/9;object-fit:contain}
    .nodata{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#91a0c4;font-weight:700;opacity:0}
    .imgWrap.is-error .nodata{opacity:1}
    .timestamp{text-align:right;font-size:12px;color:var(--muted);padding:6px 10px 10px;border-top:1px solid var(--ring)}
    footer{padding:20px 12px 28px;text-align:center;color:var(--muted);font-size:13px}
    .disclaimer{margin-top:10px;font-size:13px;color:#ffb2b2}
    a{color:#a7dfff}
  </style>
</head>
<body>
  <header>
    <h1>🌸 桜Index - 公式サイト</h1>
    <div class="sub">Astra4・S-COIN+・R-BANK9・AIN-10 を同時表示。時間軸を一括で切替できます。</div>
    <div class="headLinks">
      <a href="https://twitter.com/SakuraIndex" target="_blank">公式X（Twitter）</a>
      <a href="https://note.com/sakuraindex" target="_blank">公式note</a>
    </div>
    <div class="toolbar" id="tfToolbar">
      <button class="chip is-active" data-tf="1d">1日</button>
      <button class="chip" data-tf="7d">1週間</button>
      <button class="chip" data-tf="1m">1ヶ月</button>
      <button class="chip" data-tf="1y">1年</button>
    </div>
  </header>

  <main class="grid">
    <section class="card" data-prefix="astra4">
      <div class="card__head"><div class="title"><span class="flag">🇯🇵</span>Astra4<span class="badge">宇宙ベンチャー</span><span id="delta-astra4" class="delta flat">—</span></div><div class="pngnote">PNGを静的表示</div></div>
      <div class="imgWrap"><img class="chart"/><div class="nodata">No data</div></div><div class="timestamp">最終更新：読込中...</div>
    </section>

    <section class="card" data-prefix="scoin_plus">
      <div class="card__head"><div class="title"><span class="flag">🇯🇵</span>S-COIN+<span class="badge">仮想通貨</span><span id="delta-scoin" class="delta flat">—</span></div><div class="pngnote">PNGを静的表示</div></div>
      <div class="imgWrap"><img class="chart"/><div class="nodata">No data</div></div><div class="timestamp">最終更新：読込中...</div>
    </section>

    <section class="card" data-prefix="rbank9">
      <div class="card__head"><div class="title"><span class="flag">🇯🇵</span>R-BANK9<span class="badge">地方銀行</span><span id="delta-rbank9" class="delta flat">—</span></div><div class="pngnote">PNGを静的表示</div></div>
      <div class="imgWrap"><img class="chart"/><div class="nodata">No data</div></div><div class="timestamp">最終更新：読込中...</div>
    </section>

    <section class="card" data-prefix="ain10">
      <div class="card__head"><div class="title"><span class="flag">🇺🇸</span>AIN-10<span class="badge">AI関連10</span><span id="delta-ain10" class="delta flat">—</span></div><div class="pngnote">PNGを静的表示</div></div>
      <div class="imgWrap"><img class="chart"/><div class="nodata">No data</div></div><div class="timestamp">最終更新：読込中...</div>
    </section>
  </main>

  <footer>
    データ：等加重指数（詳細は各リポジトリ参照）<br>© 2025 桜Index
    <div class="disclaimer">※ 本サイトは投資助言ではありません。</div>
  </footer>

  <script>
    const ASSET_BASE="docs/charts";const DEFAULT_TF="1d";
    const cacheBust=()=>new Date().toISOString().replace(/\D/g,"").slice(0,14);
    const buildSrc=(p,tf)=>`${ASSET_BASE}/${p}_${tf}.png?v=${cacheBust()}`;
    let currentTf=DEFAULT_TF;
    function updateAll(tf){
      currentTf=tf;
      document.querySelectorAll(".card").forEach(c=>{
        const p=c.dataset.prefix,img=c.querySelector("img"),wrap=c.querySelector(".imgWrap"),ts=c.querySelector(".timestamp");
        wrap.classList.remove("is-error");img.onerror=()=>{wrap.classList.add("is-error");ts.textContent="最終更新：データなし"};
        img.onload=()=>{const jst=new Date(Date.now()+9*3600e3);ts.textContent=`最終更新：${jst.toISOString().slice(0,16).replace('T',' ')}`};
        img.src=buildSrc(p,tf);
      });
    }
    document.getElementById("tfToolbar").onclick=e=>{
      const b=e.target.closest("button[data-tf]");if(b)updateAll(b.dataset.tf);
    };updateAll(currentTf);

    // === 改良版変化率表示 ===
    (async()=>{
      const SERIES=[
        {k:"astra4",i:"astra4_intraday.csv",h:"astra4_history.csv",a:"delta-astra4"},
        {k:"scoin_plus",i:"scoin_plus_intraday.csv",h:"scoin_plus_history.csv",a:"delta-scoin"},
        {k:"rbank9",i:"rbank9_intraday.csv",h:"rbank9_history.csv",a:"delta-rbank9"},
        {k:"ain10",i:"ain10_intraday.csv",h:"ain10_history.csv",a:"delta-ain10"},
      ];
      const toJST=d=>new Date(d.getTime()+9*3600e3);
      const nowJST=new Date(Date.now()+9*3600e3);
      const today=nowJST.toISOString().slice(0,10);
      const minDen=1e-6,cap=300;
      async function get(url){const r=await fetch(url,{cache:"no-store"});if(!r.ok)throw 0;return await r.text();}
      function parse(text){
        const lines=text.trim().split(/\r?\n/).slice(1);
        return lines.map(l=>{
          const c=l.split(",").map(v=>v.trim());
          const t=new Date(c[0]);
          const vals=c.slice(1).map(Number).filter(v=>isFinite(v));
          return{t,v:vals.reduce((a,b)=>a+b,0)/vals.length};
        }).filter(r=>isFinite(r.v)&&r.t);
      }
      function pct(a,b){if(Math.abs(b)<minDen)return null;const p=((a-b)/Math.abs(b))*100;if(!isFinite(p)||Math.abs(p)>cap)return null;return p;}
      for(const s of SERIES){
        let d=null;
        try{
          const txt=await get(`${ASSET_BASE}/${s.i}?v=${cacheBust()}`);
          const arr=parse(txt).sort((a,b)=>a.t-b.t);
          const latest=arr[arr.length-1];const first=arr[0];
          if(latest&&first){
            // UTC→JST補正、直近5h以内なら「今日」と扱う
            const diffH=(nowJST-latest.t)/3600000;
            if(toJST(latest.t).toISOString().slice(0,10)===today||diffH<5)d=pct(latest.v,first.v);
          }
          if(d===null){
            const htxt=await get(`${ASSET_BASE}/${s.h}?v=${cacheBust()}`);
            const hist=parse(htxt).sort((a,b)=>a.t-b.t);
            if(hist.length>=2)d=pct(hist.at(-1).v,hist.at(-2).v);
          }
        }catch{}
        const el=document.getElementById(s.a),card=document.querySelector(`[data-prefix="${s.k}"]`);
        el.classList.remove("up","down","flat");card.classList.remove("up","down");
        if(d==null){el.textContent="—";el.classList.add("flat");continue;}
        el.textContent=(d>=0?"+":"")+d.toFixed(2)+"%";
        const cls=d>0?"up":d<0?"down":"flat";el.classList.add(cls);card.classList.add(cls);
      }
    })();
  </script>
</body>
</html>

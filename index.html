<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/cherry-blossom.svg" />
  <style>
    :root {
      --bg: #0d0d0f;
      --card: #1a1a1f;
      --axis: #0b0c10;
      --text: #ddd;
      --muted: #aaa;
      --pos: #28e07c;
      --neg: #ff4d4d;
      --chip: #333;
      --ring: #3a3a3f;
    }
    * { box-sizing: border-box; }
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter','Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif;
      margin: 0;
    }
    header { text-align: center; padding: 20px 0 10px; }
    h1 { font-size: 1.9rem; margin: 0 0 6px; }
    .info { font-size: 0.9rem; color: var(--muted); margin-bottom: 10px; }
    .links { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; }
    .links a {
      background: var(--chip); color: #fff; text-decoration: none;
      padding: 8px 14px; border-radius: 10px; font-size: 0.9rem;
      border: 1px solid var(--ring);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(420px, 1fr));
      gap: 24px;
      padding: 0 28px 28px;
      max-width: 1280px;
      margin: 0 auto 28px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 0 12px rgba(255,255,255,0.05);
      display: flex; flex-direction: column; gap: 12px;
      border: 1px solid var(--ring);
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .title { display: flex; align-items: center; gap: 8px; font-weight: 700; }
    .category {
      font-size: 0.8rem; background: var(--chip); color: #ccc;
      padding: 2px 6px; border-radius: 6px;
    }
    .percent { font-weight: 700; }
    .percent.positive { color: var(--pos); }
    .percent.negative { color: var(--neg); }
    .chart {
      width: 100%;
      border-radius: 12px;
      background: var(--axis);
      overflow: hidden;
      border: 1px solid var(--ring);
      position: relative;
    }
    /* ç”»åƒã®æ¯”ç‡ã¨åã¾ã‚Šã‚’çµ±ä¸€ï¼ˆã‚µã‚¤ã‚ºå´©ã‚Œå¯¾ç­–ï¼‰ */
    .chart img {
      display: block;
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
      object-fit: contain;
      background: var(--axis);
    }
    .tabs {
      display: flex; gap: 10px; flex-wrap: wrap;
    }
    .tab {
      background: var(--chip);
      color: #fff;
      border: 1px solid var(--ring);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
    }
    .tab.active {
      background: #4a4a50;
      border-color: #75757d;
    }
    .badge {
      background: var(--chip);
      color: #ccc;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.78rem;
      border: 1px solid var(--ring);
    }
    footer {
      text-align: center; font-size: 0.8rem; color: #888;
      margin-top: 8px; padding-bottom: 20px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header>
  <h1>ğŸŒ¸ æ¡œIndex - å…¬å¼ã‚µã‚¤ãƒˆ</h1>
  <div class="info" id="sync-info">åŒæœŸå®Œäº†: ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
  <div class="links">
    <a href="https://x.com/Sakura_Index" target="_blank" rel="noopener noreferrer">å…¬å¼Xï¼ˆTwitterï¼‰</a>
    <a href="https://note.com/sakura_index" target="_blank" rel="noopener noreferrer">å…¬å¼note</a>
  </div>
</header>

<main class="grid" id="charts"></main>

<footer>
  ãƒ‡ãƒ¼ã‚¿ï¼šç­‰åŠ é‡æŒ‡æ•°ï¼ˆä»•æ§˜ã¯å„ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰ / ç”»åƒã¯å„æŒ‡æ•°ãƒªãƒã®è‡ªå‹•ç”Ÿæˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’åŒæœŸã—ã¦ã„ã¾ã™ã€‚<br/>
  â€»æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ï¼ˆè‡ªå·±è²¬ä»»ï¼‰ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚<br/>
  Â© 2025 æ¡œIndex
</footer>

<script>
/**
 * 4æŒ‡æ•°ã®å®šç¾©ï¼ˆprefixã¯ charts é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«æ¥é ­è¾ï¼‰
 * - ç”»åƒã¯ ${prefix}_intraday.png / ${prefix}_intraday_am.png / ${prefix}_7d.png / ${prefix}_1m.png / ${prefix}_1y.png
 *   ãŒåŸºæœ¬ã€‚ç„¡ã‘ã‚Œã°å€™è£œã‚’é †ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã€‚
 * - é¨°è½ç‡ã¯ ${prefix}_stats.json ã® pct_1d ã‚’è¡¨ç¤ºã€‚ç•°å¸¸å€¤ã¯è‡ªå‹•æ­£è¦åŒ–ã€‚
 */
const INDEXES = [
  { id: 'astra4',   name: 'Astra4',   category: 'å®‡å®™ãƒ™ãƒ³ãƒãƒ£ãƒ¼', flag: 'ğŸ‡¯ğŸ‡µ', prefix: 'astra4' },
  { id: 'rbank9',   name: 'R-BANK9',  category: 'åœ°æ–¹éŠ€è¡Œ',       flag: 'ğŸ‡¯ğŸ‡µ', prefix: 'rbank9' },
  { id: 'ain10',    name: 'AIN-10',   category: 'AIé–¢é€£10',       flag: 'ğŸ‡ºğŸ‡¸', prefix: 'ain10' },
  { id: 'scoin_plus', name: 'S-COIN+', category: 'ä»®æƒ³é€šè²¨é–¢é€£',   flag: 'ğŸ‡¯ğŸ‡µ', prefix: 'scoin_plus' },
];

// ç”»é¢ã«å‡ºã™ã‚¿ãƒ–ï¼ˆã‚­ãƒ¼ã¯ loadImage ã® rangeï¼‰
const TABS = [
  { key: 'intraday',  label: 'Intraday' },
  { key: 'am',        label: 'å‰å ´(AM)' },
  { key: '7d',        label: '7æ—¥' },
  { key: '1m',        label: '1ãƒ¶æœˆ' },
  { key: '1y',        label: '1å¹´' },
];

function fmtPct(v) {
  if (v === null || v === undefined || isNaN(v)) return 'N/A';
  const s = (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
  return s;
}

// pct_1d ã®ç•°å¸¸ã‚’è‡ªå‹•ä¿®æ­£ï¼ˆ15%ä»¥ä¸Šã¯ã€Œã™ã§ã«ï¼…å˜ä½ã€ã¨ã¿ãªã—ã¦Ã·100ï¼‰
function normalizePctMaybe(p) {
  if (p == null || isNaN(p)) return null;
  let v = Number(p);
  if (Math.abs(v) > 15) v = v / 100;
  return v;
}

// ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆHEAD ãŒé®ã‚‰ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ GET ã§ç¢ºèªï¼no-storeï¼‰
async function fileExists(url) {
  try {
    const res = await fetch(url, { method: 'GET', cache: 'no-store' });
    return res.ok;
  } catch (e) {
    return false;
  }
}

// ç”»åƒURLã‚’ç¯„å›²åˆ¥ã«æ±ºå®šã—ã€å­˜åœ¨ã—ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
async function pickImage(prefix, range) {
  const base = `docs/charts/${prefix}`;
  const candidates = [];

  if (range === 'intraday') {
    candidates.push(`${base}_intraday.png`);
    // levelç³»ã®1dãŒã‚ã‚Œã°æœ€å¾Œã®æ‰‹æ®µã§
    candidates.push(`${base}_1d.png`);
  } else if (range === 'am') {
    candidates.push(`${base}_intraday_am.png`);
    candidates.push(`${base}_intraday.png`);
  } else if (range === '7d') {
    candidates.push(`${base}_7d.png`, `${base}_1w.png`, `${base}_1d.png`, `${base}_intraday.png`);
  } else if (range === '1m') {
    candidates.push(`${base}_1m.png`, `${base}_30d.png`, `${base}_1d.png`, `${base}_intraday.png`);
  } else if (range === '1y') {
    candidates.push(`${base}_1y.png`, `${base}_12m.png`, `${base}_1d.png`, `${base}_intraday.png`);
  } else {
    candidates.push(`${base}_intraday.png`, `${base}_1d.png`);
  }

  for (const url of candidates) {
    if (await fileExists(url)) return url;
  }
  return null;
}

// stats.json ã‚’èª­ã‚€ï¼ˆprefix_stats.json æƒ³å®šï¼‰
async function loadStats(prefix) {
  const path = `docs/charts/${prefix}_stats.json`;
  try {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) return null;
    const j = await res.json();
    return j || null;
  } catch {
    return null;
  }
}

function buildCardHTML(idx) {
  return `
    <div class="card" data-id="${idx.id}" data-range="intraday">
      <div class="card-header">
        <div class="title">${idx.flag} ${idx.name} <span class="category">${idx.category}</span></div>
        <div class="percent" id="${idx.id}__pct">N/A</div>
      </div>
      <div class="chart"><img id="${idx.id}__img" alt="${idx.name} chart" loading="eager" /></div>
      <div class="tabs" id="${idx.id}__tabs">
        ${TABS.map(t => `<div class="tab ${t.key==='intraday'?'active':''}" data-range="${t.key}">${t.label}</div>`).join('')}
      </div>
    </div>
  `;
}

async function updateImageFor(indexId, prefix, range) {
  const img = document.getElementById(`${indexId}__img`);
  const url = await pickImage(prefix, range);
  if (url) {
    img.src = `${url}?v=${Date.now()}`;
    img.alt = `${indexId} ${range} chart`;
  } else {
    // ç”»åƒãŒå…¨æ»…ãªã‚‰ã€ŒNo dataã€ç”»åƒã‚’åˆæˆï¼ˆæœ€ä½é™ã®UXï¼‰
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='1280' height='720'><rect width='100%' height='100%' fill='#0b0c10'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#888' font-size='32'>No data</text></svg>`);
    img.src = `data:image/svg+xml,${svg}`;
    img.alt = `${indexId} no data`;
  }
}

async function updatePctFor(indexId, prefix) {
  const el = document.getElementById(`${indexId}__pct`);
  const stats = await loadStats(prefix);

  if (!stats || stats.pct_1d == null || isNaN(stats.pct_1d)) {
    el.textContent = 'N/A';
    el.classList.remove('positive','negative');
    return;
  }
  const n = normalizePctMaybe(stats.pct_1d);
  if (n == null || isNaN(n)) {
    el.textContent = 'N/A';
    el.classList.remove('positive','negative');
    return;
  }
  el.textContent = fmtPct(n);
  el.classList.toggle('positive', n >= 0);
  el.classList.toggle('negative', n < 0);
}

function wireTabs(indexId, prefix) {
  const wrap = document.getElementById(`${indexId}__tabs`);
  wrap.addEventListener('click', async (e) => {
    const btn = e.target.closest('.tab');
    if (!btn) return;
    // activeåˆ‡æ›¿
    wrap.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const range = btn.getAttribute('data-range');
    const card = document.querySelector(`.card[data-id="${indexId}"]`);
    card?.setAttribute('data-range', range);
    await updateImageFor(indexId, prefix, range);
  });
}

async function loadAll() {
  const container = document.getElementById('charts');
  const syncInfo  = document.getElementById('sync-info');
  const time = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
  syncInfo.textContent = `åŒæœŸå®Œäº†: ${time} / ãƒ‡ãƒ¼ã‚¿: charts/*`;

  // ã‚«ãƒ¼ãƒ‰æç”»
  container.innerHTML = INDEXES.map(buildCardHTML).join('');

  // ç”»åƒãƒ»pctã®åˆæœŸèª­ã¿è¾¼ã¿ï¼‹ã‚¿ãƒ–é…ç·š
  for (const idx of INDEXES) {
    wireTabs(idx.id, idx.prefix);
    await updateImageFor(idx.id, idx.prefix, 'intraday');
    // é¨°è½ç‡ï¼ˆç•°å¸¸å€¤ã¯ normalizePctMaybe ãŒèª¿æ•´ï¼‰
    await updatePctFor(idx.id, idx.prefix);
  }
}

loadAll();
</script>
</body>
</html>

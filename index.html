<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🌸 桜Index - 公式サイト</title>
  <link rel="icon" href="https://emojiapi.dev/api/v1/cherry-blossom.svg" />
  <style>
    :root {
      --bg: #0d0d0f;
      --card: #1a1a1f;
      --axis: #0f1014;
      --text: #e6e6e6;
      --muted: #aab;
      --pos: #28e07c;
      --neg: #ff5e5e;
      --chip: #2a2b31;
      --chip-active: #3b3d46;
      --ring: #2f3340;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 80% -10%, #14151b 0%, #0d0d0f 40%) fixed,
                  radial-gradient(1000px 800px at 10% -20%, #14151b 0%, #0d0d0f 50%) fixed,
                  var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
    }
    header { text-align: center; padding: 24px 12px 4px; }
    h1 { font-size: 2rem; margin: 0 0 6px; }
    .info { font-size: 0.9rem; color: var(--muted); margin-bottom: 12px; }
    .links { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; }
    .links a {
      background: var(--chip); color: #fff; text-decoration: none;
      padding: 8px 14px; border-radius: 10px; font-size: 0.92rem; border: 1px solid #2a2c32;
    }
    .links a:hover { background: var(--chip-active); }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(360px, 1fr));
      gap: 28px;
      padding: 0 28px 34px;
      max-width: 1380px;
      margin: 0 auto;
    }
    .card {
      background: linear-gradient(0deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.02) 100%), var(--card);
      border: 1px solid var(--ring);
      border-radius: 18px;
      padding: 16px 16px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      display: flex; flex-direction: column; gap: 12px;
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 10px; flex-wrap: wrap;
    }
    .title { display: flex; align-items: center; gap: 8px; font-weight: 800; letter-spacing: .2px;}
    .category {
      font-size: 0.8rem; background: var(--chip); color: #c9ccdf;
      padding: 2px 6px; border-radius: 6px; border: 1px solid #2d313b;
    }
    .percent { font-weight: 800; min-width: 72px; text-align: right; }
    .percent.positive { color: var(--pos); }
    .percent.negative { color: var(--neg); }

    /* 統一チャート枠：16:9 / 余白も含めきれいに収まる */
    .chart {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 12px;
      background: var(--axis);
      overflow: hidden;
      border: 1px solid #22252d;
    }
    .chart img {
      width: 100%; height: 100%;
      object-fit: contain; display: block; background: var(--axis);
    }

    /* レンジ切り替え */
    .range-row {
      display: flex; gap: 10px; margin-top: 4px; flex-wrap: wrap;
    }
    .range-btn {
      appearance: none; border: 1px solid #2c2f38; color: #dde;
      background: var(--chip); border-radius: 999px; padding: 8px 14px; font-weight: 600;
      cursor: pointer; user-select: none; position: relative; z-index: 1;
    }
    .range-btn:hover { background: var(--chip-active); }
    .range-btn.active {
      background: #2f3440; border-color: #3b4050;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    footer {
      text-align: center; font-size: 0.86rem; color: #98a1b3;
      margin-top: 6px; padding: 24px 12px 28px;
    }

    @media (max-width: 1080px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>🌸 桜Index - 公式サイト</h1>
    <div class="info" id="sync-info">同期完了: ロード中...</div>
    <div class="links">
      <a href="https://x.com/Sakura_Index" target="_blank" rel="noopener noreferrer">公式X（Twitter）</a>
      <a href="https://note.com/sakura_index" target="_blank" rel="noopener noreferrer">公式note</a>
    </div>
  </header>

  <main class="grid" id="cards"></main>

  <footer>
    データ：等加重指数（仕様は各リポジトリ参照） / 画像は各指数リポの自動生成スナップショットを同期しています。<br/>
    ※本サイトは投資助言ではありません。投資判断はご自身の責任（自己責任）でお願いします。<br/>
    © 2025 桜Index
  </footer>

  <script>
    // === 表示する指数とID（ファイル名の接頭辞） ===
    const INDICES = [
      { id: 'astra4',   name: 'ASTRA4',  category: '宇宙ベンチャー', flag: '🇯🇵' },
      { id: 'rbank9',   name: 'R-BANK9', category: '地方銀行',       flag: '🇯🇵' },
      { id: 'ain10',    name: 'AIN-10',  category: 'AI関連10',       flag: '🇺🇸' },
      { id: 'scoin_plus', name: 'S-COIN+', category: '仮想通貨関連', flag: '🇯🇵' },
    ];

    // レンジ→画像ファイル名の対応
    const RANGE_TO_FILE = {
      intraday: (id) => `docs/charts/${id}_intraday.png`,
      am      : (id) => `docs/charts/${id}_am.png`,
      '7d'    : (id) => `docs/charts/${id}_7d.png`,
      '1m'    : (id) => `docs/charts/${id}_1m.png`,
      '1y'    : (id) => `docs/charts/${id}_1y.png`,
    };

    // レンジ→％を逆算するときの基準キー候補
    const RANGE_TO_ANCHOR_KEYS = {
      intraday: ['prev_close', 'yesterday_close', 'anchor_1d'],
      am      : ['am_prev_close', 'prev_close'], // 無ければ通常前日終値
      '7d'    : ['anchor_7d', 'week_anchor'],
      '1m'    : ['anchor_1m', 'month_anchor'],
      '1y'    : ['anchor_1y', 'year_anchor'],
    };

    // レンジ→statsの生％候補キー
    const RANGE_TO_PCT_KEYS = {
      intraday: ['pct_intraday', 'pct_1d', 'pct'], // よくある名前を順に
      am      : ['pct_am', 'am_pct'],
      '7d'    : ['pct_7d'],
      '1m'    : ['pct_1m'],
      '1y'    : ['pct_1y'],
    };

    // 便利関数：配列のキーを順に見て最初の数値を返す
    function firstNumber(obj, keys) {
      if (!obj) return null;
      for (const k of keys) {
        const v = obj[k];
        if (typeof v === 'number' && Number.isFinite(v)) return v;
      }
      return null;
    }

    // 便利関数：レンジ毎の％を stats から取得（無ければ last/anchor で逆算）
    function getPercentForRange(stats, range) {
      if (!stats || typeof stats !== 'object') return null;

      // 1) 生の％が入っていればそれを採用
      const direct = firstNumber(stats, RANGE_TO_PCT_KEYS[range] || []);
      if (direct !== null) return direct;

      // 2) last と anchor から逆算
      const last = firstNumber(stats, ['last', 'last_value', 'close']);
      if (last === null) return null;

      const anchor = firstNumber(stats, RANGE_TO_ANCHOR_KEYS[range] || []);
      if (anchor === null || anchor === 0) return null;

      const pct = ((last / anchor) - 1) * 100;
      // 異常値ガード（±100%超過は欠損扱い）
      if (!Number.isFinite(pct) || Math.abs(pct) > 100) return null;
      return pct;
    }

    function fmtPct(v) {
      if (v === null || v === undefined || isNaN(v)) return 'N/A';
      const s = (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
      return s;
    }

    function nowJST() {
      return new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
    }

    // 1カードを構築
    function createCard(idx) {
      const card = document.createElement('div');
      card.className = 'card';
      card.id = `card-${idx.id}`;

      card.innerHTML = `
        <div class="card-header">
          <div class="title">${idx.flag} ${idx.name} <span class="category">${idx.category}</span></div>
          <div class="percent" id="${idx.id}-percent">N/A</div>
        </div>
        <div class="chart">
          <img id="${idx.id}-img" alt="${idx.name} chart" loading="eager" />
        </div>
        <div class="range-row" role="tablist" aria-label="${idx.name} ranges">
          <button class="range-btn active" data-range="intraday" id="${idx.id}-btn-intraday">Intraday</button>
          <button class="range-btn" data-range="am"       id="${idx.id}-btn-am">前場(AM)</button>
          <button class="range-btn" data-range="7d"       id="${idx.id}-btn-7d">7日</button>
          <button class="range-btn" data-range="1m"       id="${idx.id}-btn-1m">1ヶ月</button>
          <button class="range-btn" data-range="1y"       id="${idx.id}-btn-1y">1年</button>
        </div>
      `;
      return card;
    }

    // レンジ切替処理（画像と％の更新）
    function applyRange(id, range, stats) {
      const img = document.getElementById(`${id}-img`);
      const pctEl = document.getElementById(`${id}-percent`);
      if (!img || !pctEl) return;

      const ver = (stats && (stats.updated_at || stats.version)) ? encodeURIComponent(stats.updated_at || stats.version) : Date.now();
      img.src = `${RANGE_TO_FILE[range](id)}?v=${ver}`;

      const pct = getPercentForRange(stats, range);
      pctEl.textContent = fmtPct(pct);
      pctEl.classList.toggle('positive', pct !== null && pct >= 0);
      pctEl.classList.toggle('negative', pct !== null && pct < 0);

      // ボタンの active 切替
      const card = document.getElementById(`card-${id}`);
      const btns = card.querySelectorAll('.range-btn');
      btns.forEach(b => b.classList.toggle('active', b.dataset.range === range));
    }

    async function loadAll() {
      const container = document.getElementById('cards');
      const syncInfo  = document.getElementById('sync-info');
      syncInfo.textContent = `同期完了: ${nowJST()} / データ: charts/*`;

      for (const idx of INDICES) {
        const card = createCard(idx);
        container.appendChild(card);

        // まずは stats を取得
        const statsPath = `docs/charts/${idx.id}_stats.json`;
        let stats = null;
        try {
          const res = await fetch(statsPath, { cache: 'no-store' });
          if (res.ok) { stats = await res.json(); }
        } catch (e) { /* noop */ }

        // 既定は intraday（RBANK9 の “no data 1d” を避ける）
        applyRange(idx.id, 'intraday', stats);

        // クリックで切替
        const cardEl = document.getElementById(`card-${idx.id}`);
        cardEl.querySelectorAll('.range-btn').forEach(btn => {
          btn.addEventListener('click', (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            const range = btn.dataset.range;
            applyRange(idx.id, range, stats);
          }, { passive: true });
          // レイヤが重なってクリック不能になるのを防止
          btn.style.pointerEvents = 'auto';
          btn.style.zIndex = '2';
        });
      }
    }

    loadAll();
  </script>
</body>
</html>

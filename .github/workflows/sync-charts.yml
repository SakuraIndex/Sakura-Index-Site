name: Sync charts to site (intraday + 7d/1m/1y + stats)

on:
  workflow_dispatch:
  schedule:
    - cron: '10 * * * *'  # 毎時10分にサイトへ取り込み

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Pull latest charts from index repos
        shell: bash
        run: |
          set -euo pipefail

          # dst
          d_ast="docs/charts/ASTRA4"
          d_rbk="docs/charts/R_BANK9"
          d_ain="docs/charts/AIN10"
          d_scp="docs/charts/S-COIN+"
          mkdir -p "$d_ast" "$d_rbk" "$d_ain" "$d_scp"

          fetch(){ url="$1"; out="$2"; echo "-> $out <= $url"; curl -fsSL "$url" -o "$out" || true; }

          # src
          b_ast="https://raw.githubusercontent.com/SakuraIndex/3_Sakura_Space/main/docs/outputs"
          b_rbk="https://raw.githubusercontent.com/SakuraIndex/R-BANK9/main/docs/outputs"
          b_ain="https://raw.githubusercontent.com/SakuraIndex/AIN-10/main/docs/outputs"
          b_scp="https://raw.githubusercontent.com/SakuraIndex/S-COIN-/main/docs/outputs"

          # ===== ASTRA4 (level) =====
          fetch "$b_ast/astra4_1d.png" "$d_ast/intraday.png"
          fetch "$b_ast/astra4_7d.png" "$d_ast/7d.png"
          fetch "$b_ast/astra4_1m.png" "$d_ast/1m.png"
          fetch "$b_ast/astra4_1y.png" "$d_ast/1y.png"
          fetch "$b_ast/astra4_stats.json" "$d_ast/stats.json"
          fetch "$b_ast/_last_run.txt"    "$d_ast/last_run.txt"

          # ===== R-BANK9 (%) =====
          fetch "$b_rbk/rbank9_1d.png"   "$d_rbk/intraday.png"
          fetch "$b_rbk/rbank9_7d.png"   "$d_rbk/7d.png"
          fetch "$b_rbk/rbank9_1m.png"   "$d_rbk/1m.png"
          fetch "$b_rbk/rbank9_1y.png"   "$d_rbk/1y.png"
          fetch "$b_rbk/rbank9_stats.json" "$d_rbk/stats.json"
          fetch "$b_rbk/_last_run.txt"     "$d_rbk/last_run.txt"

          # ===== AIN-10 (%) =====
          fetch "$b_ain/ain10_1d.png"    "$d_ain/intraday.png"
          fetch "$b_ain/ain10_7d.png"    "$d_ain/7d.png"
          fetch "$b_ain/ain10_1m.png"    "$d_ain/1m.png"
          fetch "$b_ain/ain10_1y.png"    "$d_ain/1y.png"
          fetch "$b_ain/ain10_stats.json" "$d_ain/stats.json"
          fetch "$b_ain/_last_run.txt"    "$d_ain/last_run.txt"

          # ===== S-COIN+ (%) =====
          fetch "$b_scp/scoin_plus_1d.png" "$d_scp/intraday.png"
          fetch "$b_scp/scoin_plus_7d.png" "$d_scp/7d.png"
          fetch "$b_scp/scoin_plus_1m.png" "$d_scp/1m.png"
          fetch "$b_scp/scoin_plus_1y.png" "$d_scp/1y.png"
          fetch "$b_scp/scoin_plus_stats.json" "$d_scp/stats.json"
          fetch "$b_scp/_last_run.txt"        "$d_scp/last_run.txt"

          # 旧配置の掃除（任意）
          git rm -f docs/charts/ain10_*.png docs/charts/*_history.csv docs/charts/*_intraday.png 2>/dev/null || true

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/charts/**/*
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "chore(site): sync intraday & long-term charts (7d/1m/1y) + stats + last_run"
            git push
          fi

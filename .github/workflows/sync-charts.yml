name: Sync charts to site (intraday + 7d/1m/1y + stats)

on:
  workflow_dispatch:
  schedule:
    - cron: '10 * * * *'  # 毎時10分

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Prepare tools
        run: |
          set -euo pipefail
          echo "curl version:"
          curl --version

      - name: Pull latest charts from index repos (robust)
        shell: bash
        run: |
          set -euo pipefail

          # ====== dst ======
          d_ast="docs/charts/ASTRA4"
          d_rbk="docs/charts/R_BANK9"
          d_ain="docs/charts/AIN10"
          d_scp="docs/charts/S-COIN+"
          mkdir -p "$d_ast" "$d_rbk" "$d_ain" "$d_scp"

          # ====== src ======
          b_ast="https://raw.githubusercontent.com/SakuraIndex/3_Sakura_Space/main/docs/outputs"
          b_rbk="https://raw.githubusercontent.com/SakuraIndex/R-BANK9/main/docs/outputs"
          b_ain="https://raw.githubusercontent.com/SakuraIndex/AIN-10/main/docs/outputs"
          b_scp="https://raw.githubusercontent.com/SakuraIndex/S-COIN-/main/docs/outputs"

          # ====== helpers ======
          # HEAD検査：200 且つ image/* 且つ 4KB以上 を OK とみなす
          head_ok () {
            local url="$1"
            local h status ctype clen
            h="$(curl -fsSLI "$url" || true)"
            [[ -n "$h" ]] || return 1
            status="$(printf '%s' "$h" | awk 'toupper($0) ~ /^HTTP/ {code=$2} END{print code}')"
            ctype="$(printf '%s' "$h" | awk 'BEGIN{IGNORECASE=1} /^content-type:/ {print $2}' | tr -d '\r')"
            clen="$(printf '%s' "$h" | awk 'BEGIN{IGNORECASE=1} /^content-length:/ {print $2}' | tr -d '\r')"
            [[ "$status" == "200" ]] || return 1
            [[ "$ctype" == image/* || "$ctype" =~ ^image/ ]] || return 1
            # 4096 bytes threshold（小さすぎるPNGはだいたい 'No data' か壊れ）
            [[ "${clen:-0}" -ge 4096 ]] || return 1
            return 0
          }

          # ファイルを安全に取得（head_okを通らなければ保存しない）
          fetch_img () {
            local url="$1" out="$2"
            if head_ok "$url"; then
              echo "GET IMG OK: $url -> $out"
              curl -fsSL "$url" -o "$out"
              return 0
            else
              echo "SKIP IMG : $url (head check NG)"
              return 1
            fi
          }

          # テキストは 200 なら保存
          fetch_txt () {
            local url="$1" out="$2"
            if curl -fsSL "$url" -o "$out.tmp"; then
              mv "$out.tmp" "$out"
              echo "GET TXT OK: $url -> $out"
              return 0
            else
              echo "SKIP TXT : $url"
              rm -f "$out.tmp" || true
              return 1
            fi
          }

          # 候補リストから最初のヒットを保存（画像）
          copy_first_img () {
            local out="$1"; shift
            local hit=""
            for u in "$@"; do
              if fetch_img "$u" "$out"; then hit=1; break; fi
            done
            [[ -n "$hit" ]]
          }

          # 候補リストから最初のヒットを保存（テキスト）
          copy_first_txt () {
            local out="$1"; shift
            local hit=""
            for u in "$@"; do
              if fetch_txt "$u" "$out"; then hit=1; break; fi
            done
            [[ -n "$hit" ]]
          }

          # ====== candidates ======
          scoin_png() { # $1: suffix (1d/7d/1m/1y/intraday)
            echo \
              "$b_scp/scoin_plus_$1.png" \
              "$b_scp/s_coin_plus_$1.png" \
              "$b_scp/s-coin_plus_$1.png" \
              "$b_scp/s_coin__${1}.png"
          }
          ain_png() { # $1: suffix
            echo \
              "$b_ain/ain10_$1.png" \
              "$b_ain/ain_10_$1.png" \
              "$b_ain/ain-10_$1.png"
          }
          scoin_txt_post() {
            echo \
              "$b_scp/scoin_plus_post_intraday.txt" \
              "$b_scp/s_coin_plus_post_intraday.txt" \
              "$b_scp/s-coin_plus_post_intraday.txt" \
              "$b_scp/s_coin__post_intraday.txt" \
              "$b_scp/scoin_plus_intraday_post.txt" \
              "$b_scp/s_coin_plus_intraday_post.txt" \
              "$b_scp/s-coin_plus_intraday_post.txt" \
              "$b_scp/s_coin__intraday_post.txt"
          }
          ain_txt_post() {
            echo \
              "$b_ain/ain10_post_intraday.txt" \
              "$b_ain/ain10_intraday_post.txt" \
              "$b_ain/ain_10_post_intraday.txt" \
              "$b_ain/ain_10_intraday_post.txt" \
              "$b_ain/ain-10_post_intraday.txt" \
              "$b_ain/ain-10_intraday_post.txt"
          }

          # ====== ASTRA4 ======
          copy_first_img "$d_ast/intraday.png"   "$b_ast/astra4_1d.png"   || true
          copy_first_img "$d_ast/7d.png"         "$b_ast/astra4_7d.png"   || true
          copy_first_img "$d_ast/1m.png"         "$b_ast/astra4_1m.png"   || true
          copy_first_img "$d_ast/1y.png"         "$b_ast/astra4_1y.png"   || true
          copy_first_txt "$d_ast/intraday.txt"   "$b_ast/astra4_post_intraday.txt" "$b_ast/astra4_intraday_post.txt" "$b_ast/astra4_intraday.txt" || true
          copy_first_txt "$d_ast/stats.json"     "$b_ast/astra4_stats.json" || true
          fetch_txt "$b_ast/_last_run.txt" "$d_ast/last_run.txt" || date -u +'%Y-%m-%dT%H:%M:%SZ' > "$d_ast/last_run.txt"

          # ====== R-BANK9 ======
          copy_first_img "$d_rbk/intraday.png"   "$b_rbk/rbank9_1d.png"   || true
          copy_first_img "$d_rbk/7d.png"         "$b_rbk/rbank9_7d.png"   || true
          copy_first_img "$d_rbk/1m.png"         "$b_rbk/rbank9_1m.png"   || true
          copy_first_img "$d_rbk/1y.png"         "$b_rbk/rbank9_1y.png"   || true
          copy_first_txt "$d_rbk/intraday.txt"   "$b_rbk/rbank9_post_intraday.txt" "$b_rbk/rbank9_intraday_post.txt" "$b_rbk/rbank9_intraday.txt" || true
          copy_first_txt "$d_rbk/stats.json"     "$b_rbk/rbank9_stats.json" || true
          fetch_txt "$b_rbk/_last_run.txt" "$d_rbk/last_run.txt" || date -u +'%Y-%m-%dT%H:%M:%SZ' > "$d_rbk/last_run.txt"

          # ====== AIN-10 ======
          copy_first_img "$d_ain/intraday.png"   $(ain_png 1d)   || true
          copy_first_img "$d_ain/7d.png"         $(ain_png 7d)   || true
          copy_first_img "$d_ain/1m.png"         $(ain_png 1m)   || true
          copy_first_img "$d_ain/1y.png"         $(ain_png 1y)   || true
          copy_first_txt "$d_ain/intraday.txt"   $(ain_txt_post) || true
          copy_first_txt "$d_ain/stats.json"     "$b_ain/ain10_stats.json" "$b_ain/ain_10_stats.json" "$b_ain/ain-10_stats.json" || true
          fetch_txt "$b_ain/_last_run.txt" "$d_ain/last_run.txt" || date -u +'%Y-%m-%dT%H:%M:%SZ' > "$d_ain/last_run.txt"

          # ====== S-COIN+ ======
          # intraday は原本 1d のみ（サイト側へは落とさない）
          copy_first_img "$d_scp/intraday.png"   $(scoin_png 1d) || true
          copy_first_img "$d_scp/7d.png"         $(scoin_png 7d) || true
          copy_first_img "$d_scp/1m.png"         $(scoin_png 1m) || true
          copy_first_img "$d_scp/1y.png"         $(scoin_png 1y) || true
          copy_first_txt "$d_scp/intraday.txt"   $(scoin_txt_post) || true
          copy_first_txt "$d_scp/stats.json"     "$b_scp/scoin_plus_stats.json" "$b_scp/s_coin_plus_stats.json" "$b_scp/s-coin_plus_stats.json" "$b_scp/s_coin__stats.json" || true
          fetch_txt "$b_scp/_last_run.txt" "$d_scp/last_run.txt" || date -u +'%Y-%m-%dT%H:%M:%SZ' > "$d_scp/last_run.txt"

          # ====== cleanup (古いパスの残骸を掃除・あっても無視) ======
          git rm -f docs/charts/ain10_*.png docs/charts/*_history.csv docs/charts/*_intraday.png 2>/dev/null || true

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/charts/**/*
          if git diff --cached --quiet; then
            echo "No changes detected."
            exit 0
          fi
          git commit -m "chore(site): robust sync charts (validate image type/size, origin-first intraday, safe text sync, preserve last good)"
          # 安全にrebaseして競合最小化
          git pull --rebase origin main || true
          git push --force-with-lease origin HEAD:main || echo "Push skipped or failed"
